<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Estoque por Localidade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Biblioteca para manipulação de arquivos Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- Adicionado dependências do Toastify.js -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-backdrop, #sidebar-overlay { background-color: rgba(0, 0, 0, 0.5); }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f3f4f6; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        @media print {
            body * { visibility: hidden !important; }
            #print-area, #print-area * { visibility: visible !important; }
            #print-area { position: absolute !important; left: 0 !important; top: 0 !important; width: 100% !important; }
            @page { size: A4; margin: 20mm; }
        }
        tr.low-stock-warning { background-color: #fef9c3 !important; }
        tr.low-stock-warning:hover { background-color: #fef08a !important; }
        #advanced-filters-wrapper { display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.4s ease-in-out; }
        #advanced-filters-wrapper.open { grid-template-rows: 1fr; }
        #advanced-filters-content { overflow: hidden; }
        .bulk-action-bar { transition: all 0.3s ease-in-out; max-height: 0; overflow: hidden; }
        .bulk-action-bar.open { max-height: 500px; }
        #toggle-advanced-filters i { transition: transform 0.3s ease-in-out; }
        #toggle-advanced-filters.open i { transform: rotate(180deg); }
        [data-role-required] { display: none; }
        /* Ajuste para o table-loading-indicator */
        #stock-table-wrapper { position: relative; } /* Novo wrapper para a tabela de estoque */
        #table-loading-indicator {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.85); /* Aumentar opacidade para melhor visualização */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 0.75rem; /* Opcional, se a tabela tiver bordas arredondadas */
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-900 min-h-screen">

    <!-- Seção de Autenticação -->
    <div id="auth-section" class="fixed inset-0 z-[100] hidden items-center justify-center p-4 bg-gray-100">
        <div id="auth-container" class="w-full max-w-md">
            <!-- Formulário de Login -->
            <div id="login-form-container">
                <div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-200 text-center">
                    <i class="fas fa-boxes-stacked fa-2x text-blue-500 mb-4"></i>
                    <h2 class="text-2xl font-bold text-gray-800 mb-1">Bem-vindo de volta!</h2>
                    <p class="text-gray-500 mb-6">Faça login para acessar o estoque.</p>
                    <form id="login-form" class="space-y-4">
                        <input type="email" id="login-email" placeholder="Email" class="w-full p-3 bg-gray-100 rounded-lg text-gray-900" required>
                        <input type="password" id="login-password" placeholder="Senha" class="w-full p-3 bg-gray-100 rounded-lg text-gray-900" required>
                        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">Entrar</button>
                    </form>
                    <p class="mt-6 text-sm">Não tem uma conta? <a href="#" id="show-register-link" class="font-semibold text-blue-600 hover:underline">Registre-se</a></p>
                </div>
            </div>
            <!-- Formulário de Registro -->
            <div id="register-form-container" class="hidden">
                <div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-200 text-center">
                    <i class="fas fa-user-plus fa-2x text-blue-500 mb-4"></i>
                    <h2 class="text-2xl font-bold text-gray-800 mb-1">Crie sua Conta</h2>
                    <p class="text-gray-500 mb-6">O registro cria uma conta com permissão de 'Visualizador'.</p>
                    <form id="register-form" class="space-y-4">
                        <input type="email" id="register-email" placeholder="Email" class="w-full p-3 bg-gray-100 rounded-lg text-gray-900" required>
                        <input type="password" id="register-password" placeholder="Senha (mínimo 6 caracteres)" class="w-full p-3 bg-gray-100 rounded-lg text-gray-900" required>
                        <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition">Registrar</button>
                    </form>
                    <p class="mt-6 text-sm">Já tem uma conta? <a href="#" id="show-login-link" class="font-semibold text-blue-600 hover:underline">Faça Login</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar Menu -->
    <div id="sidebar-menu" class="fixed top-0 left-0 h-full w-64 bg-white shadow-lg z-50 transform -translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
        <div class="flex-grow">
            <div class="p-4 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-900">Menu</h2>
            </div>
            <nav id="sidebar-nav" class="p-4 space-y-2">
                <a href="#" data-tab="reports" class="sidebar-link flex items-center p-3 rounded-lg hover:bg-gray-200 text-gray-700">
                    <i class="fas fa-chart-pie w-6 mr-3"></i>Dashboard
                </a>
                <a href="#" data-tab="stock" class="sidebar-link flex items-center p-3 rounded-lg hover:bg-gray-200 text-gray-700">
                    <i class="fas fa-warehouse w-6 mr-3"></i>Estoque
                </a>
                <a href="#" data-tab="register" data-role-required="admin" class="sidebar-link flex items-center p-3 rounded-lg hover:bg-gray-200 text-gray-700">
                    <i class="fas fa-plus-circle w-6 mr-3"></i>Cadastros
                </a>
                <a href="#" data-tab="outputs" data-role-required="admin" class="sidebar-link flex items-center p-3 rounded-lg hover:bg-gray-200 text-gray-700">
                    <i class="fas fa-arrow-circle-up w-6 mr-3"></i>Saídas
                </a>
            </nav>
        </div>
        <div class="p-4 border-t border-gray-200">
             <a href="#" data-tab="settings" data-role-required="admin" class="sidebar-link flex items-center p-3 rounded-lg hover:bg-gray-200 text-gray-700">
                <i class="fas fa-cog w-6 mr-3"></i>Configurações
            </a>
            <a href="#" id="logout-btn" class="flex items-center p-3 rounded-lg hover:bg-red-100 text-red-600 font-semibold">
                <i class="fas fa-sign-out-alt w-6 mr-3"></i>Sair
            </a>
        </div>
    </div>
    <div id="sidebar-overlay" class="fixed inset-0 z-40 hidden"></div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-stone-900 bg-opacity-75 flex items-center justify-center z-[60]">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
    </div>

    <!-- Main App Section -->
    <div id="app-section" class="hidden">
        <div class="container mx-auto p-4 md:p-8 max-w-7xl">
            <header class="mb-8 text-center relative">
                <button id="menu-toggle-btn" class="absolute left-0 top-1/2 -translate-y-1/2 p-2 rounded-md hover:bg-gray-200 text-gray-600">
                    <i class="fas fa-bars fa-lg"></i>
                </button>
                <h1 class="text-4xl md:text-5xl font-bold text-gray-900"><i class="fas fa-boxes-stacked mr-3 text-blue-500"></i>Estoque HCM</h1>
                <p id="user-welcome-message" class="text-gray-500 mt-2">Controle de Estoque da Adega.</p>
            </header>
            
            <main id="tab-content">
                <div id="panel-reports" class="tab-panel"></div>
                <div id="panel-stock" class="tab-panel hidden"></div>
                <div id="panel-register" class="tab-panel hidden"></div>
                <div id="panel-outputs" class="tab-panel hidden"></div>
                <div id="panel-settings" class="tab-panel hidden"></div>
            </main>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="edit-modal" class="fixed inset-0 modal-backdrop items-center justify-center z-50 hidden"><div class="bg-white w-full max-w-lg p-6 rounded-2xl shadow-2xl m-4"><h3 class="text-xl font-semibold mb-4 text-gray-900">Editar Produto</h3><p id="edit-product-name" class="mb-4 text-gray-600"></p><div id="edit-quantities-container" class="space-y-4"></div><div class="mt-6 flex justify-end space-x-4"><button id="cancel-edit" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Cancelar</button><button id="save-edit" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition">Salvar</button></div></div></div>
    <div id="delete-modal" class="fixed inset-0 modal-backdrop items-center justify-center z-50 hidden"><div class="bg-white w-full max-w-md p-6 rounded-2xl shadow-2xl m-4 text-center"><i class="fas fa-triangle-exclamation fa-3x text-red-500 mb-4"></i><h3 class="text-xl font-semibold mb-2 text-gray-900">Confirmar Exclusão</h3><p id="delete-modal-text" class="mb-6 text-gray-600"></p><div class="flex justify-center space-x-4"><button id="cancel-delete" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Cancelar</button><button id="confirm-delete" class="px-6 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition">Excluir</button></div></div></div>

    <!-- Firebase SDK e Script da Aplicação -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, writeBatch, runTransaction, serverTimestamp, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const debounce = (func, delay) => {
            let timeoutId;
            return function(...args) {
                const context = this;
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(context, args), delay);
            };
        };
        
        const hardcodedFirebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : hardcodedFirebaseConfig;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-stock-app';

        class StockApp {
            app;
            auth;
            db;
            state = {
                products: [], categories: [], locations: [], movements: [], allUsers: [],
                selectedProducts: [],
                currentPage: 1, itemsPerPage: 10,
                firestoreRefs: null, dom: null, chartInstance: null,
                deleteQueue: { id: null, type: null, isBulk: false },
                isAuthReady: false,
                currentUser: null, userRole: null,
                activeTab: 'reports', 
                dashboardSettings: { chartType: 'bar', period: '7days', startDate: null, endDate: null },
                unsubscribers: [],
            };

            constructor() {
                // VERIFICAÇÃO ROBUSTA: Garante que o app não inicialize com credenciais de placeholder.
                if (!firebaseConfig || firebaseConfig.apiKey === "YOUR_API_KEY" || !firebaseConfig.apiKey) {
                    console.error("Firebase config is not provided or uses placeholder values.");
                    document.addEventListener('DOMContentLoaded', () => {
                        document.body.innerHTML = `<div class="w-full h-screen flex items-center justify-center p-4"><div class="text-center bg-red-100 p-8 rounded-lg shadow-md"><h1 class="text-2xl font-bold text-red-800 mb-2">Erro de Configuração do Firebase</h1><p class="text-red-700">As credenciais do Firebase não foram fornecidas ou são inválidas. A aplicação não pode ser iniciada.</p></div></div>`;
                        const loader = document.getElementById('loading-overlay');
                        if (loader) loader.style.display = 'none';
                    });
                    return;
                }

                try {
                    this.app = initializeApp(firebaseConfig);
                    this.auth = getAuth(this.app);
                    this.db = getFirestore(this.app);
                } catch (error) {
                    console.error("Error initializing Firebase:", error);
                     document.addEventListener('DOMContentLoaded', () => {
                        document.body.innerHTML = `<div class="w-full h-screen flex items-center justify-center p-4"><div class="text-center bg-red-100 p-8 rounded-lg shadow-md"><h1 class="text-2xl font-bold text-red-800 mb-2">Erro de Inicialização do Firebase</h1><p class="text-red-700">Não foi possível conectar ao Firebase. Verifique as credenciais e a configuração de rede. Detalhes no console.</p></div></div>`;
                    });
                    return;
                }
                
                this.debouncedRenderProducts = debounce(this.renderProducts.bind(this), 300);
                document.addEventListener('DOMContentLoaded', this.init.bind(this));
            }

            init() {
                this.cacheDomElements(); 
                this.injectAllPanelsContent(); 
                this.setupEventListeners();
                this.handleAuthentication();
            }
            
            cacheDomElements() {
                this.state.dom = {
                    loadingOverlay: document.getElementById('loading-overlay'),
                    appSection: document.getElementById('app-section'),
                    authSection: document.getElementById('auth-section'),
                    authContainer: document.getElementById('auth-container'),
                    loginFormContainer: document.getElementById('login-form-container'),
                    registerFormContainer: document.getElementById('register-form-container'),
                    contentEl: document.getElementById('tab-content'),
                    panels: { 
                        reports: document.getElementById('panel-reports'), 
                        stock: document.getElementById('panel-stock'), 
                        register: document.getElementById('panel-register'), 
                        outputs: document.getElementById('panel-outputs'), 
                        settings: document.getElementById('panel-settings') 
                    },
                    sidebar: { menu: document.getElementById('sidebar-menu'), nav: document.getElementById('sidebar-nav'), overlay: document.getElementById('sidebar-overlay'), toggleBtn: document.getElementById('menu-toggle-btn'), logoutBtn: document.getElementById('logout-btn') },
                    modals: {
                        edit: { self: document.getElementById('edit-modal'), productName: document.getElementById('edit-product-name'), quantitiesContainer: document.getElementById('edit-quantities-container'), saveBtn: document.getElementById('save-edit'), cancelBtn: document.getElementById('cancel-edit') },
                        delete: { self: document.getElementById('delete-modal'), text: document.getElementById('delete-modal-text'), confirmBtn: document.getElementById('confirm-delete'), cancelBtn: document.getElementById('cancel-delete') },
                    },
                };
            }
            
            setupEventListeners() {
                const { dom } = this.state;
                if (!dom) return;

                document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); this.handleLogin(e.target); });
                document.getElementById('register-form').addEventListener('submit', (e) => { e.preventDefault(); this.handleRegister(e.target); });
                document.getElementById('show-register-link').addEventListener('click', (e) => { e.preventDefault(); this.toggleAuthForm(true); });
                document.getElementById('show-login-link').addEventListener('click', (e) => { e.preventDefault(); this.toggleAuthForm(false); });
                dom.sidebar.logoutBtn.addEventListener('click', (e) => { e.preventDefault(); this.handleLogout(); });
                dom.modals.edit.cancelBtn.addEventListener('click', () => this.closeEditModal());
                dom.modals.edit.saveBtn.addEventListener('click', () => this.handleSaveEdit());
                dom.modals.delete.cancelBtn.addEventListener('click', () => this.closeDeleteModal());
                dom.modals.delete.confirmBtn.addEventListener('click', () => this.handleDelete());
                dom.sidebar.toggleBtn.addEventListener('click', () => this.toggleSidebar(true));
                dom.sidebar.overlay.addEventListener('click', () => this.toggleSidebar(false));
                dom.sidebar.menu.addEventListener('click', (e) => {
                    const link = e.target.closest('.sidebar-link');
                    if (link && link.dataset.tab) {
                        e.preventDefault();
                        this.switchTab(link.dataset.tab);
                        this.toggleSidebar(false);
                    }
                });
                dom.contentEl.addEventListener('submit', (e) => this.handleFormSubmit(e));
                dom.contentEl.addEventListener('click', (e) => this.handleContentClick(e));
                dom.contentEl.addEventListener('change', (e) => this.handleContentChange(e));
                dom.contentEl.addEventListener('input', (e) => this.handleContentInput(e));
            }

            handleAuthentication() {
                onAuthStateChanged(this.auth, async (user) => {
                    this.setLoading(true);
                    if (user) {
                        this.state.currentUser = user;
                        const userDocRef = doc(this.db, 'users', user.uid);
                        const userDoc = await getDoc(userDocRef);
                        this.state.userRole = userDoc.exists() ? userDoc.data().role : 'viewer';
                        this.state.isAuthReady = true;
                        await this.initializeAppForUser();
                        this.showAppUI();
                        this.switchTab(this.state.activeTab || 'reports');
                    } else {
                        this.state.currentUser = null;
                        this.state.userRole = null;
                        this.state.isAuthReady = false;
                        this.state.allUsers = [];
                        this.clearAllListeners();
                        this.showAuthUI();
                    }
                    this.setLoading(false);
                });
            }

            async handleLogin(form) {
                const email = form.querySelector('#login-email').value;
                const password = form.querySelector('#login-password').value;
                this.setLoading(true);
                try {
                    await signInWithEmailAndPassword(this.auth, email, password);
                } catch (error) {
                    this.showAlert(this.getFriendlyAuthError(error.code), true);
                    this.setLoading(false);
                }
            }

            async handleRegister(form) {
                const email = form.querySelector('#register-email').value;
                const password = form.querySelector('#register-password').value;
                this.setLoading(true);
                try {
                    const userCredential = await createUserWithEmailAndPassword(this.auth, email, password);
                    await setDoc(doc(this.db, "users", userCredential.user.uid), {
                        email: userCredential.user.email,
                        role: "viewer",
                        createdAt: serverTimestamp()
                    });
                } catch (error) {
                    this.showAlert(this.getFriendlyAuthError(error.code), true);
                    this.setLoading(false);
                }
            }

            async handleLogout() {
                this.setLoading(true);
                await signOut(this.auth);
            }
            
            toggleAuthForm(showRegister) {
                this.state.dom.loginFormContainer.classList.toggle('hidden', showRegister);
                this.state.dom.registerFormContainer.classList.toggle('hidden', !showRegister);
            }
            
            showAppUI() {
                this.state.dom.authSection.classList.add('hidden');
                this.state.dom.authSection.classList.remove('flex');
                this.state.dom.appSection.classList.remove('hidden');
            }

            showAuthUI() {
                this.state.dom.authSection.classList.remove('hidden');
                this.state.dom.authSection.classList.add('flex');
                this.state.dom.appSection.classList.add('hidden');
                this.state = {
                    ...this.state, products: [], categories: [], locations: [],
                    movements: [], selectedProducts: [], currentPage: 1, allUsers: [], activeTab: 'reports'
                };
            }
            
            applyRolePermissions() {
                const { userRole, dom } = this.state;
                const welcomeEl = document.getElementById('user-welcome-message'); 
                if (welcomeEl) {
                    welcomeEl.textContent = `Bem-vindo! Você está logado como ${userRole === 'admin' ? 'Administrador' : 'Visualizador'}.`;
                }
                
                document.querySelectorAll('[data-role-required]').forEach(el => {
                    const requiredRole = el.getAttribute('data-role-required');
                    const isFlex = (el.tagName === 'BUTTON' || el.tagName === 'A' || (el.tagName === 'DIV' && el.classList.contains('flex')));
                    const displayStyle = isFlex ? 'flex' : 'block';
                    el.style.display = userRole === requiredRole ? displayStyle : 'none';
                });

                const activeTabLink = dom.sidebar.nav.querySelector(`.sidebar-link[data-tab="${this.state.activeTab}"]`);
                if (userRole === 'viewer' && activeTabLink?.getAttribute('data-role-required') === 'admin') {
                   this.switchTab('reports'); 
                }
            }

            getFriendlyAuthError(code) {
                switch (code) {
                    case 'auth/user-not-found': return 'Nenhum usuário encontrado com este e-mail.';
                    case 'auth/wrong-password': return 'Senha incorreta. Tente novamente.';
                    case 'auth/invalid-email': return 'O formato do e-mail é inválido.';
                    case 'auth/weak-password': return 'A senha deve ter pelo menos 6 caracteres.';
                    case 'auth/email-already-in-use': return 'Este e-mail já está cadastrado.';
                    case 'auth/invalid-credential': return 'Credenciais inválidas. Verifique e-mail e senha.';
                    default: return `Ocorreu um erro: ${code}`;
                }
            }

            async initializeAppForUser() {
                const basePath = `artifacts/${appId}/public/data`;
                this.state.firestoreRefs = {
                    products: collection(this.db, `${basePath}/products`),
                    categories: collection(this.db, `${basePath}/categories`),
                    movements: collection(this.db, `${basePath}/movements`),
                    locations: collection(this.db, `${basePath}/locations`),
                    settings: doc(this.db, `${basePath}/settings/main`),
                    users: collection(this.db, `users`),
                };
                
                this.clearAllListeners();
                this.state.unsubscribers.push(this.listenForSettingsUpdates());
                this.state.unsubscribers.push(this.listenForLocationUpdates());
                this.state.unsubscribers.push(this.listenForCategoryUpdates());
                this.state.unsubscribers.push(this.listenForProductUpdates());
                this.state.unsubscribers.push(this.listenForMovements());
                if (this.state.userRole === 'admin') {
                    this.state.unsubscribers.push(this.listenForUserUpdates());
                }
                
                this.updateAllViews();
            }

            clearAllListeners() {
                this.state.unsubscribers.forEach(unsub => unsub());
                this.state.unsubscribers = [];
            }
            
            async handleFormSubmit(e) {
                e.preventDefault();
                if (this.state.userRole !== 'admin') {
                    return this.showAlert('Você não tem permissão para realizar esta ação.', true);
                }
                const form = e.target;
                this.setLoading(true);
                try {
                    if (form.id === 'add-category-form') await this.handleAddCategory(form);
                    if (form.id === 'add-product-form') await this.handleAddProduct(form);
                    if (form.id === 'add-output-form') await this.handleAddOutput(form);
                    if (form.id === 'add-location-form') await this.handleAddLocation(form);
                } catch (error) {
                    this.showAlert(error.message, true);
                } finally {
                    this.setLoading(false);
                }
            }
            
            handleContentClick(e) {
                const button = e.target.closest('button');
                if (!button) return;

                if (button.classList.contains('chart-type-btn')) {
                    this.state.dashboardSettings.chartType = button.dataset.type;
                    this.updateDashboardView();
                    return;
                }
                 if (button.classList.contains('save-user-role-btn')) {
                    const userId = button.dataset.userId;
                    const selectEl = document.getElementById(`role-select-${userId}`);
                    if (userId && selectEl) {
                        this.handleChangeUserRole(userId, selectEl.value);
                    }
                    return;
                }

                const { action, id } = button.dataset;
                const isAdmin = this.state.userRole === 'admin';

                if ((action?.startsWith('delete') || action === 'edit' || button.id === 'bulk-delete-btn') && !isAdmin) {
                    return this.showAlert('Você não tem permissão para realizar esta ação.', true);
                }

                if (action === 'delete-category' && id) this.openDeleteModal(id, 'category');
                if (action === 'delete-location' && id) this.openDeleteModal(id, 'location');
                if (action === 'edit' && id) this.openEditModal(id);
                if (action === 'delete' && id) this.openDeleteModal(id, 'product');
                if (button.id === 'bulk-delete-btn') this.openDeleteModal(null, 'product', true);
                
                if (action === 'page-prev') { this.state.currentPage--; this.renderProducts(); }
                if (action === 'page-next') { this.state.currentPage++; this.renderProducts(); }
                if (button.id === 'toggle-advanced-filters') {
                    document.getElementById('advanced-filters-wrapper').classList.toggle('open');
                    button.classList.toggle('open');
                }
                if (button.id === 'clear-filters-btn') this.clearFilters();
                if (button.id === 'generate-report-btn') this.handleGenerateReport();
                if (button.id === 'print-report-btn') window.print();
                
                if (isAdmin) {
                    if (button.id === 'download-template-btn') this.handleDownloadTemplate();
                    if (button.id === 'upload-insert-trigger-btn') document.getElementById('excel-insert-input').click();
                    if (button.id === 'export-pdf-btn') this.handleExportPdf();
                    if (button.id === 'save-settings-btn') this.handleSaveSettings();
                }
            }
            
            async handleSaveEdit() {
                if (this.state.userRole !== 'admin') return this.showAlert('Você não tem permissão para salvar edições.', true);
                const { self, quantitiesContainer } = this.state.dom.modals.edit;
                const id = self.dataset.productId;
                if (!id) return;
                const oldProduct = this.state.products.find(p => p.id === id);
                if (!oldProduct) return this.showAlert('Produto não encontrado.', true);
                const newQuantities = {};
                let newTotalQuantity = 0;
                this.state.locations.forEach(loc => {
                    const qty = parseInt(quantitiesContainer.querySelector(`#edit-qty-${loc.id}`).value, 10) || 0;
                    newQuantities[loc.id] = qty;
                    newTotalQuantity += qty;
                });
                try {
                    await updateDoc(doc(this.state.firestoreRefs.products, id), {
                        quantities: newQuantities,
                        totalQuantity: newTotalQuantity
                    });
                    const quantityDiff = newTotalQuantity - oldProduct.totalQuantity;
                    if (quantityDiff !== 0) {
                        await this.logMovement(id, quantityDiff > 0 ? 'entrada' : 'saida', Math.abs(quantityDiff), 'Ajuste via Edição');
                    }
                    this.showAlert('Produto atualizado.');
                    this.closeEditModal();
                } catch (error) {
                    this.showAlert(`Não foi possível salvar: ${error.message}`, true);
                }
            }

            async handleDelete() {
                if (this.state.userRole !== 'admin') return this.showAlert('Você não tem permissão para excluir.', true);
                const { id, type, isBulk } = this.state.deleteQueue;
                if (!type) return;
                this.setLoading(true);
                try {
                    if (isBulk) {
                        const batch = writeBatch(this.db);
                        this.state.selectedProducts.forEach(productId => {
                            batch.delete(doc(this.state.firestoreRefs.products, productId));
                        });
                        await batch.commit();
                        this.showAlert(`${this.state.selectedProducts.length} produtos excluídos.`);
                        this.state.selectedProducts = [];
                        this.updateSelectionState(); 
                    } else if (id) {
                        if (type === 'product') {
                            await deleteDoc(doc(this.state.firestoreRefs.products, id));
                            this.showAlert('Produto excluído.');
                        } else if (type === 'category') {
                            if (this.state.products.some(p => p.category === id)) throw new Error(`Existem produtos nesta categoria. Não é possível excluí-la.`);
                            await deleteDoc(doc(this.state.firestoreRefs.categories, id));
                            this.showAlert('Categoria excluída.');
                        } else if (type === 'location') {
                            if (this.state.products.some(p => p.quantities[id] && p.quantities[id] > 0)) {
                                throw new Error('Esta localidade está em uso por produtos com estoque e não pode ser excluída.');
                            }
                            await deleteDoc(doc(this.state.firestoreRefs.locations, id));
                            this.showAlert('Localidade excluída.');
                        }
                    }
                } catch (error) {
                    this.showAlert(error.message, true);
                } finally {
                    this.closeDeleteModal();
                    this.setLoading(false);
                }
            }
            
            listenForLocationUpdates() {
                 if (!this.state.firestoreRefs) return () => {};
                const createDefaultLocations = async () => {
                    const defaultLocations = [
                        { id: 'estoque_seco', name: 'Estoque Seco' }, { id: 'extensao', name: 'Extensão' },
                        { id: 'freezer', name: 'Freezer' }, { id: 'adega_1', name: 'Adega 1' },
                        { id: 'adega_2', name: 'Adega 2' }, { id: 'adega_grande', name: 'Adega Grande' },
                    ];
                    const batch = writeBatch(this.db);
                    defaultLocations.forEach(loc => {
                        batch.set(doc(this.state.firestoreRefs.locations, loc.id), { name: loc.name });
                    });
                    await batch.commit();
                };
                return onSnapshot(query(this.state.firestoreRefs.locations), async (snapshot) => {
                    if (this.state.userRole === 'admin' && snapshot.empty) {
                        await createDefaultLocations();
                        return;
                    }
                    this.state.locations = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() })).sort((a,b) => a.name.localeCompare(b.name));
                    this.updateAllViews();
                }, (error) => {
                    console.error("Erro ao ouvir atualizações de localidades:", error);
                    this.showAlert("Erro ao carregar localidades.", true);
                });
            }

            listenForSettingsUpdates() {
                if (!this.state.firestoreRefs) return () => {};
                return onSnapshot(this.state.firestoreRefs.settings, async (docSnap) => {
                    if (docSnap.exists()) {
                        this.state.itemsPerPage = docSnap.data().itemsPerPage || 10;
                    } else if (this.state.userRole === 'admin') {
                        await setDoc(this.state.firestoreRefs.settings, { itemsPerPage: 10 });
                        this.state.itemsPerPage = 10;
                    }
                     if (this.state.activeTab === 'settings') this.renderSettings();
                     if (this.state.activeTab === 'stock') this.renderProducts();

                }, (error) => {
                    console.error("Erro ao ouvir atualizações de configurações:", error);
                });
            }

            listenForProductUpdates() {
                if (!this.state.firestoreRefs) return () => {};
                return onSnapshot(query(this.state.firestoreRefs.products), (snapshot) => {
                    this.state.products = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
                    this.updateAllViews(); 
                }, (error) => {
                    console.error("Erro ao ouvir atualizações de produtos:", error);
                    this.showAlert("Erro ao carregar produtos.", true);
                });
            }

            listenForCategoryUpdates() {
                if (!this.state.firestoreRefs) return () => {};
                return onSnapshot(query(this.state.firestoreRefs.categories), (snapshot) => {
                    this.state.categories = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() })).sort((a, b) => a.name.localeCompare(b.name));
                    this.updateAllViews(); 
                }, (error) => {
                    console.error("Erro ao ouvir atualizações de categorias:", error);
                    this.showAlert("Erro ao carregar categorias.", true);
                });
            }
            
            listenForMovements() {
                if (!this.state.firestoreRefs) return () => {};
                return onSnapshot(query(this.state.firestoreRefs.movements), (snapshot) => {
                    this.state.movements = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
                    if (this.state.activeTab === 'reports') {
                        this.updateDashboardView();
                        this.renderLowStockAlerts();
                        this.renderTopMovements();
                    }
                }, (error) => {
                    console.error("Erro ao ouvir atualizações de movimentações:", error);
                });
            }

            listenForUserUpdates() {
                if (!this.state.firestoreRefs || this.state.userRole !== 'admin') return () => {};
                return onSnapshot(query(this.state.firestoreRefs.users), (snapshot) => {
                    this.state.allUsers = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
                    if (this.state.activeTab === 'settings' && this.state.userRole === 'admin') {
                        this.renderUserManagement();
                    }
                }, (error) => {
                    console.error("Erro ao ouvir atualizações de usuários:", error);
                    this.showAlert("Erro ao carregar lista de usuários.", true);
                });
            }

            setLoading(isLoading, isTableOnly = false) {
                const tableLoader = document.getElementById('table-loading-indicator'); 
                if (isTableOnly && tableLoader) {
                    tableLoader.style.display = isLoading ? 'flex' : 'none';
                } else if (this.state.dom && this.state.dom.loadingOverlay) {
                    this.state.dom.loadingOverlay.style.display = isLoading ? 'flex' : 'none';
                }
            }
            
            handleSelectAllChange(e) {
                const isChecked = e.target.checked;
                const visibleCheckboxes = document.querySelectorAll('#product-list .product-checkbox');
                
                visibleCheckboxes.forEach(checkbox => {
                    checkbox.checked = isChecked;
                });
                this.updateSelectionState();
            }

            handleSingleCheckboxChange() {
                this.updateSelectionState();
            }

            updateSelectionState() {
                this.state.selectedProducts = Array.from(document.querySelectorAll('#product-list .product-checkbox:checked')).map(cb => cb.dataset.id);
                document.querySelectorAll('#product-list tr[data-product-id]').forEach(row => {
                    const id = row.dataset.productId;
                    row.classList.toggle('bg-blue-100', this.state.selectedProducts.includes(id));
                });
                
                const allVisibleCheckboxes = document.querySelectorAll('#product-list .product-checkbox');
                const selectAllCheckbox = document.getElementById('select-all-checkbox');
                if (selectAllCheckbox) {
                    const allVisibleSelected = allVisibleCheckboxes.length > 0 && Array.from(allVisibleCheckboxes).every(cb => cb.checked);
                    selectAllCheckbox.checked = allVisibleSelected;
                }
                this.renderBulkActionBar();
            }
        }

        Object.assign(StockApp.prototype, {
            async handleAddCategory(form) {
                const name = form.querySelector('#category-name').value.trim();
                if (name && this.state.firestoreRefs) {
                    await addDoc(this.state.firestoreRefs.categories, { name });
                    form.reset();
                    this.showAlert('Categoria adicionada!');
                } else {
                    throw new Error("Nome da categoria inválido.");
                }
            },
            async handleAddLocation(form) {
                const name = form.querySelector('#location-name').value.trim();
                if (name && this.state.firestoreRefs) {
                    const id = name.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '');
                    if (this.state.locations.some(loc => loc.id === id)) {
                        throw new Error("Uma localidade com nome similar já existe.");
                    }
                    await setDoc(doc(this.state.firestoreRefs.locations, id), { name });
                    form.reset();
                    this.showAlert('Localidade adicionada!');
                } else {
                    throw new Error("Nome da localidade inválido.");
                }
            },
            async handleAddProduct(form) {
                const quantities = {};
                let totalQuantity = 0;
                this.state.locations.forEach(loc => {
                    const input = form.querySelector(`#qty-${loc.id}`);
                    if (input) {
                        const qty = parseInt(input.value, 10) || 0;
                        quantities[loc.id] = qty;
                        totalQuantity += qty;
                    }
                });
                const productData = {
                    name: form.querySelector('#product-name').value.trim(),
                    category: form.querySelector('#product-category-select').value,
                    minStock: parseInt(form.querySelector('#product-min-stock').value, 10) || 0,
                    unit: form.querySelector('#product-unit-select').value,
                    quantities,
                    totalQuantity,
                    createdAt: serverTimestamp()
                };
                if (productData.name && productData.category && productData.unit) {
                    const newProdRef = await addDoc(this.state.firestoreRefs.products, productData);
                    if (totalQuantity > 0) {
                        await this.logMovement(newProdRef.id, 'entrada', totalQuantity, 'Criação de Produto');
                    }
                    form.reset();
                    this.showAlert('Produto adicionado!');
                } else {
                    throw new Error("Dados do produto inválidos. Verifique nome, categoria e unidade.");
                }
            },
            async handleAddOutput(form) {
                const productId = form.querySelector('#output-product-select').value;
                const quantity = parseInt(form.querySelector('#output-quantity').value, 10);
                const motive = form.querySelector('#output-motive-select').value;
                const locationId = form.querySelector('input[name="output-location"]:checked')?.value;
                if (!productId || isNaN(quantity) || quantity <= 0 || !motive || !locationId) {
                    throw new Error("Preencha todos os campos, incluindo a localidade.");
                }
                await runTransaction(this.db, async (transaction) => {
                    const productRef = doc(this.state.firestoreRefs.products, productId);
                    const productDoc = await transaction.get(productRef);
                    if (!productDoc.exists()) throw new Error("Produto não encontrado.");
                    const productData = productDoc.data();
                    const currentQuantityInLocation = productData.quantities[locationId] || 0;
                    if (currentQuantityInLocation < quantity) throw new Error(`Estoque insuficiente em ${this.state.locations.find(l => l.id === locationId)?.name}.`);
                    const newQuantities = { ...productData.quantities, [locationId]: currentQuantityInLocation - quantity };
                    const newTotalQuantity = Object.values(newQuantities).reduce((sum, qty) => sum + qty, 0);
                    transaction.update(productRef, { quantities: newQuantities, totalQuantity: newTotalQuantity });
                    const movementRef = doc(collection(this.db, this.state.firestoreRefs.movements.path));
                    transaction.set(movementRef, { productId, type: 'saida', quantity, motive, location: locationId, date: serverTimestamp() });
                });
                this.showAlert('Saída registrada com sucesso.');
                form.reset();
                document.getElementById('output-stock-info').textContent = '';
                document.getElementById('output-location-selector').innerHTML = '';
            },
            async logMovement(productId, type, quantity, motive) {
                if (!this.state.firestoreRefs) return;
                await addDoc(this.state.firestoreRefs.movements, { productId, type, quantity, motive, date: serverTimestamp() });
            },
            renderProducts() {
                const productList = document.getElementById('product-list');
                const emptyState = document.getElementById('empty-state');
                const tableLoadingIndicator = document.getElementById('table-loading-indicator'); 

                if (!productList || !emptyState ) { 
                     console.warn('Elementos da tabela de estoque não encontrados, renderização abortada.');
                    return;
                }
                
                this.setLoading(true, true); 

                const filteredProducts = this.getFilteredProducts();
                const paginatedProducts = filteredProducts.slice((this.state.currentPage - 1) * this.state.itemsPerPage, this.state.currentPage * this.state.itemsPerPage);
                
                if (filteredProducts.length === 0) {
                    emptyState.classList.remove('hidden');
                    productList.innerHTML = '';
                    const emptyMsgEl = document.getElementById('empty-state-message');
                    if (emptyMsgEl) {
                        emptyMsgEl.textContent = this.state.products.length === 0 ? 'Nenhum produto cadastrado.' : 'Nenhum produto encontrado com os filtros atuais.';
                    }
                } else {
                    emptyState.classList.add('hidden');
                    productList.innerHTML = paginatedProducts.map(product => {
                        const category = this.state.categories.find(c => c.id === product.category);
                        const isLowStock = product.minStock > 0 && product.totalQuantity <= product.minStock;
                        const isSelected = this.state.selectedProducts.includes(product.id);
                        const quantitiesHtml = this.state.locations.map(loc => `<td class="p-3 text-center text-gray-700">${product.quantities?.[loc.id] || 0}</td>`).join('');
                        const actionButtons = this.state.userRole === 'admin' ? `
                            <button data-action="edit" data-id="${product.id}" class="text-blue-500 hover:text-blue-700 p-2"><i class="fas fa-edit"></i></button>
                            <button data-action="delete" data-id="${product.id}" class="text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash"></i></button>
                        ` : '';
                        const checkbox = this.state.userRole === 'admin' ? `<input type="checkbox" class="product-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" data-id="${product.id}" ${isSelected ? 'checked' : ''}>` : '';
                        return `
                            <tr class="hover:bg-gray-200 transition-colors ${isLowStock ? 'low-stock-warning' : ''} ${isSelected ? 'bg-blue-100' : ''}" data-product-id="${product.id}">
                                <td class="p-3 text-center">${checkbox}</td>
                                <td class="p-3 font-medium text-gray-900 sticky left-0 bg-white dark:bg-gray-800">${product.name} ${isLowStock ? '<i class="fas fa-exclamation-triangle text-amber-500 ml-1" title="Estoque baixo!"></i>' : ''}</td>
                                <td class="p-3 text-center text-gray-700">${category?.name || 'N/A'}</td>
                                <td class="p-3 text-center font-bold text-gray-900">${product.totalQuantity || 0}</td>
                                ${quantitiesHtml}
                                <td class="p-3 text-right">${actionButtons}</td>
                            </tr>`;
                    }).join('');
                }
                this.renderPaginationControls(filteredProducts.length);
                this.updateSelectionState(); 
                this.setLoading(false, true); 
            },
            renderCategories() {
                if (this.state.activeTab !== 'register' && this.state.activeTab !== 'stock') return;

                const categoryList = document.getElementById('category-list');
                if (categoryList) { 
                    categoryList.innerHTML = this.state.categories.length > 0 ? this.state.categories.map(cat => {
                        const isUsed = this.state.products.some(p => p.category === cat.id);
                        const deleteButton = this.state.userRole === 'admin' ? `
                            <button data-action="delete-category" data-id="${cat.id}" class="text-red-500 hover:text-red-700 disabled:text-gray-400 disabled:cursor-not-allowed" ${isUsed ? 'disabled title="Categoria em uso"' : ''}>
                                <i class="fas fa-times"></i>
                            </button>
                        ` : '';
                        return `
                            <div class="flex justify-between items-center p-2 bg-gray-100 rounded-lg">
                                <span class="text-gray-900">${cat.name}</span>
                                ${deleteButton}
                            </div>`;
                    }).join('') : '<p class="text-sm text-gray-500">Nenhuma categoria.</p>';
                }
                
                const selects = [document.getElementById('product-category-select'), document.getElementById('stock-category-filter')];
                 selects.forEach(select => {
                    if (!select) return;
                    const currentValue = select.value;
                    let options = select.id === 'stock-category-filter' ? '<option value="all">Todas</option>' : '<option value="">Selecione...</option>';
                    options += this.state.categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
                    select.innerHTML = options;
                    if (Array.from(select.options).some(opt => opt.value === currentValue)) select.value = currentValue;
                });
            },
            renderSettings() { 
                if (this.state.activeTab !== 'settings' || this.state.userRole !== 'admin') return;

                const locationsList = document.getElementById('location-list');
                if (locationsList) {
                    locationsList.innerHTML = this.state.locations.length > 0 ? this.state.locations.map(loc => {
                        const isUsed = this.state.products.some(p => p.quantities && p.quantities[loc.id] > 0);
                         const deleteButton = this.state.userRole === 'admin' ? `
                           <button data-action="delete-location" data-id="${loc.id}" class="text-red-500 hover:text-red-700 disabled:text-gray-400 disabled:cursor-not-allowed" ${isUsed ? 'disabled title="Localidade em uso"' : ''}>
                               <i class="fas fa-times"></i>
                           </button>
                        ` : '';
                        return `
                             <div class="flex justify-between items-center p-2 bg-gray-100 rounded-lg">
                                 <span class="text-gray-900">${loc.name}</span>
                                 ${deleteButton}
                             </div>
                        `;
                    }).join('') : '<p class="text-sm text-gray-500">Nenhuma localidade cadastrada.</p>';
                }
                const itemsPerPageInput = document.getElementById('items-per-page-input');
                if (itemsPerPageInput) {
                    itemsPerPageInput.value = this.state.itemsPerPage;
                }
                this.renderUserManagement();
            },
             renderUserManagement() {
                if (this.state.activeTab !== 'settings' || this.state.userRole !== 'admin') return; 
                const userListTbody = document.getElementById('user-list-tbody');
                if (!userListTbody) return;

                userListTbody.innerHTML = this.state.allUsers.map(user => {
                    const isCurrentUser = this.state.currentUser && this.state.currentUser.uid === user.id;
                    const roleSelectDisabled = isCurrentUser; 

                    return `
                        <tr class="hover:bg-gray-50">
                            <td class="p-3 text-sm text-gray-700">${user.email}</td>
                            <td class="p-3 text-sm text-gray-700">
                                <select id="role-select-${user.id}" class="w-full p-2 bg-gray-100 rounded-lg text-gray-900 border-gray-300 focus:ring-blue-500 focus:border-blue-500" ${roleSelectDisabled ? 'disabled' : ''}>
                                    <option value="viewer" ${user.role === 'viewer' ? 'selected' : ''}>Visualizador</option>
                                    <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Administrador</option>
                                </select>
                            </td>
                            <td class="p-3 text-right">
                                ${!isCurrentUser ? `
                                <button data-user-id="${user.id}" class="save-user-role-btn bg-blue-500 text-white text-xs font-semibold py-1 px-3 rounded-md hover:bg-blue-600 transition">
                                    Salvar
                                </button>` : '<span class="text-xs text-gray-500 italic">Você</span>'}
                            </td>
                        </tr>
                    `;
                }).join('');
            },
            async handleChangeUserRole(userId, newRole) {
                if (this.state.userRole !== 'admin') {
                    return this.showAlert('Apenas administradores podem alterar papéis.', true);
                }
                if (this.state.currentUser && this.state.currentUser.uid === userId) {
                    return this.showAlert('Você não pode alterar seu próprio papel através desta interface.', true);
                }

                this.setLoading(true);
                try {
                    const userRef = doc(this.db, 'users', userId);
                    await updateDoc(userRef, { role: newRole });
                    this.showAlert(`Papel do usuário atualizado para ${newRole}.`);
                } catch (error) {
                    console.error("Erro ao atualizar papel do usuário:", error);
                    this.showAlert('Não foi possível atualizar o papel do usuário.', true);
                } finally {
                    this.setLoading(false);
                }
            },
            updateAllViews() {
                 this.renderCategories(); 
                 this.populateProductSelects(); 

                 if (this.state.activeTab === 'stock') this.debouncedRenderProducts(); 
                 if (this.state.activeTab === 'reports') this.renderDashboard();
                 if (this.state.activeTab === 'settings' && this.state.userRole === 'admin') this.renderSettings();
                 
                 this.applyRolePermissions(); 
            },
            populateProductSelects() {
                if (this.state.activeTab !== 'outputs') return;

                const outputSelect = document.getElementById('output-product-select');
                if (!outputSelect) return;

                const currentValue = outputSelect.value;
                let options = '<option value="">Selecione um produto...</option>';
                const sortedProducts = [...this.state.products].sort((a,b) => a.name.localeCompare(b.name));
                options += sortedProducts.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                outputSelect.innerHTML = options;
                if (Array.from(outputSelect.options).some(opt => opt.value === currentValue)) {
                    outputSelect.value = currentValue;
                } else {
                    outputSelect.value = "";
                }
            },
            showAlert(message, isError = false) {
                Toastify({
                    text: message,
                    duration: 3000,
                    newWindow: true,
                    close: true,
                    gravity: "top",
                    position: "right",
                    stopOnFocus: true,
                    style: {
                        background: isError 
                            ? 'linear-gradient(to right, #ef4444, #dc2626)'
                            : 'linear-gradient(to right, #22c55e, #16a34a)',
                        borderRadius: '8px',
                        fontSize: '14px',
                        padding: '12px 20px'
                    },
                    onClick: function(){}
                }).showToast();
            },
            toggleSidebar(show) {
                const { menu, overlay } = this.state.dom.sidebar;
                menu.classList.toggle('-translate-x-full', !show);
                overlay.classList.toggle('hidden', !show);
            },
            switchTab(tabId) {
                const targetLink = document.querySelector(`.sidebar-link[data-tab="${tabId}"]`);
                if (targetLink && targetLink.dataset.roleRequired && targetLink.dataset.roleRequired !== this.state.userRole) {
                    if (this.state.userRole === 'viewer' && targetLink.dataset.roleRequired === 'admin') {
                        this.showAlert('Você não tem permissão para acessar esta aba.', true);
                        if(this.state.activeTab === tabId) this.state.activeTab = 'reports'; 
                        else return; 
                    }
                }
                
                this.state.activeTab = tabId; 

                document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
                const panelToShow = this.state.dom.panels[tabId];
                if (panelToShow) panelToShow.classList.remove('hidden');
                
                document.querySelectorAll('.sidebar-link').forEach(l => l.classList.toggle('bg-gray-200', l.dataset.tab === tabId));
                
                this.updateAllViews();
            },
            openEditModal(productId) {
                const product = this.state.products.find(p => p.id === productId);
                if (!product) return this.showAlert('Produto não encontrado.', true);
                const { self, productName, quantitiesContainer } = this.state.dom.modals.edit;
                self.dataset.productId = productId;
                productName.textContent = product.name;
                const quantitiesHtml = this.state.locations.map(loc => `
                    <div>
                        <label for="edit-qty-${loc.id}" class="block text-sm font-medium text-gray-700">${loc.name}</label>
                        <input type="number" id="edit-qty-${loc.id}" value="${product.quantities?.[loc.id] || 0}" min="0" class="mt-1 block w-full rounded-md bg-gray-100 border-transparent focus:border-gray-500 focus:bg-white focus:ring-0">
                    </div>
                `).join('');
                quantitiesContainer.innerHTML = `<div class="grid grid-cols-2 gap-4">${quantitiesHtml}</div>`;
                self.classList.replace('hidden', 'flex');
            },
            closeEditModal() { this.state.dom.modals.edit.self.classList.replace('flex', 'hidden'); },
            openDeleteModal(id, type, isBulk = false) {
                this.state.deleteQueue = { id, type, isBulk };
                const { self, text } = this.state.dom.modals.delete;
                if (isBulk) {
                    text.textContent = `Tem certeza que deseja excluir os ${this.state.selectedProducts.length} produtos selecionados? Esta ação não pode ser desfeita.`;
                } else {
                    let itemName = '';
                    if (type === 'product') itemName = this.state.products.find(p => p.id === id)?.name;
                    else if (type === 'category') itemName = this.state.categories.find(c => c.id === id)?.name;
                    else if (type === 'location') itemName = this.state.locations.find(l => l.id === id)?.name;
                    text.textContent = `Tem certeza que deseja excluir "${itemName || ''}"? Esta ação não pode ser desfeita.`;
                }
                self.classList.replace('hidden', 'flex');
            },
            closeDeleteModal() {
                this.state.dom.modals.delete.self.classList.replace('flex', 'hidden');
                this.state.deleteQueue = { id: null, type: null, isBulk: false };
            },
            renderDashboard() {
                if (this.state.activeTab !== 'reports' || !this.state.isAuthReady || !document.getElementById('panel-reports')?.isConnected) return;
                this.updateDashboardView();
                this.renderLowStockAlerts();
                this.renderTopMovements();
            },
            updateDashboardView() {
                if(this.state.activeTab !== 'reports' || !this.state.isAuthReady) return;
                const { chartType } = this.state.dashboardSettings;
                document.querySelectorAll('.chart-type-btn').forEach(btn => {
                    btn.classList.toggle('bg-blue-500', btn.dataset.type === chartType);
                    btn.classList.toggle('text-white', btn.dataset.type === chartType);
                    btn.classList.toggle('bg-white', btn.dataset.type !== chartType);
                    btn.classList.toggle('text-gray-700', btn.dataset.type !== chartType);
                });
                this.renderMovementsChart();
            },
            renderMovementsChart() {
                if(this.state.activeTab !== 'reports') return;
                const ctx = document.getElementById('movements-chart')?.getContext('2d');
                if (!ctx) return;

                const { chartType, period } = this.state.dashboardSettings;
                const today = new Date(); today.setHours(23, 59, 59, 999);
                let startDate = new Date(); startDate.setHours(0, 0, 0, 0);
                let endDate = new Date(today);
                switch (period) {
                    case '7days': startDate.setDate(today.getDate() - 6); break;
                    case '30days': startDate.setDate(today.getDate() - 29); break;
                    case 'this_month': startDate = new Date(today.getFullYear(), today.getMonth(), 1); break;
                    case 'last_month':
                        startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                        endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                    case 'custom':
                        const startVal = this.state.dashboardSettings.startDate;
                        const endVal = this.state.dashboardSettings.endDate;
                        if (!startVal || !endVal) return;
                        startDate = new Date(startVal); startDate.setUTCHours(0, 0, 0, 0);
                        endDate = new Date(endVal); endDate.setUTCHours(23, 59, 59, 999);
                        break;
                }
                
                const existingProductIds = new Set(this.state.products.map(p => p.id));
                const movementsForExistingProducts = this.state.movements.filter(mov => existingProductIds.has(mov.productId));

                const filteredMovements = movementsForExistingProducts.filter(mov => {
                    const movDate = mov.date?.toDate();
                    return movDate && movDate >= startDate && movDate <= endDate;
                });
                
                if (this.state.chartInstance) this.state.chartInstance.destroy();
                const gridColor = 'rgba(0, 0, 0, 0.1)'; const textColor = '#111827';
                let chartConfig;
                if (chartType === 'pie') {
                    const totalEntradas = filteredMovements.filter(m => m.type === 'entrada').reduce((sum, m) => sum + m.quantity, 0);
                    const totalSaidas = filteredMovements.filter(m => m.type === 'saida').reduce((sum, m) => sum + m.quantity, 0);
                    chartConfig = {
                        type: 'pie',
                        data: {
                            labels: ['Entradas', 'Saídas'],
                            datasets: [{
                                data: [totalEntradas, totalSaidas],
                                backgroundColor: ['rgba(34, 197, 94, 0.8)', 'rgba(239, 68, 68, 0.8)'],
                                borderColor: ['#fff', '#fff'], borderWidth: 2
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: textColor } } } }
                    };
                } else {
                    const labels = []; const dataMap = new Map();
                    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                        const dateString = d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                        labels.push(dateString);
                        dataMap.set(dateString, { entrada: 0, saida: 0 });
                    }
                    filteredMovements.forEach(mov => {
                        if (mov.date?.toDate) {
                            const movDateStr = mov.date.toDate().toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                            if (dataMap.has(movDateStr)) {
                                const dayData = dataMap.get(movDateStr);
                                if (mov.type === 'entrada') dayData.entrada += mov.quantity;
                                else dayData.saida += mov.quantity;
                            }
                        }
                    });
                    const entradasData = labels.map(label => dataMap.get(label).entrada);
                    const saidasData = labels.map(label => dataMap.get(label).saida);
                    chartConfig = {
                        type: chartType,
                        data: {
                            labels,
                            datasets: [{
                                label: 'Entradas', data: entradasData,
                                backgroundColor: chartType === 'bar' ? 'rgba(34, 197, 94, 0.7)' : 'transparent',
                                borderColor: 'rgba(34, 197, 94, 1)', borderWidth: chartType === 'line' ? 3 : 1, tension: 0.2
                            }, {
                                label: 'Saídas', data: saidasData,
                                backgroundColor: chartType === 'bar' ? 'rgba(239, 68, 68, 0.7)' : 'transparent',
                                borderColor: 'rgba(239, 68, 68, 1)', borderWidth: chartType === 'line' ? 3 : 1, tension: 0.2
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor, precision: 0 } },
                                x: { grid: { color: gridColor }, ticks: { color: textColor } }
                            },
                            plugins: { legend: { position: 'top', labels: { color: textColor } } }
                        }
                    };
                }
                if (ctx && typeof Chart !== 'undefined') { 
                    this.state.chartInstance = new Chart(ctx, chartConfig);
                }
            },
            renderLowStockAlerts() {
                if(this.state.activeTab !== 'reports') return;
                const listEl = document.getElementById('low-stock-list'), emptyEl = document.getElementById('low-stock-empty');
                if (!listEl || !emptyEl) return;
                const lowStockProducts = this.state.products.filter(p => p.minStock > 0 && p.totalQuantity <= p.minStock);
                if (lowStockProducts.length > 0) {
                    listEl.innerHTML = lowStockProducts.map(p => `<li class="text-sm"><span class="font-semibold">${p.name}</span>: <span class="text-red-500 font-bold">${p.totalQuantity}</span> / ${p.minStock} ${p.unit}</li>`).join('');
                    listEl.classList.remove('hidden'); emptyEl.classList.add('hidden');
                } else {
                    listEl.classList.add('hidden'); emptyEl.classList.remove('hidden');
                }
            },
            renderTopMovements() {
                if(this.state.activeTab !== 'reports') return;
                const renderList = (elementId, data) => {
                    const listEl = document.getElementById(elementId);
                    if (!listEl) return;
                    if(data.length > 0) {
                        listEl.innerHTML = data.map(mov => {
                            const product = this.state.products.find(p => p.id === mov.productId);
                            const productName = product ? product.name : 'Produto Excluído'; 
                            return `<li class="text-sm truncate" title="${productName}"><strong>${mov.quantity}x</strong> ${productName}</li>`;
                        }).join('');
                    } else {
                        listEl.innerHTML = `<li class="text-sm text-gray-500">Nenhuma movimentação.</li>`;
                    }
                };
                
                const existingProductIds = new Set(this.state.products.map(p => p.id));
                const movementsForExistingProducts = this.state.movements.filter(mov => existingProductIds.has(mov.productId));

                const sorted = [...movementsForExistingProducts].sort((a,b) => (b.date?.seconds || 0) - (a.date?.seconds || 0));
                
                renderList('top-entradas-list', sorted.filter(m => m.type === 'entrada').slice(0, 5));
                renderList('top-saidas-list', sorted.filter(m => m.type === 'saida').slice(0, 5));
            },
            async handleGenerateReport() {
                if(this.state.activeTab !== 'reports') return;
                const dateInput = document.getElementById('report-date'), reportOutput = document.getElementById('report-output');
                if (!dateInput || !reportOutput || !dateInput.value) return this.showAlert('Selecione uma data para gerar o relatório.', true);
                const targetDate = new Date(dateInput.value); targetDate.setUTCHours(23, 59, 59, 999);
                this.setLoading(true);
                const historicalStock = {};
                this.state.products.forEach(p => {
                    const createdAt = p.createdAt?.toDate();
                    if(createdAt && createdAt <= targetDate) {
                        historicalStock[p.id] = { ...p, currentQuantity: 0 };
                    }
                });
                this.state.movements.filter(m => m.date?.toDate() && m.date.toDate() <= targetDate).forEach(m => {
                    if (historicalStock[m.productId]) { 
                        const productCreatedAt = this.state.products.find(p => p.id === m.productId)?.createdAt?.toDate();
                        const movementDate = m.date.toDate();
                        if ((m.motive === 'Criação de Produto' || m.motive === 'Importação Excel') && productCreatedAt && productCreatedAt.getTime() === movementDate.getTime()) {
                            historicalStock[m.productId].currentQuantity = m.quantity;
                        } else {
                            historicalStock[m.productId].currentQuantity += (m.type === 'entrada' ? m.quantity : -m.quantity);
                        }
                    }
                });
                document.getElementById('report-list').innerHTML = Object.values(historicalStock).map(p => `
                    <tr class="border-t border-gray-200">
                        <td class="p-3">${p.name}</td>
                        <td class="p-3 text-center">${this.state.categories.find(c=>c.id === p.category)?.name || 'N/A'}</td>
                        <td class="p-3 text-center">${p.unit}</td>
                        <td class="p-3 text-center font-bold">${p.currentQuantity}</td>
                    </tr>`).join('');
                document.getElementById('report-title').textContent = `Relatório de Estoque Histórico`;
                document.getElementById('report-subtitle').textContent = `Posição em ${new Date(dateInput.value + 'T00:00:00').toLocaleDateString('pt-BR')}`;
                reportOutput.classList.remove('hidden');
                this.setLoading(false);
            },
            renderPaginationControls(totalItems) {
                const controlsContainer = document.getElementById('pagination-controls');
                if (!controlsContainer) return; 
                const totalPages = Math.ceil(totalItems / this.state.itemsPerPage);
                if (totalPages <= 1) {
                    controlsContainer.innerHTML = '';
                    return;
                }
                const startItem = (this.state.currentPage - 1) * this.state.itemsPerPage + 1;
                const endItem = Math.min(this.state.currentPage * this.state.itemsPerPage, totalItems);
                controlsContainer.innerHTML = `<span class="text-sm text-gray-700">Mostrando <span class="font-semibold">${startItem}</span> a <span class="font-semibold">${endItem}</span> de <span class="font-semibold">${totalItems}</span></span><div><button data-action="page-prev" class="px-3 h-8 text-sm font-medium text-white bg-gray-800 rounded-l hover:bg-gray-900 disabled:opacity-50" ${this.state.currentPage === 1 ? 'disabled' : ''}>Anterior</button><button data-action="page-next" class="px-3 h-8 text-sm font-medium text-white bg-gray-800 rounded-r border-0 border-l border-gray-700 hover:bg-gray-900 disabled:opacity-50" ${this.state.currentPage === totalPages ? 'disabled' : ''}>Próximo</button></div>`;
            },
            renderBulkActionBar() {
                const actionBar = document.getElementById('bulk-action-bar');
                const selectedCountEl = document.getElementById('selected-count');
                if (!actionBar || !selectedCountEl || this.state.userRole !== 'admin') {
                    if(actionBar) actionBar.classList.add('hidden'); 
                     return;
                };
                if (this.state.selectedProducts.length > 0) {
                    selectedCountEl.textContent = `${this.state.selectedProducts.length} selecionado(s)`;
                    actionBar.classList.remove('hidden'); 
                    actionBar.classList.add('open');
                } else {
                    actionBar.classList.remove('open');
                }
            },
            clearFilters() {
                const searchInput = document.getElementById('search-product-input');
                const categoryFilter = document.getElementById('stock-category-filter');
                const statusFilter = document.getElementById('stock-status-filter');
                const dateStart = document.getElementById('date-filter-start');
                const dateEnd = document.getElementById('date-filter-end');

                if (searchInput) searchInput.value = '';
                if (categoryFilter) categoryFilter.value = 'all';
                if (statusFilter) statusFilter.value = 'all';
                if (dateStart) dateStart.value = '';
                if (dateEnd) dateEnd.value = '';
                
                this.state.currentPage = 1;
                if (this.state.activeTab === 'stock') this.renderProducts();
            },
            handleDownloadTemplate() {
                const headers = { name: "Exemplo Produto", category: "Exemplo Categoria", unit: "UND", minStock: 10 };
                this.state.locations.forEach(l => headers[l.id] = 0);
                const worksheet = XLSX.utils.json_to_sheet([headers]);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Produtos");
                XLSX.writeFile(workbook, "modelo_importacao_estoque.xlsx");
            },
            getFilteredProducts() {
                const categoryFilterEl = document.getElementById('stock-category-filter');
                const searchTermEl = document.getElementById('search-product-input');
                const stockStatusEl = document.getElementById('stock-status-filter');
                const startDateValEl = document.getElementById('date-filter-start');
                const endDateValEl = document.getElementById('date-filter-end');

                const categoryFilter = categoryFilterEl ? categoryFilterEl.value : 'all';
                const searchTerm = searchTermEl ? searchTermEl.value.toLowerCase() : '';
                const stockStatus = stockStatusEl ? stockStatusEl.value : 'all';
                const startDateVal = startDateValEl ? startDateValEl.value : null;
                const endDateVal = endDateValEl ? endDateValEl.value : null;
                
                let startDate = null;
                if (startDateVal) {
                    startDate = new Date(startDateVal);
                    startDate.setUTCHours(0, 0, 0, 0);
                }
                let endDate = null;
                if (endDateVal) {
                    endDate = new Date(endDateVal);
                    endDate.setUTCHours(23, 59, 59, 999);
                }

                return this.state.products.filter(p => {
                    const matchesCategory = categoryFilter === 'all' || p.category === categoryFilter;
                    const matchesSearch = p.name.toLowerCase().includes(searchTerm);
                    const matchesStatus = stockStatus === 'all' || 
                                          (stockStatus === 'low' && p.minStock > 0 && p.totalQuantity <= p.minStock) || 
                                          (stockStatus === 'ok' && p.totalQuantity > p.minStock);
                    
                    const createdAt = p.createdAt?.toDate();
                    let matchesDate = true;
                    if (createdAt) {
                        if (startDate && endDate) {
                            matchesDate = createdAt >= startDate && createdAt <= endDate;
                        } else if (startDate) {
                            matchesDate = createdAt >= startDate;
                        } else if (endDate) {
                            matchesDate = createdAt <= endDate;
                        }
                    } else if (startDate || endDate) {
                        matchesDate = false; 
                    }
            
                    return matchesCategory && matchesSearch && matchesStatus && matchesDate;
                }).sort((a,b) => a.name.localeCompare(b.name)); 
            },
            handleExportPdf() {
                const filteredProducts = this.getFilteredProducts();
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'landscape' });
                doc.text(`Relatório de Estoque - ${new Date().toLocaleDateString()}`, 14, 16);
                const head = [['Produto', 'Categoria', ...this.state.locations.map(l => l.name), 'Total']];
                const body = filteredProducts.map(p => [
                    p.name, 
                    this.state.categories.find(c => c.id === p.category)?.name || 'N/A', 
                    ...this.state.locations.map(l => p.quantities?.[l.id] || 0), 
                    p.totalQuantity
                ]);
                doc.autoTable({
                    head: head, body: body, startY: 20,
                    headStyles: { fillColor: [22, 163, 74] },
                    styles: { fontSize: 8 },
                });
                doc.save(`estoque_${new Date().toISOString().slice(0,10)}.pdf`);
            },
            handleExcelParse(file, filenameEl) {
                this.setLoading(true);
                filenameEl.textContent = `Carregando ${file.name}...`;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = e.target.result;
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet);
                        await this.handleBulkInsert(json);
                    } catch (error) {
                        this.showAlert(`Não foi possível ler o arquivo: ${error.message}`, true);
                    } finally {
                        filenameEl.textContent = '';
                        this.setLoading(false);
                        const excelInput = document.getElementById('excel-insert-input');
                        if (excelInput) excelInput.value = '';
                    }
                };
                reader.onerror = (error) => {
                     this.showAlert(`Erro ao ler o arquivo: ${error}`, true);
                     filenameEl.textContent = '';
                     this.setLoading(false);
                };
                reader.readAsArrayBuffer(file);
            },
            async handleBulkInsert(data) {
                const batch = writeBatch(this.db);
                const localCategories = [...this.state.categories];
                const localLocations = [...this.state.locations];
                let productsProcessedCount = 0;

                for (const row of data) {
                    let categoryName = row.category?.toString().trim();
                    let productName = row.name?.toString().trim();
                    if (!productName || !categoryName) continue;

                    let category = localCategories.find(c => c.name.toLowerCase() === categoryName.toLowerCase());
                    if (!category) {
                        const newCatRef = doc(collection(this.db, this.state.firestoreRefs.categories.path));
                        batch.set(newCatRef, { name: categoryName });
                        category = { id: newCatRef.id, name: categoryName };
                        localCategories.push(category);
                    }
                    
                    const quantities = {}; let totalQuantity = 0;
                    localLocations.forEach(loc => {
                        const qty = parseInt(row[loc.id], 10) || 0;
                        if (qty > 0) {
                           quantities[loc.id] = qty;
                           totalQuantity += qty;
                        }
                    });

                    const newProdRef = doc(collection(this.db, this.state.firestoreRefs.products.path));
                    const productData = {
                        name: productName, category: category.id, quantities, totalQuantity,
                        unit: row.unit?.toString().trim() || 'UND', 
                        minStock: parseInt(row.minStock, 10) || 0,
                        createdAt: serverTimestamp()
                    };
                    batch.set(newProdRef, productData);
                    productsProcessedCount++;

                    if (totalQuantity > 0) {
                        const movRef = doc(collection(this.db, this.state.firestoreRefs.movements.path));
                        batch.set(movRef, { 
                            productId: newProdRef.id, 
                            type: 'entrada', 
                            quantity: totalQuantity, 
                            motive: 'Importação Excel', 
                            date: productData.createdAt
                        });
                    }
                }
                if (productsProcessedCount > 0) {
                    await batch.commit();
                    this.showAlert(`${productsProcessedCount} produtos processados do arquivo Excel.`);
                } else {
                    this.showAlert('Nenhum produto válido encontrado no arquivo Excel para processar.');
                }
            },
            injectAllPanelsContent() {
                if (!this.state.dom || !this.state.dom.panels) return;
                const isAdmin = this.state.userRole === 'admin'; 
                const locationsQuantityInputs = this.state.locations.map(loc => `<label class="block"><span class="text-gray-700">${loc.name}</span><input type="number" id="qty-${loc.id}" min="0" value="0" class="mt-1 block w-full rounded-md bg-gray-100 border-transparent focus:border-gray-500 focus:bg-white focus:ring-0"></label>`).join('');
                const tableHeaders = this.state.locations.map(loc => `<th class="p-3 text-center text-gray-700">${loc.name}</th>`).join('');
                const tableCheckboxHeader = `<th class="p-3 w-4"><input type="checkbox" id="select-all-checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${isAdmin ? '' : 'style="display:none;"'}></th>`;
                const tableActionsHeader = `<th class="p-3 text-right text-gray-700" ${isAdmin ? '' : 'style="display:none;"'}>Ações</th>`;
                
                this.state.dom.panels.stock.innerHTML = `<div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200"><div class="flex flex-wrap justify-between items-center mb-4 gap-4"><h2 class="text-2xl font-semibold flex-shrink-0 text-gray-900">Estoque Atual</h2><div class="flex flex-wrap items-center gap-2"><div class="relative grow sm:grow-0"><i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i><input type="text" id="search-product-input" placeholder="Buscar..." class="w-full p-2 pl-10 bg-gray-100 rounded-lg text-gray-900"></div><select id="stock-category-filter" class="p-2 bg-gray-100 rounded-lg text-gray-900 grow sm:grow-0"><option value="all">Todas as Categorias</option></select><button id="toggle-advanced-filters" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition flex-shrink-0 flex items-center gap-2">Filtros <i class="fas fa-chevron-down"></i></button><button id="export-pdf-btn" data-role-required="admin" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition flex items-center gap-2"><i class="fas fa-file-pdf"></i> Exportar</button></div></div><div id="advanced-filters-wrapper"><div id="advanced-filters-content"><div class="p-4 mb-4 bg-gray-50 rounded-lg border border-gray-200"><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-end"><div><label for="stock-status-filter" class="block text-sm font-medium text-gray-700">Status</label><select id="stock-status-filter" class="mt-1 block w-full p-2 bg-white rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"><option value="all">Todos</option><option value="low">Estoque Baixo</option><option value="ok">Estoque OK</option></select></div><div><label for="date-filter-start" class="block text-sm font-medium text-gray-700">De</label><input type="date" id="date-filter-start" class="mt-1 block w-full p-2 bg-white rounded-md border-gray-300 shadow-sm"></div><div><label for="date-filter-end" class="block text-sm font-medium text-gray-700">Até</label><input type="date" id="date-filter-end" class="mt-1 block w-full p-2 bg-white rounded-md border-gray-300 shadow-sm"></div><div class="flex justify-end"><button id="clear-filters-btn" class="bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 transition">Limpar</button></div></div></div></div><div id="bulk-action-bar" class="bulk-action-bar hidden mb-4 p-2 bg-blue-50 border border-blue-200 rounded-lg flex items-center justify-between" data-role-required="admin"><span id="selected-count" class="text-sm font-medium text-blue-800"></span><button id="bulk-delete-btn" class="bg-red-500 text-white text-sm font-bold py-1 px-3 rounded-md hover:bg-red-600 transition"><i class="fas fa-trash-alt mr-2"></i>Excluir Selecionados</button></div><div id="stock-table-wrapper" class="relative"><div id="table-loading-indicator" class="hidden"><div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-blue-500"></div></div><div class="overflow-x-auto"><table class="w-full text-left min-w-[1400px]"><thead class="border-b-2 border-gray-200 bg-gray-50"><tr>${tableCheckboxHeader}<th class="p-3 text-gray-700 sticky left-0 bg-gray-50 dark:bg-gray-800">Produto</th><th class="p-3 text-center text-gray-700">Categoria</th><th class="p-3 text-center text-gray-700 font-bold">Total</th>${tableHeaders}${tableActionsHeader}</tr></thead><tbody id="product-list" class="divide-y divide-gray-200"></tbody></table></div></div><div id="pagination-controls" class="flex justify-between items-center mt-4"></div><div id="empty-state" class="hidden text-center py-12"><i class="fas fa-box-open fa-4x text-gray-400"></i><p id="empty-state-message" class="mt-4 text-gray-500">Nenhum produto.</p></div></div>`;
                this.state.dom.panels.register.innerHTML = `<div data-role-required="admin"><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200 h-fit"><h2 class="text-2xl font-semibold mb-4 text-gray-900">Gerenciar Categorias</h2><form id="add-category-form" class="flex gap-2 mb-4"><input type="text" id="category-name" placeholder="Nova categoria" class="w-full p-2 bg-gray-100 rounded-lg text-gray-900" required><button type="submit" class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 transition flex items-center justify-center w-12"><i class="fas fa-plus"></i></button></form><div id="category-list" class="space-y-2 max-h-60 overflow-y-auto pr-2"></div></div><div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-xl border border-gray-200"><h2 class="text-2xl font-semibold mb-4 text-gray-900">Adicionar Produto</h2><form id="add-product-form" class="space-y-4"><label class="block"><span class="text-gray-700">Nome</span><input type="text" id="product-name" class="mt-1 block w-full rounded-md bg-gray-100 border-transparent focus:border-gray-500 focus:bg-white focus:ring-0" required></label><label class="block"><span class="text-gray-700">Categoria</span><select id="product-category-select" class="mt-1 block w-full rounded-md bg-gray-100 border-transparent focus:border-gray-500 focus:bg-white focus:ring-0" required><option value="">Selecione...</option></select></label><div class="grid grid-cols-2 gap-4">${locationsQuantityInputs}</div><div class="grid grid-cols-2 gap-4"><label class="block"><span class="text-gray-700">Est. Mínimo</span><input type="number" id="product-min-stock" min="0" value="0" class="mt-1 block w-full rounded-md bg-gray-100 border-transparent focus:border-gray-500 focus:bg-white focus:ring-0" required></label><label class="block"><span class="text-gray-700">Unid.</span><select id="product-unit-select" class="mt-1 block w-full rounded-md bg-gray-100 border-transparent focus:border-gray-500 focus:bg-white focus:ring-0" required><option>UND</option><option>CX</option><option>KG</option><option>G</option><option>L</option><option>ML</option></select></label></div><button type="submit" class="w-full mt-4 bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700 transition"><i class="fas fa-plus mr-2"></i>Adicionar Produto</button></form></div></div><div class="mt-8 bg-white p-6 rounded-2xl shadow-xl border border-gray-200" data-role-required="admin"><h2 class="text-2xl font-semibold mb-4 text-gray-900"><i class="fas fa-file-excel mr-2 text-green-500"></i>Operações em Lote (Excel)</h2><div class="flex flex-col md:flex-row gap-6"><div class="flex-1 bg-gray-50 p-4 rounded-lg flex flex-col items-center text-center"><i class="fas fa-plus-circle fa-2x text-blue-500 mb-2"></i><h3 class="font-semibold mb-1 text-gray-900">Inserir Novos Produtos</h3><p class="text-sm text-gray-600 mb-3">Baixe o modelo, preencha e importe o arquivo Excel para adicionar vários produtos de uma vez.</p><div class="flex gap-2 w-full"><button id="download-template-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition"><i class="fas fa-download mr-2"></i>Baixar Modelo</button><input type="file" id="excel-insert-input" accept=".xlsx, .xls" class="hidden"><button id="upload-insert-trigger-btn" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition"><i class="fas fa-upload mr-2"></i>Importar</button></div><p id="excel-insert-filename" class="text-xs mt-2 text-gray-500"></p></div></div></div></div>`;
                this.state.dom.panels.outputs.innerHTML = `<div data-role-required="admin"><div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200 max-w-2xl mx-auto"><h2 class="text-2xl font-semibold mb-4 text-gray-900">Registrar Saída de Estoque</h2><form id="add-output-form" class="space-y-4"><div><label for="output-product-select" class="block text-sm mb-1 text-gray-700">Produto</label><select id="output-product-select" class="w-full p-2 bg-gray-100 rounded-lg text-gray-900" required><option value="">Selecione um produto...</option></select></div><div id="output-location-selector" class="space-y-2"></div><div><label for="output-quantity" class="block text-sm mb-1 text-gray-700">Quantidade da Saída</label><input type="number" id="output-quantity" min="1" class="w-full p-2 bg-gray-100 rounded-lg text-gray-900" required disabled></div><div><label for="output-motive-select" class="block text-sm mb-1 text-gray-700">Motivo da Saída</label><select id="output-motive-select" class="w-full p-2 bg-gray-100 rounded-lg text-gray-900" required><option value="Venda">Venda</option><option value="Perda">Perda</option><option value="Uso Interno">Uso Interno</option><option value="Outro">Outro</option></select></div><p id="output-stock-info" class="text-sm text-gray-500 font-medium h-5"></p><button type="submit" class="w-full mt-4 bg-red-600 text-white font-bold p-2 rounded-lg hover:bg-red-700 transition"><i class="fas fa-arrow-circle-up mr-2"></i>Registrar Saída</button></form></div></div>`;
                this.state.dom.panels.reports.innerHTML = `<div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200 mb-8"><h2 class="text-2xl font-semibold mb-4 text-gray-900">Dashboard de Movimentações</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg border"><div><label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Gráfico</label><div id="chart-type-selector" class="flex rounded-md shadow-sm"><button data-type="bar" class="chart-type-btn relative inline-flex items-center px-4 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:z-10 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">Barra</button><button data-type="line" class="chart-type-btn -ml-px relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:z-10 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">Linha</button><button data-type="pie" class="chart-type-btn -ml-px relative inline-flex items-center px-4 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:z-10 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">Pizza</button></div></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Período</label><select id="period-selector" class="dashboard-control block w-full p-2 bg-white rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"><option value="7days">Últimos 7 dias</option><option value="30days">Últimos 30 dias</option><option value="this_month">Este Mês</option><option value="last_month">Mês Passado</option><option value="custom">Personalizado</option></select></div><div id="custom-date-range-selector" class="hidden md:col-span-1 grid grid-cols-2 gap-4"><div><label for="dashboard-date-start" class="block text-sm font-medium text-gray-700">De</label><input type="date" id="dashboard-date-start" class="dashboard-control mt-1 block w-full p-2 bg-white rounded-md border-gray-300 shadow-sm"></div><div><label for="dashboard-date-end" class="block text-sm font-medium text-gray-700">Até</label><input type="date" id="dashboard-date-end" class="dashboard-control mt-1 block w-full p-2 bg-white rounded-md border-gray-300 shadow-sm"></div></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="md:col-span-2 bg-gray-50 p-4 rounded-lg h-96"><canvas id="movements-chart"></canvas></div><div class="space-y-4"><div class="bg-amber-100 p-4 rounded-lg"><h3 class="font-semibold mb-2 text-amber-800">Alerta de Estoque Baixo</h3><ul id="low-stock-list" class="space-y-2 max-h-40 overflow-y-auto"></ul><p id="low-stock-empty" class="text-sm text-gray-500 hidden">Tudo em ordem!</p></div><div class="bg-gray-50 p-4 rounded-lg"><h3 class="font-semibold mb-2 text-green-800">Top 5 Entradas Recentes</h3><ul id="top-entradas-list" class="space-y-2"></ul></div><div class="bg-gray-50 p-4 rounded-lg"><h3 class="font-semibold mb-2 text-red-800">Top 5 Saídas Recentes</h3><ul id="top-saidas-list" class="space-y-2"></ul></div></div></div></div><div class="mt-8 bg-white p-6 rounded-2xl shadow-xl border border-gray-200"><h2 class="text-2xl font-semibold mb-4 text-gray-900"><i class="fas fa-history mr-2 text-indigo-500"></i>Relatório Histórico</h2><div class="flex items-end gap-4"><div class="flex-grow"><label for="report-date" class="block text-sm font-medium text-gray-700">Verificar estoque na data:</label><input type="date" id="report-date" class="mt-1 block w-full p-2 bg-gray-100 rounded-lg"></div><button id="generate-report-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Gerar Relatório</button></div><div id="report-output" class="hidden mt-6"><div id="print-area"><h3 id="report-title" class="text-xl font-bold text-center"></h3><p id="report-subtitle" class="text-center text-gray-500 mb-4"></p><table class="w-full text-left"><thead class="border-b-2 border-gray-300"><tr><th class="p-3">Produto</th><th class="p-3 text-center">Categoria</th><th class="p-3 text-center">Unidade</th><th class="p-3 text-center">Qtd. em Estoque</th></tr></thead><tbody id="report-list" class="divide-y divide-gray-200"></tbody></table></div><button id="print-report-btn" class="mt-4 bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-800 transition float-right"><i class="fas fa-print mr-2"></i>Imprimir</button></div></div>`;
                this.state.dom.panels.settings.innerHTML = `<div data-role-required="admin"><div class="space-y-8"><div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200"><h2 class="text-2xl font-semibold mb-4 text-gray-900">Configurações Gerais</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><h3 class="text-lg font-medium text-gray-900 mb-2">Gerenciar Localidades</h3><form id="add-location-form" class="flex gap-2 mb-4"><input type="text" id="location-name" placeholder="Nova localidade" class="w-full p-2 bg-gray-100 rounded-lg text-gray-900" required><button type="submit" class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 transition flex items-center justify-center w-12"><i class="fas fa-plus"></i></button></form><div id="location-list" class="space-y-2 max-h-60 overflow-y-auto pr-2"></div></div><div><h3 class="text-lg font-medium text-gray-900 mb-2">Configurações de Exibição</h3><div class="space-y-4"><div><label for="items-per-page-input" class="block text-sm font-medium text-gray-700">Itens por página na tabela</label><input type="number" id="items-per-page-input" min="1" class="mt-1 block w-full p-2 bg-gray-100 rounded-lg"></div><button id="save-settings-btn" class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700 transition">Salvar Configurações Gerais</button></div></div></div></div><div id="user-management-section" class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200"><h2 class="text-2xl font-semibold mb-6 text-gray-900"><i class="fas fa-users-cog mr-2"></i>Gerenciar Usuários</h2><div class="overflow-x-auto"><table class="w-full text-left"><thead class="border-b-2 border-gray-200 bg-gray-50"><tr><th class="p-3 text-sm font-semibold text-gray-700">Email</th><th class="p-3 text-sm font-semibold text-gray-700">Papel</th><th class="p-3 text-sm font-semibold text-gray-700 text-right">Ação</th></tr></thead><tbody id="user-list-tbody" class="divide-y divide-gray-200"></tbody></table></div><p class="mt-4 text-xs text-gray-500 italic">Administradores não podem alterar seu próprio papel através desta interface.</p></div></div></div>`;
                
                this.applyRolePermissions();
            },
            updateOutputQuantityLock() {
                if (this.state.activeTab !== 'outputs') return;

                const quantityInput = document.getElementById('output-quantity');
                const selectedLocationRadio = document.querySelector('input[name="output-location"]:checked');
                
                if (!quantityInput) return; 

                if (!selectedLocationRadio) {
                    quantityInput.disabled = true;
                    quantityInput.value = '';
                    quantityInput.placeholder = '';
                    return;
                }
                const productId = document.getElementById('output-product-select').value;
                const product = this.state.products.find(p => p.id === productId);
                if (!product) return;
                
                const locationId = selectedLocationRadio.value;
                const maxQuantity = product.quantities?.[locationId] || 0;
                
                quantityInput.max = maxQuantity;
                quantityInput.disabled = false;
                quantityInput.placeholder = `Máx: ${maxQuantity}`;
                
                if (parseInt(quantityInput.value, 10) > maxQuantity) {
                    quantityInput.value = maxQuantity;
                }
                 if (maxQuantity === 0) {
                    quantityInput.disabled = true;
                    quantityInput.value = '';
                    quantityInput.placeholder = 'Sem estoque nesta localidade';
                }
            },
            handleOutputProductSelection(productId) {
                if (this.state.activeTab !== 'outputs') return;

                const stockInfoEl = document.getElementById('output-stock-info');
                const locationSelectorEl = document.getElementById('output-location-selector');
                const quantityInput = document.getElementById('output-quantity');

                if (!stockInfoEl || !locationSelectorEl || !quantityInput) return;

                stockInfoEl.textContent = '';
                locationSelectorEl.innerHTML = '';
                quantityInput.value = '';
                quantityInput.removeAttribute('max');
                quantityInput.disabled = true;
                quantityInput.placeholder = '';

                if (!productId) return;

                const product = this.state.products.find(p => p.id === productId);
                if (product) {
                    stockInfoEl.textContent = `Estoque Total: ${product.totalQuantity} ${product.unit}`;
                    const locationOptionsHtml = this.state.locations.map(loc => {
                        const qty = product.quantities?.[loc.id] || 0;
                        return `
                            <label class="flex items-center space-x-3 p-2 rounded-lg border border-gray-200 hover:bg-gray-50 ${qty > 0 ? 'cursor-pointer' : 'opacity-50 cursor-not-allowed'}">
                                <input type="radio" name="output-location" value="${loc.id}" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" ${qty === 0 ? 'disabled' : ''}>
                                <span class="text-gray-800">${loc.name}: <span class="font-semibold">${qty}</span></span>
                            </label>
                           `;
                    }).join('');
                    
                    if (locationOptionsHtml.trim() !== '') {
                        locationSelectorEl.innerHTML = `<p class="text-sm font-medium text-gray-700 mb-2">De onde está saindo?</p><div class="grid grid-cols-1 sm:grid-cols-2 gap-2">${locationOptionsHtml}</div>`;
                    } else {
                         locationSelectorEl.innerHTML = '<p class="text-sm text-gray-500">Este produto não parece ter informações de estoque por localidade ou não há localidades cadastradas.</p>';
                    }
                } else {
                    stockInfoEl.textContent = 'Produto não encontrado.';
                }
            },
            handleContentChange(e) {
             const target = e.target;
             if (['stock-category-filter', 'stock-status-filter', 'date-filter-start', 'date-filter-end'].includes(target.id)) {
                 this.state.currentPage = 1;
                 if (this.state.activeTab === 'stock') this.renderProducts();
             }
             if (target.id === 'output-product-select') this.handleOutputProductSelection(target.value);
             
             if (target.id === 'excel-insert-input') {
                 const file = target.files?.[0];
                 const filenameEl = document.getElementById('excel-insert-filename');
                 if(file && filenameEl) {
                     this.handleExcelParse(file, filenameEl);
                 }
             }
             
             if (target.id === 'select-all-checkbox') {
                 this.handleSelectAllChange(e);
             } else if (target.classList.contains('product-checkbox')) {
                 this.handleSingleCheckboxChange(); 
             }
             
             if (target.name === 'output-location') {
                 this.updateOutputQuantityLock();
             }
             
             if (target.id === 'period-selector') {
                 const period = target.value;
                 this.state.dashboardSettings.period = period;
                 const customDateSelector = document.getElementById('custom-date-range-selector');
                 if (customDateSelector) {
                    if (period === 'custom') {
                        customDateSelector.classList.remove('hidden');
                        customDateSelector.classList.add('grid');
                    } else {
                        customDateSelector.classList.add('hidden');
                        customDateSelector.classList.remove('grid');
                        if (this.state.activeTab === 'reports') this.updateDashboardView();
                    }
                 }
             }
             
             if (target.id === 'dashboard-date-start' || target.id === 'dashboard-date-end') {
                 this.state.dashboardSettings.startDate = document.getElementById('dashboard-date-start').value;
                 this.state.dashboardSettings.endDate = document.getElementById('dashboard-date-end').value;
                 if (this.state.dashboardSettings.startDate && this.state.dashboardSettings.endDate && this.state.activeTab === 'reports') {
                     this.updateDashboardView();
                 }
             }
            },
            handleContentInput(e) {
                const target = e.target;
                if (target.id === 'search-product-input') {
                    this.state.currentPage = 1;
                    if (this.state.activeTab === 'stock') this.debouncedRenderProducts();
                }
                if (target.id === 'output-quantity') {
                    const max = parseInt(target.max, 10);
                    const currentValue = parseInt(target.value, 10);
                    if (!isNaN(max) && !isNaN(currentValue) && currentValue > max) {
                        target.value = max;
                    }
                    if (!isNaN(currentValue) && currentValue < 0) {
                        target.value = 0;
                    }
                }
            },
            async handleSaveSettings() { 
                if (this.state.userRole !== 'admin') return;
                const input = document.getElementById('items-per-page-input');
                if (!input) return;
                const itemsPerPage = parseInt(input.value, 10);
                if (isNaN(itemsPerPage) || itemsPerPage <= 0) {
                    return this.showAlert('Número de itens por página inválido.', true);
                }
                
                this.setLoading(true);
                try {
                    await setDoc(this.state.firestoreRefs.settings, { itemsPerPage }, { merge: true });
                    this.showAlert('Configurações gerais salvas.');
                } catch(error) {
                    this.showAlert('Não foi possível salvar as configurações gerais.', true);
                } finally {
                    this.setLoading(false);
                }
            },
        });

        new StockApp();
    </script>
</body>
</html>
