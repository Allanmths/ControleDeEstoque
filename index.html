<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Estoque por Localidade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Biblioteca para manipulação de arquivos Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- Adicionado dependências do Toastify.js -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <style>
        :root {
            --color-primary: #2563eb; /* Tailwind blue-600 */
            --color-primary-hover: #1d4ed8; /* Tailwind blue-700 */
            --color-primary-light: #eff6ff; /* Tailwind blue-50 */
            --color-danger: #dc2626; /* Tailwind red-600 */
            --color-danger-hover: #b91c1c; /* Tailwind red-700 */
            --color-success: #16a34a; /* Tailwind green-600 */
            --color-success-hover: #15803d; /* Tailwind green-700 */
            --color-warning: #f59e0b; /* Tailwind amber-500 */
            --color-purple: #7c3aed; /* Tailwind purple-600 */
        }
        .bg-primary { background-color: var(--color-primary); }
        .hover\:bg-primary-hover:hover { background-color: var(--color-primary-hover); }
        .text-primary { color: var(--color-primary); }
        .border-primary { border-color: var(--color-primary); }
        .ring-primary:focus { --tw-ring-color: var(--color-primary); }
        .bg-primary-light { background-color: var(--color-primary-light); }

        .bg-danger { background-color: var(--color-danger); }
        .hover\:bg-danger-hover:hover { background-color: var(--color-danger-hover); }
        .text-danger { color: var(--color-danger); }
        
        .bg-success { background-color: var(--color-success); }
        .hover\:bg-success-hover:hover { background-color: var(--color-success-hover); }

        .text-warning { color: var(--color-warning); }
        .text-purple { color: var(--color-purple); }

        body { font-family: 'Inter', sans-serif; }
        .modal-backdrop, #sidebar-overlay { background-color: rgba(0, 0, 0, 0.5); }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; } /* slate-100 */
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        @media print {
            body * { visibility: hidden !important; }
            #print-area, #print-area * { visibility: visible !important; }
            #print-area { position: absolute !important; left: 0 !important; top: 0 !important; width: 100% !important; }
            @page { size: A4; margin: 20mm; }
        }
        tr.low-stock-warning { background-color: #fef9c3 !important; }
        tr.low-stock-warning:hover { background-color: #fef08a !important; }
        #advanced-filters-wrapper { display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.4s ease-in-out; }
        #advanced-filters-wrapper.open { grid-template-rows: 1fr; }
        #advanced-filters-content { overflow: hidden; }
        .bulk-action-bar { transition: all 0.3s ease-in-out; max-height: 0; overflow: hidden; }
        .bulk-action-bar.open { max-height: 500px; }
        #toggle-advanced-filters i { transition: transform 0.3s ease-in-out; }
        #toggle-advanced-filters.open i { transform: rotate(180deg); }
        
        #loading-bar {
            position: fixed; top: 0; left: 0; z-index: 9999;
            width: 100%; height: 3px; background-color: var(--color-primary);
            display: none;
            transition: opacity 0.3s ease;
        }
        #loading-bar.show { display: block; }
        #loading-bar::before {
            content: ''; display: block; position: absolute;
            top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(to right, transparent 0%, rgba(255,255,255,0.4) 50%, transparent 100%);
            animation: loading-shimmer 1.5s infinite;
        }
    </style>
</head>

<body class="bg-white text-gray-900 min-h-screen">

    <!-- Seção de Autenticação -->
    <div id="auth-section" class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-gray-50">
        <div id="auth-container" class="w-full max-w-md">
            <!-- Formulário de Login -->
            <div id="login-form-container">
                <div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-200 text-center">
                    <i class="fas fa-boxes-stacked fa-2x text-primary mb-4"></i>
                    <h2 class="text-2xl font-bold text-gray-800 mb-1">Bem-vindo de volta!</h2>
                    <p class="text-gray-500 mb-6">Faça login para acessar o estoque.</p>
                    <form id="login-form" class="space-y-4">
                        <input type="email" id="login-email" placeholder="Email" class="w-full p-3 bg-white rounded-lg text-gray-900 border border-gray-300 focus:ring-2 focus:ring-blue-300 focus:border-blue-500" required>
                        <input type="password" id="login-password" placeholder="Senha" class="w-full p-3 bg-white rounded-lg text-gray-900 border border-gray-300 focus:ring-2 focus:ring-blue-300 focus:border-blue-500" required>
                        <button type="submit" class="w-full bg-primary text-white font-bold py-3 rounded-lg hover:bg-primary-hover transition">Entrar</button>
                    </form>
                    <p class="mt-6 text-sm">Não tem uma conta? <a href="#" id="show-register-link" class="font-semibold text-primary hover:underline">Registre-se</a></p>
                </div>
            </div>
            <!-- Formulário de Registro -->
            <div id="register-form-container" class="hidden">
                <div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-200 text-center">
                    <i class="fas fa-user-plus fa-2x text-primary mb-4"></i>
                    <h2 class="text-2xl font-bold text-gray-800 mb-1">Crie sua Conta</h2>
                    <p class="text-gray-500 mb-6">O registro cria uma conta com permissão de 'Visualizador'.</p>
                    <form id="register-form" class="space-y-4">
                        <input type="email" id="register-email" placeholder="Email" class="w-full p-3 bg-white rounded-lg text-gray-900 border border-gray-300 focus:ring-2 focus:ring-blue-300 focus:border-blue-500" required>
                        <input type="password" id="register-password" placeholder="Senha (mínimo 6 caracteres)" class="w-full p-3 bg-white rounded-lg text-gray-900 border border-gray-300 focus:ring-2 focus:ring-blue-300 focus:border-blue-500" required>
                        <button type="submit" class="w-full bg-success text-white font-bold py-3 rounded-lg hover:bg-success-hover transition">Registrar</button>
                    </form>
                    <p class="mt-6 text-sm">Já tem uma conta? <a href="#" id="show-login-link" class="font-semibold text-primary hover:underline">Faça Login</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar Menu -->
    <div id="sidebar-menu" class="fixed top-0 left-0 h-full w-64 bg-white shadow-lg z-50 transform -translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
        <div class="flex-grow">
            <div class="p-4 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-900">Menu</h2>
            </div>
            <nav id="sidebar-nav" class="p-4 space-y-2">
                <a href="#" data-tab="home" class="sidebar-link flex items-center p-3 rounded-lg bg-gray-100 text-gray-700">
                    <i class="fas fa-home w-6 mr-3"></i>Início
                </a>
                <a href="#" data-tab="reports" class="sidebar-link flex items-center p-3 rounded-lg hover:bg-gray-100 text-gray-700">
                    <i class="fas fa-chart-pie w-6 mr-3"></i>Dashboard
                </a>
                <a href="#" data-tab="stock" class="sidebar-link flex items-center p-3 rounded-lg hover:bg-gray-100 text-gray-700">
                    <i class="fas fa-warehouse w-6 mr-3"></i>Estoque
                </a>
                <a href="#" data-tab="register" class="sidebar-link flex items-center p-3 rounded-lg hover:bg-gray-100 text-gray-700">
                    <i class="fas fa-plus-circle w-6 mr-3"></i>Cadastros
                </a>
                <a href="#" data-tab="movements" class="sidebar-link flex items-center p-3 rounded-lg hover:bg-gray-100 text-gray-700">
                    <i class="fas fa-exchange-alt w-6 mr-3"></i>Movimentações
                </a>
                <a href="#" data-tab="counting" class="sidebar-link flex items-center p-3 rounded-lg hover:bg-gray-100 text-gray-700">
                    <i class="fas fa-clipboard-check w-6 mr-3"></i>Contagem
                </a>
                <a href="#" data-tab="audit" class="sidebar-link flex items-center p-3 rounded-lg hover:bg-gray-100 text-gray-700">
                    <i class="fas fa-history w-6 mr-3"></i>Auditoria
                </a>
            </nav>
        </div>
        <div class="p-4 border-t border-gray-200">
             <a href="#" data-tab="settings" class="sidebar-link flex items-center p-3 rounded-lg hover:bg-gray-100 text-gray-700">
                <i class="fas fa-cog w-6 mr-3"></i>Configurações
            </a>
            <a href="#" id="logout-btn" class="flex items-center p-3 rounded-lg hover:bg-red-100 text-danger font-semibold">
                <i class="fas fa-sign-out-alt w-6 mr-3"></i>Sair
            </a>
        </div>
    </div>
    <div id="sidebar-overlay" class="fixed inset-0 z-40 hidden"></div>

    <div id="loading-bar"></div>

    <!-- Main App Section -->
    <div id="app-section" class="hidden">
        <div class="container mx-auto p-4 md:p-8 max-w-7xl">
            <header class="mb-8 text-center relative">
                <button id="menu-toggle-btn" class="absolute left-0 top-1/2 -translate-y-1/2 p-2 rounded-md hover:bg-gray-100 text-gray-600">
                    <i class="fas fa-bars fa-lg"></i>
                </button>
                <h1 class="text-4xl md:text-5xl font-bold text-gray-900"><i class="fas fa-boxes-stacked mr-3 text-primary"></i>Estoque HCM</h1>
                <p id="user-welcome-message" class="text-gray-500 mt-2">Controle de Estoque da Adega.</p>
            </header>
            
            <main id="tab-content">
                <div id="panel-home" class="tab-panel"></div>
                <div id="panel-reports" class="tab-panel hidden"></div>
                <div id="panel-stock" class="tab-panel hidden"></div>
                <div id="panel-register" class="tab-panel hidden"></div>
                <div id="panel-movements" class="tab-panel hidden"></div>
                <div id="panel-counting" class="tab-panel hidden"></div>
                <div id="panel-settings" class="tab-panel hidden"></div>
                <div id="panel-audit" class="tab-panel hidden"></div>
            </main>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="edit-modal" class="fixed inset-0 modal-backdrop items-center justify-center z-50 hidden"><div class="bg-white w-full max-w-lg p-6 rounded-2xl shadow-2xl m-4"><h3 class="text-xl font-semibold mb-4 text-gray-900">Editar Produto</h3><p id="edit-product-name" class="mb-4 text-gray-600"></p><div id="edit-quantities-container" class="space-y-4"></div><div class="mt-6 flex justify-end space-x-4"><button id="cancel-edit" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Cancelar</button><button id="save-edit" class="px-6 py-2 bg-primary text-white font-semibold rounded-lg hover:bg-primary-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition">Salvar</button></div></div></div>
    <div id="delete-modal" class="fixed inset-0 modal-backdrop items-center justify-center z-50 hidden"><div class="bg-white w-full max-w-md p-6 rounded-2xl shadow-2xl m-4 text-center"><i class="fas fa-triangle-exclamation fa-3x text-danger mb-4"></i><h3 class="text-xl font-semibold mb-2 text-gray-900">Confirmar Exclusão</h3><p id="delete-modal-text" class="mb-6 text-gray-600"></p><div class="flex justify-center space-x-4"><button id="cancel-delete" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Cancelar</button><button id="confirm-delete" class="px-6 py-2 bg-danger text-white font-semibold rounded-lg hover:bg-danger-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition">Excluir</button></div></div></div>
    <div id="permissions-modal" class="fixed inset-0 modal-backdrop items-center justify-center z-50 hidden"><div class="bg-white w-full max-w-2xl p-6 rounded-2xl shadow-2xl m-4"><h3 class="text-xl font-semibold mb-1 text-gray-900">Gerenciar Permissões</h3><p id="permissions-user-email" class="mb-4 text-gray-600"></p><div id="permissions-checkbox-container" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div><div class="mt-6 flex justify-end space-x-4"><button id="cancel-permissions" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Cancelar</button><button id="save-permissions" class="px-6 py-2 bg-primary text-white font-semibold rounded-lg hover:bg-primary-hover transition">Salvar</button></div></div></div>

    <!-- Firebase SDK e Script da Aplicação -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, writeBatch, runTransaction, serverTimestamp, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const debounce = (func, delay) => {
            let timeoutId;
            return function(...args) {
                const context = this;
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(context, args), delay);
            };
        };
        
        const firebaseConfig = {
            apiKey: "AIzaSyDVxDoPVP-uhWwfXsdlouk5uv-jt-P6tL8",
            authDomain: "controledeestoque-7ea51.firebaseapp.com",
            projectId: "controledeestoque-7ea51",
            storageBucket: "controledeestoque-7ea51.appspot.com",
            messagingSenderId: "355699807496",
            appId: "1:355699807496:web:6432766da431e535b888bd"
        };
        
        const appId = 'default-stock-app';

        class StockApp {
            app;
            auth;
            db;
            state = {
                products: [], categories: [], locations: [], movements: [], allUsers: [], auditLog: [], countingHistory: [],
                selectedProducts: [],
                currentPage: 1, itemsPerPage: 10,
                firestoreRefs: null, dom: null, chartInstance: null,
                deleteQueue: { id: null, type: null, isBulk: false },
                isAuthReady: false,
                currentUser: null, 
                currentUserData: null,
                userRole: null, 
                dashboardSettings: { chartType: 'bar', period: '7days', startDate: null, endDate: null },
                unsubscribers: [],
            };

            constructor() {
                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    console.error("Firebase config is not set or is missing API key.");
                    document.addEventListener('DOMContentLoaded', () => {
                        document.body.innerHTML = `<div class="w-full h-screen flex items-center justify-center p-4"><div class="text-center bg-red-100 p-8 rounded-lg shadow-md"><h1 class="text-2xl font-bold text-danger mb-2">Erro de Configuração</h1><p class="text-red-700">As credenciais do Firebase não foram configuradas corretamente ou a API Key está ausente. Verifique o console para mais detalhes.</p></div></div>`;
                    });
                    return;
                }
                this.app = initializeApp(firebaseConfig);
                this.auth = getAuth(this.app);
                this.db = getFirestore(this.app);
                this.debouncedRenderProducts = debounce(this.renderProducts.bind(this), 300);
                document.addEventListener('DOMContentLoaded', this.init.bind(this));
            }

            init() {
                this.cacheDomElements();
                this.injectPanelContent();
                this.setupFirestoreRefs();
                this.setupEventListeners();
                this.handleAuthentication();
            }
            
            cacheDomElements() {
                this.state.dom = {
                    loadingBar: document.getElementById('loading-bar'),
                    appSection: document.getElementById('app-section'),
                    authSection: document.getElementById('auth-section'),
                    authContainer: document.getElementById('auth-container'),
                    loginFormContainer: document.getElementById('login-form-container'),
                    registerFormContainer: document.getElementById('register-form-container'),
                    contentEl: document.getElementById('tab-content'),
                    panels: { 
                        home: document.getElementById('panel-home'), 
                        stock: document.getElementById('panel-stock'), 
                        register: document.getElementById('panel-register'), 
                        movements: document.getElementById('panel-movements'), 
                        reports: document.getElementById('panel-reports'), 
                        settings: document.getElementById('panel-settings'),
                        audit: document.getElementById('panel-audit'),
                        counting: document.getElementById('panel-counting'),
                    },
                    sidebar: { menu: document.getElementById('sidebar-menu'), nav: document.getElementById('sidebar-nav'), overlay: document.getElementById('sidebar-overlay'), toggleBtn: document.getElementById('menu-toggle-btn'), logoutBtn: document.getElementById('logout-btn') },
                    modals: {
                        edit: { self: document.getElementById('edit-modal'), productName: document.getElementById('edit-product-name'), quantitiesContainer: document.getElementById('edit-quantities-container'), saveBtn: document.getElementById('save-edit'), cancelBtn: document.getElementById('cancel-edit') },
                        delete: { self: document.getElementById('delete-modal'), text: document.getElementById('delete-modal-text'), confirmBtn: document.getElementById('confirm-delete'), cancelBtn: document.getElementById('cancel-delete') },
                        permissions: { self: document.getElementById('permissions-modal'), userEmail: document.getElementById('permissions-user-email'), checkboxContainer: document.getElementById('permissions-checkbox-container'), saveBtn: document.getElementById('save-permissions'), cancelBtn: document.getElementById('cancel-permissions') },
                    },
                };
            }
            
            setLoading(isLoading) {
                if (this.state.dom.loadingBar) {
                    this.state.dom.loadingBar.classList.toggle('show', isLoading);
                }
            }

            setupEventListeners() {
                const { dom } = this.state;
                if (!dom) return;

                document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); this.handleLogin(e.target); });
                document.getElementById('register-form').addEventListener('submit', (e) => { e.preventDefault(); this.handleRegister(e.target); });
                document.getElementById('show-register-link').addEventListener('click', (e) => { e.preventDefault(); this.toggleAuthForm(true); });
                document.getElementById('show-login-link').addEventListener('click', (e) => { e.preventDefault(); this.toggleAuthForm(false); });
                dom.sidebar.logoutBtn.addEventListener('click', (e) => { e.preventDefault(); this.handleLogout(); });
                dom.modals.edit.cancelBtn.addEventListener('click', () => this.closeEditModal());
                dom.modals.edit.saveBtn.addEventListener('click', (e) => this.handleSaveEdit(e.target));
                dom.modals.delete.cancelBtn.addEventListener('click', () => this.closeDeleteModal());
                dom.modals.delete.confirmBtn.addEventListener('click', () => this.handleDelete());
                dom.modals.permissions.cancelBtn.addEventListener('click', () => this.closePermissionsModal());
                dom.modals.permissions.saveBtn.addEventListener('click', () => this.handleSavePermissions());
                dom.sidebar.toggleBtn.addEventListener('click', () => this.toggleSidebar(true));
                dom.sidebar.overlay.addEventListener('click', () => this.toggleSidebar(false));
                dom.sidebar.menu.addEventListener('click', (e) => {
                    const link = e.target.closest('.sidebar-link');
                    if (link && link.dataset.tab) {
                        e.preventDefault();
                        this.switchTab(link.dataset.tab);
                        this.toggleSidebar(false);
                    }
                });
                dom.contentEl.addEventListener('submit', (e) => this.handleFormSubmit(e));
                dom.contentEl.addEventListener('click', (e) => this.handleContentClick(e));
                dom.contentEl.addEventListener('change', (e) => this.handleContentChange(e));
                dom.contentEl.addEventListener('input', (e) => this.handleContentInput(e));
            }

            // --- AUTHENTICATION & PERMISSIONS ---
            handleAuthentication() {
                onAuthStateChanged(this.auth, async (user) => {
                    this.setLoading(true);
                    this.clearAllListeners(); 

                    if (user) {
                        try {
                            this.state.currentUser = user;
                            const userDocRef = doc(this.db, 'users', user.uid);
                            const userDoc = await getDoc(userDocRef);

                            if (userDoc.exists()) {
                                this.state.currentUserData = userDoc.data();
                                this.state.userRole = this.state.currentUserData.role || 'viewer';
                                // Migration logic for old permissions structure
                                if (this.state.currentUserData.permissions && typeof this.state.currentUserData.permissions.home === 'boolean') {
                                    console.log("Migrating old permissions structure for user:", user.email);
                                    const newPermissions = this.migratePermissions(this.state.currentUserData.permissions);
                                    this.state.currentUserData.permissions = newPermissions;
                                    await updateDoc(userDocRef, { permissions: newPermissions });
                                }
                            } else {
                                // This case should ideally not happen after registration, but as a fallback:
                                this.state.userRole = 'viewer';
                                this.state.currentUserData = { 
                                    email: user.email,
                                    role: 'viewer',
                                    permissions: this.getDefaultPermissions()
                                };
                                await setDoc(userDocRef, this.state.currentUserData);
                            }
                            
                            this.state.isAuthReady = true; 
                            
                            this.showAppUI(); 
                            this.initializeAppDataListeners(); 
                            this.renderCurrentTab(); 

                        } catch (error) {
                            console.error("Erro fatal durante a autenticação ou inicialização:", error);
                            this.showAlert("Ocorreu um erro crítico ao carregar a aplicação.", true);
                            this.showAuthUI(); 
                        } finally {
                            this.setLoading(false);
                        }
                    } else {
                        this.showAuthUI();
                        this.setLoading(false);
                    }
                });
            }

            async handleLogin(form) {
                const email = form.querySelector('#login-email').value;
                const password = form.querySelector('#login-password').value;
                this.setLoading(true);
                try {
                    await signInWithEmailAndPassword(this.auth, email, password);
                } catch (error) {
                    this.showAlert(this.getFriendlyAuthError(error.code), true);
                    this.setLoading(false);
                }
            }

            async handleRegister(form) {
                const email = form.querySelector('#register-email').value;
                const password = form.querySelector('#register-password').value;
                this.setLoading(true);
                try {
                    const userCredential = await createUserWithEmailAndPassword(this.auth, email, password);
                    await setDoc(doc(this.db, "users", userCredential.user.uid), {
                        email: userCredential.user.email,
                        role: "viewer",
                        createdAt: serverTimestamp(),
                        permissions: this.getDefaultPermissions()
                    });
                } catch (error) {
                    this.showAlert(this.getFriendlyAuthError(error.code), true);
                    this.setLoading(false);
                }
            }

            async handleLogout() {
                this.setLoading(true);
                await signOut(this.auth);
            }
            
            toggleAuthForm(showRegister) {
                this.state.dom.loginFormContainer.classList.toggle('hidden', showRegister);
                this.state.dom.registerFormContainer.classList.toggle('hidden', !showRegister);
            }
            
            showAppUI() {
                this.state.dom.authSection.classList.add('hidden');
                this.state.dom.authSection.classList.remove('flex');
                this.state.dom.appSection.classList.remove('hidden');
                this.applyRolePermissions();
            }

            showAuthUI() {
                this.state.isAuthReady = false;
                this.state.currentUser = null;
                this.state.currentUserData = null;
                this.state.userRole = null;
                
                this.state.dom.authSection.classList.remove('hidden');
                this.state.dom.authSection.classList.add('flex');
                this.state.dom.appSection.classList.add('hidden');
                
                // Reset data state explicitly
                this.state.products = [];
                this.state.categories = [];
                this.state.locations = [];
                this.state.movements = [];
                this.state.allUsers = [];
                this.state.auditLog = [];
                this.state.countingHistory = [];
                this.state.selectedProducts = [];
                this.state.currentPage = 1;
            }
            
            applyRolePermissions() {
                const { userRole } = this.state;
                const welcomeEl = document.getElementById('user-welcome-message');
                if (welcomeEl) {
                    welcomeEl.textContent = `Bem-vindo! Você está logado como ${userRole === 'admin' ? 'Administrador' : 'Visualizador'}.`;
                }

                document.querySelectorAll('#sidebar-nav .sidebar-link').forEach(link => {
                    const tabId = link.dataset.tab;
                    link.style.display = this.canViewTab(tabId) ? 'flex' : 'none';
                });
                
                const activeTabEl = document.querySelector('.sidebar-link.bg-gray-100');
                if (activeTabEl && !this.canViewTab(activeTabEl.dataset.tab)) {
                    this.switchTab('home');
                }
                
                // Re-render current tab to apply granular permissions within the panel
                this.renderCurrentTab();
            }
            
            can(action) {
                if (this.state.userRole === 'admin') return true;
                if (!this.state.currentUserData || !this.state.currentUserData.permissions) return false;
                return this.state.currentUserData.permissions[action] === true;
            }

            canViewTab(tabId) {
                const viewPermissions = {
                    home: 'viewHome',
                    reports: 'viewDashboard',
                    stock: 'viewStock',
                    register: 'viewRegister',
                    movements: 'viewMovements',
                    counting: 'viewCounting',
                    audit: 'viewAuditLog',
                    settings: 'viewSettings'
                };
                return this.can(viewPermissions[tabId]);
            }

            getDefaultPermissions() {
                return {
                    viewHome: true, viewDashboard: true, viewStock: true, viewRegister: false,
                    viewMovements: false, viewCounting: false, viewAuditLog: false, viewSettings: false,
                    generateHistoricalReport: false, editStock: false, deleteProduct: false,
                    bulkDeleteProducts: false, exportStockPDF: false, manageCategories: false,
                    manageLocations: false, addProduct: false, bulkImportProducts: false,
                    registerStockOutput: false, transferStock: false, performStockCount: false,
                    manageGeneralSettings: false, manageUsers: false,
                };
            }

            migratePermissions(oldPerms) {
                const newPerms = this.getDefaultPermissions();
                newPerms.viewHome = oldPerms.home ?? true;
                newPerms.viewDashboard = oldPerms.reports ?? false;
                newPerms.generateHistoricalReport = oldPerms.reports ?? false;
                newPerms.viewStock = oldPerms.stock ?? false;
                newPerms.viewRegister = oldPerms.register ?? false;
                newPerms.manageCategories = oldPerms.register ?? false;
                newPerms.addProduct = oldPerms.register ?? false;
                newPerms.bulkImportProducts = oldPerms.register ?? false;
                newPerms.viewMovements = oldPerms.movements ?? false;
                newPerms.registerStockOutput = oldPerms.movements ?? false;
                newPerms.transferStock = oldPerms.movements ?? false;
                newPerms.viewCounting = oldPerms.counting ?? false;
                newPerms.performStockCount = oldPerms.counting ?? false;
                newPerms.viewAuditLog = oldPerms.audit ?? false;
                newPerms.viewSettings = oldPerms.settings ?? false;
                // Admin-level permissions remain false unless explicitly granted
                return newPerms;
            }

            getFriendlyAuthError(code) {
                switch (code) {
                    case 'auth/user-not-found': return 'Nenhum usuário encontrado com este e-mail.';
                    case 'auth/wrong-password': return 'Senha incorreta. Tente novamente.';
                    case 'auth/invalid-email': return 'O formato do e-mail é inválido.';
                    case 'auth/weak-password': return 'A senha deve ter pelo menos 6 caracteres.';
                    case 'auth/email-already-in-use': return 'Este e-mail já está cadastrado.';
                    default: return 'Ocorreu um erro. Tente novamente.';
                }
            }
            
            setupFirestoreRefs() {
                const basePath = `artifacts/${appId}/public/data`;
                this.state.firestoreRefs = {
                    products: collection(this.db, `${basePath}/products`),
                    categories: collection(this.db, `${basePath}/categories`),
                    movements: collection(this.db, `${basePath}/movements`),
                    locations: collection(this.db, `${basePath}/locations`),
                    settings: doc(this.db, `${basePath}/settings/main`),
                    users: collection(this.db, 'users'),
                    auditLog: collection(this.db, `${basePath}/auditLog`),
                    countingHistory: collection(this.db, `${basePath}/countingHistory`),
                };
            }

            initializeAppDataListeners() {
                this.createSnapshotListener(this.state.firestoreRefs.settings, (docSnap) => {
                    if (docSnap.exists()) this.state.itemsPerPage = docSnap.data().itemsPerPage || 10;
                    this.renderCurrentTab();
                });
                this.createSnapshotListener(query(this.state.firestoreRefs.locations), (snapshot) => {
                    this.state.locations = snapshot.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => a.name.localeCompare(b.name));
                    this.renderCurrentTab();
                });
                this.createSnapshotListener(query(this.state.firestoreRefs.categories), (snapshot) => {
                    this.state.categories = snapshot.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => a.name.localeCompare(b.name));
                    this.renderCurrentTab();
                });
                this.createSnapshotListener(query(this.state.firestoreRefs.products), (snapshot) => {
                    this.state.products = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    this.populateProductSelects();
                    this.renderCurrentTab();
                });
                this.createSnapshotListener(query(this.state.firestoreRefs.movements), (snapshot) => {
                    this.state.movements = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    this.renderCurrentTab();
                });
                this.createSnapshotListener(query(this.state.firestoreRefs.countingHistory), (snapshot) => {
                    this.state.countingHistory = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    this.renderCurrentTab();
                });

                if (this.can('manageUsers')) {
                    this.createSnapshotListener(query(this.state.firestoreRefs.users), (snapshot) => {
                        this.state.allUsers = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                        this.renderCurrentTab();
                    });
                }
                if (this.can('viewAuditLog')) {
                    this.createSnapshotListener(query(this.state.firestoreRefs.auditLog), (snapshot) => {
                         this.state.auditLog = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                         this.renderCurrentTab();
                    });
                }
            }

            createSnapshotListener(queryOrRef, callback) {
                const unsubscribe = onSnapshot(queryOrRef, callback, (error) => {
                    console.error("Firestore listener error:", error);
                    this.showAlert("Erro ao sincronizar dados com o servidor.", true);
                });
                this.state.unsubscribers.push(unsubscribe);
            }

            clearAllListeners() {
                this.state.unsubscribers.forEach(unsub => unsub());
                this.state.unsubscribers = [];
            }
            
            async handleFormSubmit(e) {
                e.preventDefault();
                const form = e.target;
                let requiredPermission = null;

                switch(form.id) {
                    case 'add-category-form': requiredPermission = 'manageCategories'; break;
                    case 'add-product-form': requiredPermission = 'addProduct'; break;
                    case 'add-output-form': requiredPermission = 'registerStockOutput'; break;
                    case 'add-location-form': requiredPermission = 'manageLocations'; break;
                    case 'transfer-stock-form': requiredPermission = 'transferStock'; break;
                    case 'save-count-form': requiredPermission = 'performStockCount'; break;
                }

                if (requiredPermission && !this.can(requiredPermission)) {
                    return this.showAlert('Você não tem permissão para realizar esta ação.', true);
                }
                
                this.setLoading(true);
                try {
                    if (form.id === 'add-category-form') await this.handleAddCategory(form);
                    if (form.id === 'add-product-form') await this.handleAddProduct(form);
                    if (form.id === 'add-output-form') await this.handleAddOutput(form);
                    if (form.id === 'add-location-form') await this.handleAddLocation(form);
                    if (form.id === 'transfer-stock-form') await this.handleTransferStock(form);
                    if (form.id === 'save-count-form') await this.handleSaveCount(form);
                } catch (error) {
                    this.showAlert(error.message, true);
                } finally {
                    this.setLoading(false);
                }
            }
            
            handleContentClick(e) {
                const actionCard = e.target.closest('.action-card');
                if (actionCard && actionCard.dataset.tab) {
                    e.preventDefault();
                    if(this.canViewTab(actionCard.dataset.tab)){
                        this.switchTab(actionCard.dataset.tab);
                    } else {
                        this.showAlert('Você não tem permissão para acessar esta área.', true);
                    }
                    return;
                }

                const button = e.target.closest('button');
                if (!button) {
                    const ctaLink = e.target.closest('a#cta-add-product');
                    if (ctaLink && this.can('addProduct')) {
                        e.preventDefault();
                        this.switchTab('register');
                    }
                    return;
                }
                
                if (button.classList.contains('manage-permissions-btn') && this.can('manageUsers')) {
                    const userId = button.dataset.userId;
                    if(userId) this.openPermissionsModal(userId);
                    return;
                }

                if (button.classList.contains('chart-type-btn')) {
                    this.state.dashboardSettings.chartType = button.dataset.type;
                    this.updateDashboardView();
                    return;
                }
                 if (button.classList.contains('save-user-role-btn') && this.can('manageUsers')) {
                    const userId = button.dataset.userId;
                    const selectEl = document.getElementById(`role-select-${userId}`);
                    if (userId && selectEl) {
                        this.handleChangeUserRole(userId, selectEl.value, button);
                    }
                    return;
                }

                if (button.id === 'download-template-btn' && this.can('bulkImportProducts')) {
                    this.handleDownloadTemplate();
                    return;
                }
                
                if (button.id === 'export-report-pdf-btn' && this.can('generateHistoricalReport')) {
                    this.handleExportReportPdf();
                    return;
                }
                
                if (button.id === 'compare-weeks-btn') {
                    this.handleWeeklyComparison();
                    return;
                }
                
                if (button.id === 'export-comparison-excel-btn') {
                    this.handleExportComparisonExcel();
                    return;
                }

                const { action, id } = button.dataset;

                if (action === 'edit' && this.can('editStock')) this.openEditModal(id);
                if (action === 'delete' && this.can('deleteProduct')) this.openDeleteModal(id, 'product');
                if (action === 'delete-category' && this.can('manageCategories')) this.openDeleteModal(id, 'category');
                if (action === 'delete-location' && this.can('manageLocations')) this.openDeleteModal(id, 'location');
                if (button.id === 'bulk-delete-btn' && this.can('bulkDeleteProducts')) this.openDeleteModal(null, 'product', true);
                
                if (action === 'page-prev') { this.state.currentPage--; this.debouncedRenderProducts(); }
                if (action === 'page-next') { this.state.currentPage++; this.debouncedRenderProducts(); }
                if (button.id === 'toggle-advanced-filters') {
                    document.getElementById('advanced-filters-wrapper').classList.toggle('open');
                    button.classList.toggle('open');
                }
                if (button.id === 'clear-filters-btn') this.clearFilters();
                if (button.id === 'generate-report-btn' && this.can('generateHistoricalReport')) this.handleGenerateReport();
                if (button.id === 'print-report-btn') window.print();
                
                if (button.id === 'upload-insert-trigger-btn' && this.can('bulkImportProducts')) document.getElementById('excel-insert-input').click();
                if (button.id === 'export-pdf-btn' && this.can('exportStockPDF')) this.handleExportPdf();
                if (button.id === 'save-settings-btn' && this.can('manageGeneralSettings')) this.handleSaveSettings();
            }
            
            handleContentChange(e) {
             const target = e.target;
             if (['stock-category-filter', 'stock-status-filter', 'date-filter-start', 'date-filter-end'].includes(target.id)) {
                 this.state.currentPage = 1;
                 this.debouncedRenderProducts();
             }
             if (target.id === 'output-product-select') this.handleOutputProductSelection(target.value);
             if (target.id === 'transfer-product-select') this.handleTransferProductSelection(target.value);
             if (target.id === 'transfer-from-location-select') this.handleTransferFromLocationSelection(target.value);
             if (target.id === 'counting-product-select') this.handleProductSelectForCount(target.value);
             
             if (target.id === 'excel-insert-input') {
                 const file = target.files?.[0];
                 const filenameEl = document.getElementById('excel-insert-filename');
                 if(file && filenameEl) {
                     this.handleExcelParse(file, filenameEl);
                 }
             }
             
             if (target.id === 'select-all-checkbox') {
                 this.handleSelectAllChange(e);
             } else if (target.classList.contains('product-checkbox')) {
                 this.handleSingleCheckboxChange(); 
             }
             
             if (target.name === 'output-location') {
                 this.updateOutputQuantityLock();
             }
             
             if (target.id === 'period-selector') {
                 const period = target.value;
                 this.state.dashboardSettings.period = period;
                 const customDateSelector = document.getElementById('custom-date-range-selector');
                 if (customDateSelector) {
                     if (period === 'custom') {
                         customDateSelector.classList.remove('hidden');
                         customDateSelector.classList.add('grid');
                     } else {
                         customDateSelector.classList.add('hidden');
                         customDateSelector.classList.remove('grid');
                         this.updateDashboardView();
                     }
                 }
             }
             
             if (target.id === 'dashboard-date-start' || target.id === 'dashboard-date-end') {
                 this.state.dashboardSettings.startDate = document.getElementById('dashboard-date-start').value;
                 this.state.dashboardSettings.endDate = document.getElementById('dashboard-date-end').value;
                 if (this.state.dashboardSettings.startDate && this.state.dashboardSettings.endDate) {
                     this.updateDashboardView();
                 }
             }
             
             if (target.id === 'start-week-picker' || target.id === 'end-week-picker') {
                this.updateCompareButtonVisibility();
            }
            }
            
            handleSelectAllChange(e) {
                const isChecked = e.target.checked;
                const visibleCheckboxes = document.querySelectorAll('#product-list .product-checkbox');
                
                visibleCheckboxes.forEach(checkbox => {
                    checkbox.checked = isChecked;
                });
                this.updateSelectionState();
            }

            handleSingleCheckboxChange() {
                this.updateSelectionState();
            }

            updateSelectionState() {
                this.state.selectedProducts = Array.from(document.querySelectorAll('#product-list .product-checkbox:checked')).map(cb => cb.dataset.id);
                document.querySelectorAll('#product-table-body tr[data-product-id]').forEach(row => {
                    const id = row.dataset.productId;
                    row.classList.toggle('bg-primary-light', this.state.selectedProducts.includes(id));
                });
                document.querySelectorAll('#product-card-list div[data-product-id]').forEach(card => {
                    const id = card.dataset.productId;
                    card.classList.toggle('bg-primary-light', this.state.selectedProducts.includes(id));
                });
                
                const allVisibleCheckboxes = document.querySelectorAll('#product-list .product-checkbox');
                const selectAllCheckbox = document.getElementById('select-all-checkbox');
                if (selectAllCheckbox) {
                    const allVisibleSelected = allVisibleCheckboxes.length > 0 && Array.from(allVisibleCheckboxes).every(cb => cb.checked);
                    selectAllCheckbox.checked = allVisibleSelected;
                }
                this.renderBulkActionBar();
            }
            async handleSaveEdit(button) {
                if (!this.can('editStock')) return this.showAlert('Você não tem permissão para salvar edições.', true);
                
                const originalContent = button.innerHTML;
                button.disabled = true;
                button.innerHTML = `<i class="fas fa-spinner animate-spin"></i>`;
                
                try {
                    const { self, quantitiesContainer } = this.state.dom.modals.edit;
                    const id = self.dataset.productId;
                    if (!id) throw new Error("ID do produto não encontrado no modal.");

                    const oldProduct = this.state.products.find(p => p.id === id);
                    if (!oldProduct) throw new Error('Produto não encontrado.');

                    const newQuantities = {};
                    let newTotalQuantity = 0;
                    this.state.locations.forEach(loc => {
                        const qtyInput = quantitiesContainer.querySelector(`#edit-qty-${loc.id}`);
                        const qty = qtyInput ? (parseInt(qtyInput.value, 10) || 0) : 0;
                        newQuantities[loc.id] = qty;
                        newTotalQuantity += qty;
                    });
                    
                    const newMinStockInput = quantitiesContainer.querySelector('#edit-min-stock');
                    const newMinStock = parseInt(newMinStockInput.value, 10);
                    if (isNaN(newMinStock) || newMinStock < 0) {
                        throw new Error("O estoque mínimo deve ser um número válido e não negativo.");
                    }

                    const updateData = {
                        quantities: newQuantities,
                        totalQuantity: newTotalQuantity,
                        minStock: newMinStock,
                    };

                    await updateDoc(doc(this.state.firestoreRefs.products, id), updateData);
                    
                    this.logAudit('PRODUCT_EDIT', { 
                        productName: oldProduct.name,
                        details: `Estoque alterado. Mínimo: ${oldProduct.minStock} -> ${newMinStock}. Total: ${oldProduct.totalQuantity} -> ${newTotalQuantity}.`
                    });
                    
                    this.showAlert('Produto atualizado.');
                    this.closeEditModal();
                } catch (error) {
                    this.showAlert(`Não foi possível salvar: ${error.message}`, true);
                } finally {
                    button.disabled = false;
                    button.innerHTML = originalContent;
                }
            }

            async handleDelete() {
                const { id, type, isBulk } = this.state.deleteQueue;
                if (!type) return;

                if (isBulk && !this.can('bulkDeleteProducts')) return this.showAlert('Você não tem permissão para excluir em massa.', true);
                if (!isBulk && type === 'product' && !this.can('deleteProduct')) return this.showAlert('Você não tem permissão para excluir produtos.', true);
                if (!isBulk && type === 'category' && !this.can('manageCategories')) return this.showAlert('Você não tem permissão para excluir categorias.', true);
                if (!isBulk && type === 'location' && !this.can('manageLocations')) return this.showAlert('Você não tem permissão para excluir localidades.', true);

                this.setLoading(true);
                try {
                    if (isBulk) {
                        const batch = writeBatch(this.db);
                        const deletedProductNames = [];
                        this.state.selectedProducts.forEach(productId => {
                            const product = this.state.products.find(p => p.id === productId);
                            if (product) deletedProductNames.push(product.name);
                            batch.delete(doc(this.state.firestoreRefs.products, productId));
                        });
                        await batch.commit();
                        this.logAudit('BULK_PRODUCT_DELETE', { 
                            count: deletedProductNames.length, 
                            productNames: deletedProductNames 
                        });
                        this.showAlert(`${this.state.selectedProducts.length} produtos excluídos.`);
                        this.state.selectedProducts = [];
                        this.updateSelectionState(); 
                    } else if (id) {
                        if (type === 'product') {
                            const product = this.state.products.find(p => p.id === id);
                            await deleteDoc(doc(this.state.firestoreRefs.products, id));
                            if (product) this.logAudit('PRODUCT_DELETE', { productName: product.name });
                            this.showAlert('Produto excluído.');
                        } else if (type === 'category') {
                            if (this.state.products.some(p => p.category === id)) throw new Error(`Existem produtos nesta categoria. Não é possível excluí-la.`);
                            const category = this.state.categories.find(c => c.id === id);
                            await deleteDoc(doc(this.state.firestoreRefs.categories, id));
                            if (category) this.logAudit('CATEGORY_DELETE', { categoryName: category.name });
                            this.showAlert('Categoria excluída.');
                        } else if (type === 'location') {
                            if (this.state.products.some(p => p.quantities[id] && p.quantities[id] > 0)) {
                                throw new Error('Esta localidade está em uso por produtos com estoque e não pode ser excluída.');
                            }
                            const location = this.state.locations.find(l => l.id === id);
                            await deleteDoc(doc(this.state.firestoreRefs.locations, id));
                            if(location) this.logAudit('LOCATION_DELETE', { locationName: location.name });
                            this.showAlert('Localidade excluída.');
                        }
                    }
                } catch (error) {
                    this.showAlert(error.message, true);
                } finally {
                    this.closeDeleteModal();
                    this.setLoading(false);
                }
            }
            
            async logAudit(action, details = {}) {
                if (!this.state.firestoreRefs?.auditLog || !this.state.currentUser) return;
                try {
                    await addDoc(this.state.firestoreRefs.auditLog, {
                        action,
                        details,
                        userEmail: this.state.currentUser.email,
                        timestamp: serverTimestamp()
                    });
                } catch (error) {
                    console.error("Falha ao registrar log de auditoria:", error);
                }
            }
            
            async handleAddCategory(form) {
                const name = form.querySelector('#category-name').value.trim();
                if (name && this.state.firestoreRefs) {
                    await addDoc(this.state.firestoreRefs.categories, { name });
                    this.logAudit('CATEGORY_CREATE', { categoryName: name });
                    form.reset();
                    this.showAlert('Categoria adicionada!');
                } else {
                    throw new Error("Nome da categoria inválido.");
                }
            }
            async handleAddLocation(form) {
                const name = form.querySelector('#location-name').value.trim();
                if (name && this.state.firestoreRefs) {
                    const id = name.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '');
                    if (this.state.locations.some(loc => loc.id === id)) {
                        throw new Error("Uma localidade com nome similar já existe.");
                    }
                    await setDoc(doc(this.state.firestoreRefs.locations, id), { name });
                    this.logAudit('LOCATION_CREATE', { locationName: name });
                    form.reset();
                    this.showAlert('Localidade adicionada!');
                } else {
                    throw new Error("Nome da localidade inválido.");
                }
            }
            async handleAddProduct(form) {
                const minStock = parseInt(form.querySelector('#product-min-stock').value, 10);
                if (isNaN(minStock) || minStock < 1) {
                    throw new Error("O estoque mínimo deve ser um número maior que zero.");
                }
                
                const quantities = {};
                let totalQuantity = 0;
                this.state.locations.forEach(loc => {
                    const input = form.querySelector(`#qty-${loc.id}`);
                    if (input) {
                        const qty = parseInt(input.value, 10) || 0;
                        quantities[loc.id] = qty;
                        totalQuantity += qty;
                    }
                });
                const productData = {
                    name: form.querySelector('#product-name').value.trim(),
                    category: form.querySelector('#product-category-select').value,
                    minStock,
                    unit: form.querySelector('#product-unit-select').value,
                    quantities,
                    totalQuantity,
                    createdAt: serverTimestamp()
                };
                if (productData.name && productData.category && productData.unit) {
                    const newProdRef = await addDoc(this.state.firestoreRefs.products, productData);
                    this.logAudit('PRODUCT_CREATE', { productName: productData.name, initialStock: totalQuantity });
                    if (totalQuantity > 0) {
                        await this.logMovement(newProdRef.id, 'entrada', totalQuantity, 'Criação de Produto');
                    }
                    form.reset();
                    this.showAlert('Produto adicionado!');
                } else {
                    throw new Error("Dados do produto inválidos. Verifique nome, categoria e unidade.");
                }
            }
            async handleAddOutput(form) {
                const productId = form.querySelector('#output-product-select').value;
                const product = this.state.products.find(p => p.id === productId);
                const quantity = parseInt(form.querySelector('#output-quantity').value, 10);
                const motive = form.querySelector('#output-motive-select').value;
                const locationId = form.querySelector('input[name="output-location"]:checked')?.value;
                const location = this.state.locations.find(l => l.id === locationId);

                if (!product || isNaN(quantity) || quantity <= 0 || !motive || !location) {
                    throw new Error("Preencha todos os campos corretamente.");
                }

                await runTransaction(this.db, async (transaction) => {
                    const productRef = doc(this.state.firestoreRefs.products, productId);
                    const productDoc = await transaction.get(productRef);
                    if (!productDoc.exists()) throw new Error("Produto não encontrado.");
                    const productData = productDoc.data();
                    const currentQuantityInLocation = productData.quantities[locationId] || 0;
                    if (currentQuantityInLocation < quantity) throw new Error(`Estoque insuficiente em ${location.name}. Disponível: ${currentQuantityInLocation}.`);
                    const newQuantities = { ...productData.quantities, [locationId]: currentQuantityInLocation - quantity };
                    const newTotalQuantity = Object.values(newQuantities).reduce((sum, qty) => sum + qty, 0);
                    transaction.update(productRef, { quantities: newQuantities, totalQuantity: newTotalQuantity });
                    const movementRef = doc(collection(this.db, this.state.firestoreRefs.movements.path));
                    transaction.set(movementRef, { productId, type: 'saida', quantity, motive, location: locationId, date: serverTimestamp() });
                });

                this.logAudit('STOCK_OUTPUT', { 
                    productName: product.name, 
                    quantity, 
                    locationName: location.name, 
                    motive 
                });
                this.showAlert('Saída registrada com sucesso.');
                form.reset();
                this.handleOutputProductSelection('');
            }
            async handleTransferStock(form) {
                const productId = form.querySelector('#transfer-product-select').value;
                const product = this.state.products.find(p => p.id === productId);
                const fromLocationId = form.querySelector('#transfer-from-location-select').value;
                const fromLocation = this.state.locations.find(l => l.id === fromLocationId);
                const toLocationId = form.querySelector('#transfer-to-location-select').value;
                const toLocation = this.state.locations.find(l => l.id === toLocationId);
                const quantity = parseInt(form.querySelector('#transfer-quantity').value, 10);

                if (!product || !fromLocation || !toLocation || isNaN(quantity) || quantity <= 0) {
                    throw new Error("Preencha todos os campos do formulário de transferência.");
                }
                if (fromLocationId === toLocationId) {
                    throw new Error("A localidade de origem e destino não podem ser as mesmas.");
                }

                await runTransaction(this.db, async (transaction) => {
                    const productRef = doc(this.state.firestoreRefs.products, productId);
                    const productDoc = await transaction.get(productRef);
                    if (!productDoc.exists()) throw new Error("Produto não encontrado.");
                    
                    const productData = productDoc.data();
                    const currentQuantities = productData.quantities || {};
                    const fromQty = currentQuantities[fromLocationId] || 0;

                    if (fromQty < quantity) {
                        throw new Error(`Estoque insuficiente em '${fromLocation.name}'. Disponível: ${fromQty}.`);
                    }

                    const toQty = currentQuantities[toLocationId] || 0;
                    const newQuantities = {
                        ...currentQuantities,
                        [fromLocationId]: fromQty - quantity,
                        [toLocationId]: toQty + quantity
                    };

                    transaction.update(productRef, { quantities: newQuantities });
                });

                this.logAudit('STOCK_TRANSFER', {
                    productName: product.name,
                    quantity,
                    from: fromLocation.name,
                    to: toLocation.name
                });
                this.showAlert('Transferência realizada com sucesso!');
                form.reset();
                this.handleTransferProductSelection(''); 
            }
            async logMovement(productId, type, quantity, motive, locationId = null) {
                if (!this.state.firestoreRefs) return;
                const movementData = { 
                    productId, type, quantity, motive, 
                    date: serverTimestamp() 
                };
                if (locationId) {
                    movementData.location = locationId;
                }
                await addDoc(this.state.firestoreRefs.movements, movementData);
            }
            renderProducts() {
                const stockPanel = document.getElementById('panel-stock');
                if (!stockPanel) return;
                
                const productTableHeaderRow = stockPanel.querySelector('#product-table-header-row');
                if(productTableHeaderRow) {
                    const tableCheckboxHeader = this.can('bulkDeleteProducts') ? `<th class="p-3 w-4"><input type="checkbox" id="select-all-checkbox" class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary"></th>` : `<th class="p-3 w-4"></th>`;
                    const tableActionsHeader = (this.can('editStock') || this.can('deleteProduct')) ? `<th class="p-3 text-right text-gray-900 whitespace-nowrap font-medium">Ações</th>` : `<th></th>`;
                    const locationHeaders = this.state.locations.map(loc => `<th class="p-3 text-center text-gray-900 whitespace-nowrap font-medium">${loc.name}</th>`).join('');

                    productTableHeaderRow.innerHTML = `
                        ${tableCheckboxHeader}
                        <th class="p-3 text-left text-gray-900 sticky left-0 bg-white hover:bg-slate-50 whitespace-nowrap font-medium">Produto</th>
                        <th class="p-3 text-center text-gray-900 whitespace-nowrap font-medium">Categoria</th>
                        <th class="p-3 text-center text-gray-900 font-bold whitespace-nowrap">Total</th>
                        ${locationHeaders}
                        ${tableActionsHeader}
                    `;
                }

                const productListContainer = stockPanel.querySelector('#product-list-container');
                const productTableBody = stockPanel.querySelector('#product-table-body');
                const productCardList = stockPanel.querySelector('#product-card-list');
                const emptyState = stockPanel.querySelector('#empty-state');

                if (!productListContainer || !productTableBody || !productCardList || !emptyState) return;

                const filteredProducts = this.getFilteredProducts();
                
                if (filteredProducts.length === 0) {
                    productListContainer.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                    if (this.state.products.length === 0) {
                         emptyState.innerHTML = `<div class="text-center py-12"><i class="fas fa-box-open fa-4x text-gray-400"></i><p class="mt-4 text-gray-500">Nenhum produto cadastrado ainda.</p>${this.can('addProduct') ? `<p class="mt-2 text-gray-500">Que tal <a href="#" id="cta-add-product" class="font-semibold text-primary hover:underline">adicionar o primeiro</a>?</p>` : ''}</div>`;
                    } else {
                         emptyState.innerHTML = `<div class="text-center py-12"><i class="fas fa-search-minus fa-4x text-gray-400"></i><p class="mt-4 text-gray-500">Nenhum produto encontrado com os filtros atuais.</p><p class="mt-2 text-gray-500">Tente ajustar sua busca ou <button id="clear-filters-btn" class="font-semibold text-primary hover:underline">limpar os filtros</button>.</p></div>`;
                    }
                } else {
                    emptyState.classList.add('hidden');
                    productListContainer.classList.remove('hidden');

                    const paginatedProducts = filteredProducts.slice((this.state.currentPage - 1) * this.state.itemsPerPage, this.state.currentPage * this.state.itemsPerPage);
                    
                    productTableBody.innerHTML = paginatedProducts.map(p => this.renderProductRow(p)).join('');
                    productCardList.innerHTML = paginatedProducts.map(p => this.renderProductCard(p)).join('');
                }
                this.renderPaginationControls(filteredProducts.length);
                this.updateSelectionState();
            }
            renderProductRow(product) {
                const category = this.state.categories.find(c => c.id === product.category);
                const isLowStock = product.minStock > 0 && product.totalQuantity <= product.minStock;
                const isSelected = this.state.selectedProducts.includes(product.id);
                
                const quantitiesHtml = this.state.locations.map(loc => `<td class="p-3 text-center text-gray-800">${(product.quantities || {})[loc.id] || 0}</td>`).join('');
                
                let actionButtons = '';
                if (this.can('editStock')) {
                    actionButtons += `<button data-action="edit" data-id="${product.id}" class="text-primary hover:text-primary-hover p-2"><i class="fas fa-edit"></i></button>`;
                }
                 if (this.can('deleteProduct')) {
                    actionButtons += `<button data-action="delete" data-id="${product.id}" class="text-danger hover:text-danger-hover p-2"><i class="fas fa-trash"></i></button>`;
                }

                const checkbox = this.can('bulkDeleteProducts') ? `<td class="p-3 text-center"><input type="checkbox" class="product-checkbox h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary" data-id="${product.id}" ${isSelected ? 'checked' : ''}></td>` : '<td class="p-3 w-4"></td>';

                return `
                    <tr class="border-b border-gray-200 hover:bg-slate-50 transition-colors ${isLowStock ? 'low-stock-warning' : ''} ${isSelected ? 'bg-primary-light' : ''}" data-product-id="${product.id}">
                        ${checkbox}
                        <td class="p-3 font-medium text-gray-900 sticky left-0 bg-white hover:bg-slate-50">${product.name} ${isLowStock ? `<i class="fas fa-exclamation-triangle text-warning ml-1" title="Estoque baixo!"></i>` : ''}</td>
                        <td class="p-3 text-center text-gray-800">${category?.name || 'N/A'}</td>
                        <td class="p-3 text-center font-bold text-gray-900">${product.totalQuantity || 0}</td>
                        ${quantitiesHtml}
                        <td class="p-3 text-right">${actionButtons}</td>
                    </tr>`;
            }
            renderProductCard(product) {
                const category = this.state.categories.find(c => c.id === product.category);
                const isLowStock = product.minStock > 0 && product.totalQuantity <= product.minStock;
                const isSelected = this.state.selectedProducts.includes(product.id);
                
                const quantitiesHtml = this.state.locations.map(loc => {
                    const qty = (product.quantities || {})[loc.id] || 0;
                    if (qty === 0) return '';
                    return `
                        <div class="flex justify-between items-start gap-2 text-sm">
                            <span class="text-gray-600 break-words">${loc.name}</span>
                            <span class="font-semibold text-gray-900 flex-shrink-0">${qty}</span>
                        </div>
                    `;
                }).join('');

                let actionButtons = '';
                 if (this.can('editStock')) {
                    actionButtons += `<button data-action="edit" data-id="${product.id}" class="text-primary hover:text-primary-hover p-2 text-sm"><i class="fas fa-edit mr-1"></i> Editar</button>`;
                }
                 if (this.can('deleteProduct')) {
                    actionButtons += `<button data-action="delete" data-id="${product.id}" class="text-danger hover:text-danger-hover p-2 text-sm"><i class="fas fa-trash mr-1"></i> Excluir</button>`;
                }

                const checkbox = this.can('bulkDeleteProducts') ? `<input type="checkbox" class="product-checkbox h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary" data-id="${product.id}" ${isSelected ? 'checked' : ''}>` : '';
                
                return `
                    <div class="border-b border-gray-200 p-4 ${isSelected ? 'bg-primary-light' : ''}" data-product-id="${product.id}">
                        <div class="flex justify-between items-start gap-4">
                            <div class="flex items-start gap-3">
                                ${checkbox}
                                <div>
                                    <p class="font-bold text-gray-900">${product.name} ${isLowStock ? `<i class="fas fa-exclamation-triangle text-warning ml-1" title="Estoque baixo!"></i>` : ''}</p>
                                    <p class="text-sm text-gray-600">${category?.name || 'N/A'}</p>
                                </div>
                            </div>
                            <div class="text-right flex-shrink-0">
                                <p class="text-lg font-bold">${product.totalQuantity || 0}</p>
                                <p class="text-xs text-gray-500">Total</p>
                            </div>
                        </div>
                        <div class="mt-4 pt-3 border-t border-gray-200 ml-7 space-y-1">
                            ${quantitiesHtml}
                        </div>
                        <div class="ml-7">${actionButtons}</div>
                    </div>
                `;
            }
            renderCategories() {
                const categoryList = document.getElementById('category-list');
                if (categoryList) {
                    categoryList.innerHTML = this.state.categories.length > 0 ? this.state.categories.map(cat => {
                        const isUsed = this.state.products.some(p => p.category === cat.id);
                        const deleteButton = this.can('manageCategories') ? `
                            <button data-action="delete-category" data-id="${cat.id}" class="text-danger hover:text-danger-hover disabled:text-gray-400 disabled:cursor-not-allowed" ${isUsed ? 'disabled title="Categoria em uso"' : ''}>
                                <i class="fas fa-times"></i>
                            </button>
                        ` : '';
                        return `
                            <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                                <span class="text-gray-900">${cat.name}</span>
                                ${deleteButton}
                            </div>`;
                    }).join('') : '<p class="text-sm text-gray-500">Nenhuma categoria.</p>';
                }
                
                const selectsToUpdate = [
                    { id: 'product-category-select', defaultOption: '<option value="">Selecione...</option>' },
                    { id: 'stock-category-filter', defaultOption: '<option value="all">Todas</option>' }
                ];

                selectsToUpdate.forEach(selectInfo => {
                    const selectEl = document.getElementById(selectInfo.id);
                    if (selectEl) {
                        const currentValue = selectEl.value;
                        let options = selectInfo.defaultOption;
                        options += this.state.categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
                        selectEl.innerHTML = options;
                        if (Array.from(selectEl.options).some(opt => opt.value === currentValue)) {
                            selectEl.value = currentValue;
                        } else {
                            if (selectInfo.id === 'stock-category-filter') selectEl.value = 'all';
                            else selectEl.value = '';
                        }
                    }
                });
            }
            renderSettings() {
                const locationsList = document.getElementById('location-list');
                if (locationsList) {
                    locationsList.innerHTML = this.state.locations.length > 0 ? this.state.locations.map(loc => {
                        const isUsed = this.state.products.some(p => p.quantities && p.quantities[loc.id] > 0);
                         const deleteButton = this.can('manageLocations') ? `
                            <button data-action="delete-location" data-id="${loc.id}" class="text-danger hover:text-danger-hover disabled:text-gray-400 disabled:cursor-not-allowed" ${isUsed ? 'disabled title="Localidade em uso"' : ''}>
                                <i class="fas fa-times"></i>
                            </button>
                        ` : '';
                        return `
                                <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                                    <span class="text-gray-900">${loc.name}</span>
                                    ${deleteButton}
                                </div>
                            `;
                    }).join('') : '<p class="text-sm text-gray-500">Nenhuma localidade cadastrada.</p>';
                }
                const itemsPerPageInput = document.getElementById('items-per-page-input');
                if (itemsPerPageInput) {
                    itemsPerPageInput.value = this.state.itemsPerPage;
                    itemsPerPageInput.disabled = !this.can('manageGeneralSettings');
                }
                const saveSettingsBtn = document.getElementById('save-settings-btn');
                if (saveSettingsBtn) {
                    saveSettingsBtn.style.display = this.can('manageGeneralSettings') ? 'block' : 'none';
                }

                const userManagementSection = document.getElementById('user-management-section');
                if (userManagementSection) {
                    userManagementSection.style.display = this.can('manageUsers') ? 'block' : 'none';
                    if (this.can('manageUsers')) {
                        this.renderUserManagement();
                    }
                }
            }
             renderUserManagement() {
                if (!this.can('manageUsers')) return; 
                const userListTbody = document.getElementById('user-list-tbody');
                if (!userListTbody) return;

                userListTbody.innerHTML = this.state.allUsers.map(user => {
                    const isCurrentUser = this.state.currentUser && this.state.currentUser.uid === user.id;
                    const roleSelectDisabled = isCurrentUser; 

                    return `
                        <tr class="border-b border-gray-200 hover:bg-gray-50">
                            <td class="p-3 text-sm text-gray-700">${user.email}</td>
                            <td class="p-3 text-sm text-gray-700">
                                <select id="role-select-${user.id}" class="w-full p-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:ring-primary focus:border-primary" ${roleSelectDisabled ? 'disabled' : ''}>
                                    <option value="viewer" ${user.role === 'viewer' ? 'selected' : ''}>Visualizador</option>
                                    <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Administrador</option>
                                </select>
                            </td>
                            <td class="p-3 text-right">
                                ${!isCurrentUser ? `
                                <button data-user-id="${user.id}" class="save-user-role-btn bg-primary text-white text-xs font-semibold py-1 px-3 rounded-md hover:bg-primary-hover transition">
                                    Salvar Papel
                                </button>
                                <button data-user-id="${user.id}" class="manage-permissions-btn text-indigo-600 hover:text-indigo-800 text-xs font-semibold py-1 px-3 rounded-md ml-2 border border-indigo-200 hover:bg-indigo-50">
                                    Permissões
                                </button>
                                ` : '<span class="text-xs text-gray-500 italic">Você</span>'}
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            async handleChangeUserRole(userId, newRole, button) {
                if (!this.can('manageUsers')) {
                    return this.showAlert('Apenas administradores podem alterar papéis.', true);
                }
                if (this.state.currentUser && this.state.currentUser.uid === userId) {
                    return this.showAlert('Você não pode alterar seu próprio papel através desta interface.', true);
                }
                
                const userToChange = this.state.allUsers.find(u => u.id === userId);
                if (!userToChange) return;

                const originalContent = button.innerHTML;
                button.disabled = true;
                button.innerHTML = `<i class="fas fa-spinner animate-spin"></i>`;
                
                try {
                    const userRef = doc(this.db, 'users', userId);
                    await updateDoc(userRef, { role: newRole });
                    this.logAudit('USER_ROLE_CHANGE', {
                        targetUserEmail: userToChange.email,
                        oldRole: userToChange.role,
                        newRole: newRole
                    });
                    this.showAlert(`Papel do usuário atualizado para ${newRole}.`);
                } catch (error) {
                    console.error("Erro ao atualizar papel do usuário:", error);
                    this.showAlert('Não foi possível atualizar o papel do usuário.', true);
                } finally {
                    button.disabled = false;
                    button.innerHTML = originalContent;
                }
            }
            openPermissionsModal(userId) {
                const user = this.state.allUsers.find(u => u.id === userId);
                if (!user) return this.showAlert('Usuário não encontrado.', true);

                const { self, userEmail, checkboxContainer } = this.state.dom.modals.permissions;
                self.dataset.userId = userId;
                userEmail.textContent = user.email;

                const PERMISSIONS_STRUCTURE = [
                    {
                        group: 'Geral',
                        perms: [
                            { id: 'viewHome', name: 'Acessar Início' },
                            { id: 'viewDashboard', name: 'Acessar Dashboard' },
                            { id: 'viewAuditLog', name: 'Ver Log de Auditoria' },
                        ]
                    },
                    {
                        group: 'Estoque',
                        perms: [
                            { id: 'viewStock', name: 'Visualizar Estoque' },
                            { id: 'editStock', name: 'Editar Estoque (Qtd, Mínimo)' },
                            { id: 'deleteProduct', name: 'Excluir Produtos' },
                            { id: 'bulkDeleteProducts', name: 'Excluir em Massa' },
                            { id: 'exportStockPDF', name: 'Exportar PDF do Estoque' },
                        ]
                    },
                    {
                        group: 'Cadastros',
                        perms: [
                            { id: 'viewRegister', name: 'Acessar Aba de Cadastros' },
                            { id: 'addProduct', name: 'Adicionar Novos Produtos' },
                            { id: 'manageCategories', name: 'Gerenciar Categorias' },
                            { id: 'bulkImportProducts', name: 'Importar Produtos via Excel' },
                        ]
                    },
                    {
                        group: 'Operações',
                        perms: [
                             { id: 'viewMovements', name: 'Acessar Movimentações' },
                             { id: 'registerStockOutput', name: 'Registrar Saídas' },
                             { id: 'transferStock', name: 'Realizar Transferências' },
                             { id: 'viewCounting', name: 'Acessar Contagem' },
                             { id: 'performStockCount', name: 'Salvar Novas Contagens' },
                        ]
                    },
                     {
                        group: 'Configurações',
                        perms: [
                             { id: 'viewSettings', name: 'Acessar Configurações' },
                             { id: 'manageLocations', name: 'Gerenciar Localidades' },
                             { id: 'manageGeneralSettings', name: 'Alterar Conf. Gerais' },
                             { id: 'manageUsers', name: 'Gerenciar Usuários e Permissões' },
                        ]
                    }
                ];
                
                const userPermissions = user.permissions || this.getDefaultPermissions();
                const isTargetAdmin = user.role === 'admin';

                checkboxContainer.innerHTML = PERMISSIONS_STRUCTURE.map(group => `
                    <div class="border-t pt-4">
                        <h4 class="font-semibold text-gray-800 mb-2">${group.group}</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2">
                            ${group.perms.map(perm => `
                                <label class="flex items-center space-x-3 p-2 rounded-md hover:bg-gray-50">
                                    <input type="checkbox" data-perm-id="${perm.id}" class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary" 
                                        ${(userPermissions[perm.id] || isTargetAdmin) ? 'checked' : ''} 
                                        ${isTargetAdmin ? 'disabled' : ''}>
                                    <span class="${isTargetAdmin ? 'text-gray-500' : 'text-gray-800'} text-sm">${perm.name}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `).join('');

                if (isTargetAdmin) {
                    const note = document.createElement('p');
                    note.className = 'text-xs text-gray-500 italic mt-4';
                    note.textContent = 'Administradores sempre têm acesso a todas as abas e funcionalidades.';
                    checkboxContainer.appendChild(note);
                }
                
                self.classList.replace('hidden', 'flex');
            }
            closePermissionsModal() {
                this.state.dom.modals.permissions.self.classList.replace('flex', 'hidden');
            }
            async handleSavePermissions() {
                if (!this.can('manageUsers')) return;
                const { self, checkboxContainer } = this.state.dom.modals.permissions;
                const userId = self.dataset.userId;
                if (!userId) return;

                const userToChange = this.state.allUsers.find(u => u.id === userId);
                if (!userToChange) return;

                const newPermissions = this.getDefaultPermissions();
                checkboxContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    newPermissions[checkbox.dataset.permId] = checkbox.checked;
                });

                this.setLoading(true);
                try {
                    const userRef = doc(this.db, 'users', userId);
                    await updateDoc(userRef, { permissions: newPermissions });
                    this.logAudit('USER_PERMISSIONS_CHANGE', {
                        targetUserEmail: userToChange.email,
                        newPermissions: Object.keys(newPermissions).filter(p => newPermissions[p])
                    });
                    this.showAlert('Permissões do usuário atualizadas.');
                    this.closePermissionsModal();
                } catch (error) {
                    console.error('Erro ao salvar permissões:', error);
                    this.showAlert('Não foi possível salvar as permissões.', true);
                } finally {
                    this.setLoading(false);
                }
            }
            updateRegisterForm() {
                const container = document.getElementById('add-product-form-locations-container');
                if (container) {
                    container.innerHTML = this.state.locations.map(loc => 
                        `<label class="block">
                            <span class="text-gray-700">${loc.name}</span>
                            <input type="number" id="qty-${loc.id}" name="qty-${loc.id}" min="0" value="0" class="mt-1 block w-full rounded-md bg-white border border-gray-300 focus:border-primary focus:bg-white focus:ring-primary">
                        </label>`
                    ).join('');
                }
            }
            populateProductSelects() {
                const selects = ['output-product-select', 'transfer-product-select', 'counting-product-select', 'report-category-filter'];
                const sortedProducts = [...this.state.products].sort((a,b) => a.name.localeCompare(b.name));
                const productOptions = '<option value="">Selecione um produto...</option>' + sortedProducts.map(p => `<option value="${p.id}">${p.name}</option>`).join('');

                const categoryOptions = '<option value="all">Todas as Categorias</option>' + this.state.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

                selects.forEach(selectId => {
                    const selectEl = document.getElementById(selectId);
                    if (!selectEl) return;
                    
                    if (selectId === 'report-category-filter') {
                        selectEl.innerHTML = categoryOptions;
                        return;
                    }

                    const currentValue = selectEl.value;
                    selectEl.innerHTML = productOptions;
                    if (Array.from(selectEl.options).some(opt => opt.value === currentValue)) {
                        selectEl.value = currentValue;
                    } else {
                        selectEl.value = "";
                        if (selectId === 'output-product-select') this.handleOutputProductSelection('');
                        if (selectId === 'transfer-product-select') this.handleTransferProductSelection('');
                        if (selectId === 'counting-product-select') this.handleProductSelectForCount('');
                    }
                });
            }
            showAlert(message, isError = false) {
                Toastify({
                    text: message, duration: 3000, newWindow: true, close: true, gravity: "top", position: "right", stopOnFocus: true,
                    style: { background: isError ? 'linear-gradient(to right, #ef4444, #dc2626)' : 'linear-gradient(to right, #22c55e, #16a34a)', borderRadius: '8px', fontSize: '14px', padding: '12px 20px' },
                    onClick: function(){}
                }).showToast();
            }
            toggleSidebar(show) {
                const { menu, overlay } = this.state.dom.sidebar;
                menu.classList.toggle('-translate-x-full', !show);
                overlay.classList.toggle('hidden', !show);
            }
            switchTab(tabId) {
                if (!this.state.isAuthReady) {
                    return;
                }

                if (!this.canViewTab(tabId)) {
                    this.showAlert('Você não tem permissão para acessar esta aba.', true);
                    return;
                }

                document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
                const panelToShow = document.getElementById(`panel-${tabId}`);
                if (panelToShow) panelToShow.classList.remove('hidden');
                
                document.querySelectorAll('.sidebar-link').forEach(l => l.classList.toggle('bg-gray-100', l.dataset.tab === tabId));
                
                this.renderCurrentTab();
            }
            renderCurrentTab() {
                if (!this.state.isAuthReady) return;

                const activeTabEl = document.querySelector('.sidebar-link.bg-gray-100');
                if (!activeTabEl) return;
                
                const tabId = activeTabEl.dataset.tab;

                switch(tabId) {
                    case 'home': this.renderHomeTab(); break;
                    case 'stock': this.renderCategories(); this.debouncedRenderProducts(); break;
                    case 'reports': this.renderDashboard(); this.populateProductSelects(); break;
                    case 'register': this.renderCategories(); this.updateRegisterForm(); break;
                    case 'movements': this.populateProductSelects(); break;
                    case 'counting': this.renderCountingTab(); break;
                    case 'settings': this.renderSettings(); break;
                    case 'audit': this.renderAuditLog(); break;
                }
            }
            openEditModal(productId) {
                const product = this.state.products.find(p => p.id === productId);
                if (!product) return this.showAlert('Produto não encontrado.', true);
                const { self, productName, quantitiesContainer } = this.state.dom.modals.edit;
                self.dataset.productId = productId;
                productName.textContent = product.name;
                const productQuantities = product.quantities || {};
                
                const quantitiesHtml = this.state.locations.map(loc => `
                    <div>
                        <label for="edit-qty-${loc.id}" class="block text-sm font-medium text-gray-700">${loc.name}</label>
                        <input type="number" id="edit-qty-${loc.id}" value="${productQuantities[loc.id] || 0}" min="0" class="mt-1 block w-full rounded-md bg-white border border-gray-300 focus:border-primary focus:bg-white focus:ring-primary">
                    </div>
                `).join('');

                const minStockHtml = `
                    <div class="col-span-2">
                         <label for="edit-min-stock" class="block text-sm font-medium text-gray-700">Estoque Mínimo</label>
                         <input type="number" id="edit-min-stock" value="${product.minStock || 0}" min="0" class="mt-1 block w-full rounded-md bg-white border border-gray-300 focus:border-primary focus:bg-white focus:ring-primary">
                    </div>
                `;

                quantitiesContainer.innerHTML = `<div class="grid grid-cols-2 gap-4">${quantitiesHtml}${minStockHtml}</div>`;
                self.classList.replace('hidden', 'flex');
            }
            closeEditModal() { this.state.dom.modals.edit.self.classList.replace('flex', 'hidden'); }
            openDeleteModal(id, type, isBulk = false) {
                this.state.deleteQueue = { id, type, isBulk };
                const { self, text } = this.state.dom.modals.delete;
                if (isBulk) {
                    text.textContent = `Tem certeza que deseja excluir os ${this.state.selectedProducts.length} produtos selecionados? Esta ação não pode ser desfeita.`;
                } else {
                    let itemName = '';
                    if (type === 'product') itemName = this.state.products.find(p => p.id === id)?.name;
                    else if (type === 'category') itemName = this.state.categories.find(c => c.id === id)?.name;
                    else if (type === 'location') itemName = this.state.locations.find(l => l.id === id)?.name;
                    text.textContent = `Tem certeza que deseja excluir "${itemName || 'item desconhecido'}"? Esta ação não pode ser desfeita.`;
                }
                self.classList.replace('hidden', 'flex');
            }
            closeDeleteModal() {
                this.state.dom.modals.delete.self.classList.replace('flex', 'hidden');
                this.state.deleteQueue = { id: null, type: null, isBulk: false };
            }
            renderDashboard() {
                const reportsPanel = document.getElementById('panel-reports');
                if (!reportsPanel || reportsPanel.classList.contains('hidden')) return;
                
                this.updateDashboardView();
                this.renderLowStockAlerts();
                this.renderTopMovements();
            }
            updateDashboardView() {
                const reportsPanel = document.getElementById('panel-reports');
                if (!reportsPanel || reportsPanel.classList.contains('hidden')) return;

                const { chartType } = this.state.dashboardSettings;
                document.querySelectorAll('.chart-type-btn').forEach(btn => {
                    btn.classList.toggle('bg-primary', btn.dataset.type === chartType);
                    btn.classList.toggle('text-white', btn.dataset.type === chartType);
                    btn.classList.toggle('bg-white', btn.dataset.type !== chartType);
                    btn.classList.toggle('text-gray-700', btn.dataset.type !== chartType);
                });
                this.renderMovementsChart();
            }
            renderMovementsChart() {
                const ctx = document.getElementById('movements-chart')?.getContext('2d');
                if (!ctx) return;
                
                const { chartType, period } = this.state.dashboardSettings;
                const today = new Date(); today.setHours(23, 59, 59, 999);
                let startDate = new Date(); startDate.setHours(0, 0, 0, 0);
                let endDate = new Date(today);

                switch (period) {
                    case '7days': startDate.setDate(today.getDate() - 6); break;
                    case '30days': startDate.setDate(today.getDate() - 29); break;
                    case 'this_month': startDate = new Date(today.getFullYear(), today.getMonth(), 1); break;
                    case 'last_month':
                        startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                        endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                        endDate.setHours(23, 59, 59, 999);
                        break;
                    case 'custom':
                        const startVal = this.state.dashboardSettings.startDate;
                        const endVal = this.state.dashboardSettings.endDate;
                        if (!startVal || !endVal) {
                             if (this.state.chartInstance) this.state.chartInstance.destroy();
                             return;
                        }
                        startDate = new Date(startVal); startDate.setUTCHours(0,0,0,0);
                        endDate = new Date(endVal); endDate.setUTCHours(23,59,59,999);
                        break;
                }
                
                const existingProductIds = new Set(this.state.products.map(p => p.id));
                const movementsForExistingProducts = this.state.movements.filter(mov => existingProductIds.has(mov.productId));

                const filteredMovements = movementsForExistingProducts.filter(mov => {
                    if (!mov.date || typeof mov.date.toDate !== 'function') return false;
                    const movDate = mov.date.toDate();
                    return movDate >= startDate && movDate <= endDate;
                });
                
                if (this.state.chartInstance) this.state.chartInstance.destroy();
                const gridColor = 'rgba(0, 0, 0, 0.05)'; const textColor = '#111827';
                let chartConfig;
                if (chartType === 'pie') {
                    const totalEntradas = filteredMovements.filter(m => m.type === 'entrada').reduce((sum, m) => sum + m.quantity, 0);
                    const totalSaidas = filteredMovements.filter(m => m.type === 'saida').reduce((sum, m) => sum + m.quantity, 0);
                    chartConfig = {
                        type: 'pie',
                        data: {
                            labels: ['Entradas', 'Saídas'],
                            datasets: [{
                                data: [totalEntradas, totalSaidas],
                                backgroundColor: ['rgba(34, 197, 94, 0.8)', 'rgba(239, 68, 68, 0.8)'],
                                borderColor: ['#fff', '#fff'], borderWidth: 2
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: textColor } } } }
                    };
                } else {
                    const labels = []; const dataMap = new Map();
                    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                        const dateString = d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                        labels.push(dateString);
                        dataMap.set(dateString, { entrada: 0, saida: 0 });
                    }
                    filteredMovements.forEach(mov => {
                        if (mov.date?.toDate) {
                            const movDateStr = mov.date.toDate().toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                            if (dataMap.has(movDateStr)) {
                                const dayData = dataMap.get(movDateStr);
                                if (mov.type === 'entrada') dayData.entrada += mov.quantity;
                                else dayData.saida += mov.quantity;
                            }
                        }
                    });
                    const entradasData = labels.map(label => dataMap.get(label)?.entrada || 0);
                    const saidasData = labels.map(label => dataMap.get(label)?.saida || 0);
                    chartConfig = {
                        type: chartType,
                        data: {
                            labels,
                            datasets: [{
                                label: 'Entradas', data: entradasData,
                                backgroundColor: chartType === 'bar' ? 'rgba(34, 197, 94, 0.7)' : 'transparent',
                                borderColor: 'rgba(34, 197, 94, 1)', borderWidth: chartType === 'line' ? 3 : 1, tension: 0.2
                            }, {
                                label: 'Saídas', data: saidasData,
                                backgroundColor: chartType === 'bar' ? 'rgba(239, 68, 68, 0.7)' : 'transparent',
                                borderColor: 'rgba(239, 68, 68, 1)', borderWidth: chartType === 'line' ? 3 : 1, tension: 0.2
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor, precision: 0 } },
                                x: { grid: { color: gridColor }, ticks: { color: textColor } }
                            },
                            plugins: { legend: { position: 'top', labels: { color: textColor } } }
                        }
                    };
                }
                if (ctx && typeof Chart !== 'undefined') {
                    this.state.chartInstance = new Chart(ctx, chartConfig);
                }
            }
            renderLowStockAlerts() {
                const listEl = document.getElementById('low-stock-list'), emptyEl = document.getElementById('low-stock-empty');
                if (!listEl || !emptyEl) return;
                const lowStockProducts = this.state.products.filter(p => p.minStock > 0 && p.totalQuantity <= p.minStock);
                if (lowStockProducts.length > 0) {
                    listEl.innerHTML = lowStockProducts.map(p => `<li class="text-sm"><span class="font-semibold">${p.name}</span>: <span class="text-danger font-bold">${p.totalQuantity}</span> / ${p.minStock} ${p.unit}</li>`).join('');
                    listEl.classList.remove('hidden'); emptyEl.classList.add('hidden');
                } else {
                    listEl.classList.add('hidden'); emptyEl.classList.remove('hidden');
                }
            }
            renderTopMovements() {
                const renderList = (elementId, data) => {
                    const listEl = document.getElementById(elementId);
                    if (!listEl) return;
                    if(data.length > 0) {
                        listEl.innerHTML = data.map(mov => {
                            const product = this.state.products.find(p => p.id === mov.productId);
                            const productName = product ? product.name : 'Produto Excluído'; 
                            return `<li class="text-sm truncate" title="${productName}"><strong>${mov.quantity}x</strong> ${productName}</li>`;
                        }).join('');
                    } else {
                        listEl.innerHTML = `<li class="text-sm text-gray-500">Nenhuma movimentação.</li>`;
                    }
                };
                
                const existingProductIds = new Set(this.state.products.map(p => p.id));
                const movementsForExistingProducts = this.state.movements.filter(mov => existingProductIds.has(mov.productId));

                const sorted = [...movementsForExistingProducts].sort((a,b) => (b.date?.seconds || 0) - (a.date?.seconds || 0));
                
                renderList('top-entradas-list', sorted.filter(m => m.type === 'entrada').slice(0, 5));
                renderList('top-saidas-list', sorted.filter(m => m.type === 'saida').slice(0, 5));
            }
            renderHomeTab() {
                const homePanel = this.state.dom.panels.home;
                if (!homePanel || homePanel.classList.contains('hidden')) return;
                
                const totalProducts = this.state.products.length;
                const totalItems = this.state.products.reduce((acc, p) => acc + (p.totalQuantity || 0), 0);
                const totalCategories = this.state.categories.length;
                const lowStockCount = this.state.products.filter(p => p.minStock > 0 && p.totalQuantity <= p.minStock).length;

                document.getElementById('stat-total-products').textContent = totalProducts;
                document.getElementById('stat-total-items').textContent = totalItems;
                document.getElementById('stat-total-categories').textContent = totalCategories;
                document.getElementById('stat-low-stock').textContent = lowStockCount;

                const activityFeedEl = document.getElementById('recent-activity-feed');
                if (activityFeedEl) {
                    const recentMovements = [...this.state.movements].sort((a,b) => (b.date?.seconds || 0) - (a.date?.seconds || 0)).slice(0, 7);
                    if (recentMovements.length > 0) {
                        activityFeedEl.innerHTML = recentMovements.map(mov => {
                            const product = this.state.products.find(p => p.id === mov.productId);
                            const productName = product ? product.name : 'Produto Excluído';
                            const date = mov.date?.toDate().toLocaleString('pt-BR') || 'Data indefinida';
                            
                            let icon, color, text;
                            switch(mov.type) {
                                case 'entrada': icon = 'fa-arrow-down'; color = 'text-green-500'; text = `<strong>${mov.quantity}x</strong> ${productName} entraram no estoque.`; break;
                                case 'saida': icon = 'fa-arrow-up'; color = 'text-red-500'; text = `<strong>${mov.quantity}x</strong> ${productName} saíram do estoque.`; break;
                                case 'ajuste': icon = 'fa-arrows-left-right-to-line'; color = 'text-blue-500'; text = `Ajuste de <strong>${Math.abs(mov.quantity)}x</strong> em ${productName}.`; break;
                                default: icon = 'fa-exchange-alt'; color = 'text-blue-500'; text = `Movimentação de <strong>${mov.quantity}x</strong> ${productName}.`;
                            }
                            if (mov.motive?.includes('Transferência')) {
                                icon = 'fa-exchange-alt';
                                color = 'text-blue-500';
                            }

                            return `<li class="flex items-center space-x-4 p-3 hover:bg-gray-50 rounded-lg"><div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center bg-gray-100 ${color}"><i class="fas ${icon}"></i></div><div><p class="text-sm text-gray-800">${text}</p><p class="text-xs text-gray-500">${mov.motive || 'Sem motivo'} &bull; ${date}</p></div></li>`;
                        }).join('');
                    } else {
                        activityFeedEl.innerHTML = '<p class="text-center text-gray-500 p-4">Nenhuma atividade recente para mostrar.</p>';
                    }
                }
            }
            async handleGenerateReport() {
                const reportDateInput = document.getElementById('report-date');
                const categoryFilter = document.getElementById('report-category-filter').value;
                const statusFilter = document.getElementById('report-status-filter').value;
                const reportOutput = document.getElementById('report-output');

                if (!reportDateInput || !reportOutput || !reportDateInput.value) {
                    return this.showAlert('Selecione uma data para gerar o relatório.', true);
                }
                
                const targetDateParts = reportDateInput.value.split('-');
                const targetDate = new Date(parseInt(targetDateParts[0]), parseInt(targetDateParts[1]) - 1, parseInt(targetDateParts[2]), 23, 59, 59, 999);

                this.setLoading(true);
                
                try {
                    let historicalProducts = this.state.products
                        .filter(p => p.createdAt?.toDate() <= targetDate)
                        .map(p => {
                            // Start with the initial stock when the product was created
                            const initialMovement = this.state.movements.find(m => m.productId === p.id && m.motive === 'Criação de Produto');
                            let stockAtDate = initialMovement ? initialMovement.quantity : 0;
                            
                            // Apply all movements up to the target date
                            this.state.movements
                                .filter(m => m.productId === p.id && m.date?.toDate() <= targetDate && m.date.toDate() > p.createdAt.toDate())
                                .sort((a,b) => (a.date.seconds || 0) - (b.date.seconds || 0))
                                .forEach(mov => {
                                    stockAtDate += mov.quantity;
                                });

                            return {
                                ...p,
                                categoryName: this.state.categories.find(c => c.id === p.category)?.name || 'N/A',
                                stockAtDate
                            };
                        });

                    // Apply filters
                    let filteredReport = historicalProducts;

                    if (categoryFilter !== 'all') {
                        filteredReport = filteredReport.filter(p => p.category === categoryFilter);
                    }

                    if (statusFilter !== 'all') {
                        filteredReport = filteredReport.filter(p => {
                            if (statusFilter === 'low') return p.stockAtDate > 0 && p.stockAtDate <= p.minStock;
                            if (statusFilter === 'ok') return p.stockAtDate > p.minStock;
                            return true;
                        });
                    }
                    
                    document.getElementById('report-list').innerHTML = filteredReport
                        .sort((a, b) => a.name.localeCompare(b.name))
                        .map(p => `<tr class="border-b border-gray-200"><td class="p-3">${p.name}</td><td class="p-3 text-center">${p.categoryName}</td><td class="p-3 text-center">${p.unit}</td><td class="p-3 text-center font-bold">${p.stockAtDate}</td></tr>`).join('');
                    
                    document.getElementById('report-title').textContent = `Relatório de Estoque Histórico`;
                    document.getElementById('report-subtitle').textContent = `Posição em ${targetDate.toLocaleDateString('pt-BR')}`;
                    reportOutput.classList.remove('hidden');

                } catch(e) {
                    console.error("Error generating report", e);
                    this.showAlert("Falha ao gerar o relatório. Verifique os dados e tente novamente.", true);
                } finally {
                    this.setLoading(false);
                }
            }
            renderPaginationControls(totalItems) {
                const controlsContainer = document.getElementById('pagination-controls');
                if (!controlsContainer) return;
                const totalPages = Math.ceil(totalItems / this.state.itemsPerPage);
                if (totalPages <= 1) {
                    controlsContainer.innerHTML = '';
                    return;
                }
                const startItem = (this.state.currentPage - 1) * this.state.itemsPerPage + 1;
                const endItem = Math.min(this.state.currentPage * this.state.itemsPerPage, totalItems);
                controlsContainer.innerHTML = `<span class="text-sm text-gray-700">Mostrando <span class="font-semibold">${startItem}</span> a <span class="font-semibold">${endItem}</span> de <span class="font-semibold">${totalItems}</span></span><div class="inline-flex rounded-md shadow-sm -space-x-px"><button data-action="page-prev" class="px-3 h-8 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-l-lg hover:bg-slate-50 disabled:opacity-50" ${this.state.currentPage === 1 ? 'disabled' : ''}>Anterior</button><button data-action="page-next" class="px-3 h-8 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-r-lg hover:bg-slate-50 disabled:opacity-50" ${this.state.currentPage === totalPages ? 'disabled' : ''}>Próximo</button></div>`;
            }
            renderBulkActionBar() {
                const actionBar = document.getElementById('bulk-action-bar');
                const selectedCountEl = document.getElementById('selected-count');
                const bulkDeleteBtn = document.getElementById('bulk-delete-btn');

                if (!actionBar || !selectedCountEl || !bulkDeleteBtn) {
                    return;
                }

                const selectedCount = this.state.selectedProducts.length;

                if (!this.can('bulkDeleteProducts') || selectedCount === 0) {
                    actionBar.classList.remove('open');
                } else {
                    selectedCountEl.textContent = `${selectedCount} selecionado(s)`;
                    actionBar.classList.add('open');
                    
                    // Mostra o botão de exclusão em massa apenas quando vários itens são selecionados
                    bulkDeleteBtn.classList.toggle('hidden', selectedCount <= 1);
                }
            }
            clearFilters() {
                const searchInput = document.getElementById('search-product-input');
                const categoryFilter = document.getElementById('stock-category-filter');
                const statusFilter = document.getElementById('stock-status-filter');
                const dateStart = document.getElementById('date-filter-start');
                const dateEnd = document.getElementById('date-filter-end');

                if (searchInput) searchInput.value = '';
                if (categoryFilter) categoryFilter.value = 'all';
                if (statusFilter) statusFilter.value = 'all';
                if (dateStart) dateStart.value = '';
                if (dateEnd) dateEnd.value = '';
                
                this.state.currentPage = 1;
                this.debouncedRenderProducts();
            }
            handleDownloadTemplate() {
                const headers = { name: "Exemplo Produto", category: "Exemplo Categoria", unit: "UND", minStock: 10 };
                this.state.locations.forEach(l => headers[l.id] = 0);
                const worksheet = XLSX.utils.json_to_sheet([headers]);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Produtos");
                XLSX.writeFile(workbook, "modelo_importacao_estoque.xlsx");
            }
            getFilteredProducts() {
                const categoryFilter = document.getElementById('stock-category-filter')?.value || 'all';
                const searchTerm = document.getElementById('search-product-input')?.value.toLowerCase() || '';
                const stockStatus = document.getElementById('stock-status-filter')?.value || 'all';
                const startDateVal = document.getElementById('date-filter-start')?.value;
                const endDateVal = document.getElementById('date-filter-end')?.value;
                
                let startDate = null;
                if (startDateVal) {
                    const parts = startDateVal.split('-');
                    startDate = new Date(parts[0], parseInt(parts[1]) - 1, parseInt(parts[2]), 0, 0, 0, 0);
                }
                let endDate = null;
                if (endDateVal) {
                    const parts = endDateVal.split('-');
                    endDate = new Date(parts[0], parseInt(parts[1]) - 1, parseInt(parts[2]), 23, 59, 59, 999);
                }

                return this.state.products.filter(p => {
                    const matchesCategory = categoryFilter === 'all' || p.category === categoryFilter;
                    const matchesSearch = p.name.toLowerCase().includes(searchTerm);
                    const matchesStatus = stockStatus === 'all' || 
                                        (stockStatus === 'low' && p.minStock > 0 && p.totalQuantity <= p.minStock) ||
                                        (stockStatus === 'ok' && (p.minStock === 0 || p.totalQuantity > p.minStock));
                    
                    let matchesDate = true;
                    if (p.createdAt?.toDate) {
                        const createdAtDate = p.createdAt.toDate();
                        if (startDate && endDate) {
                            matchesDate = createdAtDate >= startDate && createdAtDate <= endDate;
                        } else if (startDate) {
                            matchesDate = createdAtDate >= startDate;
                        } else if (endDate) {
                            matchesDate = createdAtDate <= endDate;
                        }
                    } else if (startDate || endDate) {
                        matchesDate = false;
                    }
            
                    return matchesCategory && matchesSearch && matchesStatus && matchesDate;
                }).sort((a,b) => a.name.localeCompare(b.name)); 
            }
            handleExportPdf() {
                const filteredProducts = this.getFilteredProducts();
                if (filteredProducts.length === 0) {
                    return this.showAlert("Nenhum produto para exportar com os filtros atuais.", true);
                }
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'landscape' });
                doc.text(`Relatório de Estoque - ${new Date().toLocaleDateString('pt-BR')}`, 14, 16);
                const head = [['Produto', 'Categoria', ...this.state.locations.map(l => l.name), 'Total']];
                const body = filteredProducts.map(p => {
                    const productQuantities = p.quantities || {};
                    return [
                        p.name, 
                        this.state.categories.find(c => c.id === p.category)?.name || 'N/A', 
                        ...this.state.locations.map(l => productQuantities[l.id] || 0), 
                        p.totalQuantity || 0
                    ];
                });
                doc.autoTable({
                    head: head, body: body, startY: 20,
                    headStyles: { fillColor: [37, 99, 235] }, // --color-primary
                    styles: { fontSize: 8, cellPadding: 1.5, overflow: 'linebreak' },
                    columnStyles: { 0: { cellWidth: 50 } }
                });
                doc.save(`estoque_${new Date().toISOString().slice(0,10)}.pdf`);
            }
            
            handleExportReportPdf() {
                const reportTitle = document.getElementById('report-title').textContent;
                const reportSubtitle = document.getElementById('report-subtitle').textContent;
                const table = document.getElementById('report-list');
                
                if (!table || table.rows.length === 0) {
                    return this.showAlert("Nenhum dado no relatório para exportar.", true);
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.text(reportTitle, 14, 16);
                doc.setFontSize(10);
                doc.text(reportSubtitle, 14, 22);

                doc.autoTable({
                    html: '#report-list',
                    startY: 30,
                    head: [['Produto', 'Categoria', 'Unidade', 'Qtd. em Estoque']],
                    headStyles: { fillColor: [37, 99, 235] },
                });

                doc.save(`relatorio_historico_${new Date().toISOString().slice(0,10)}.pdf`);
            }
            
            handleExportComparisonPdf() {
                const table = document.getElementById('comparison-list');
                const startDate = document.getElementById('start-week-picker').value;
                const endDate = document.getElementById('end-week-picker').value;

                if (!table || table.rows.length === 0) {
                    return this.showAlert("Nenhum dado no comparativo para exportar.", true);
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(18);
                doc.setTextColor(40);
                doc.text("Relatório Comparativo Semanal", 14, 22);

                doc.setFontSize(11);
                doc.setTextColor(100);
                doc.text(`Período de ${startDate} a ${endDate}`, 14, 30);

                doc.autoTable({
                    html: '#comparison-list',
                    startY: 40,
                    head: [['Produto', 'Estoque Inicial', 'Estoque Final', 'Variação']],
                    headStyles: { fillColor: [124, 58, 237] }, // --color-purple
                    theme: 'striped',
                    styles: {
                        halign: 'center'
                    },
                    columnStyles: {
                        0: { halign: 'left' }
                    }
                });

                doc.save(`comparativo_semanal_${new Date().toISOString().slice(0,10)}.pdf`);
            }

            handleExcelParse(file, filenameEl) {
                this.setLoading(true);
                filenameEl.textContent = `Carregando ${file.name}...`;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = e.target.result;
                        const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet);
                        await this.handleBulkInsert(json);
                    } catch (error) {
                        console.error("Erro ao processar arquivo Excel:", error);
                        this.showAlert(`Falha ao processar o arquivo Excel. Verifique o formato e tente novamente.`, true);
                    } finally {
                        filenameEl.textContent = '';
                        this.setLoading(false);
                        const excelInput = document.getElementById('excel-insert-input');
                        if (excelInput) excelInput.value = '';
                    }
                };
                reader.onerror = (error) => {
                     console.error("Erro de FileReader:", error);
                     this.showAlert(`Erro ao ler o arquivo: ${error}`, true);
                     filenameEl.textContent = '';
                     this.setLoading(false);
                };
                reader.readAsArrayBuffer(file);
            }
            async handleBulkInsert(data) {
                if (!this.state.firestoreRefs) {
                    this.showAlert("Erro de configuração interna. Não é possível processar.", true);
                    return;
                }
                const batch = writeBatch(this.db);
                const localCategories = new Map(this.state.categories.map(c => [c.name.toLowerCase(), c]));
                const localLocations = [...this.state.locations];
                
                let productsProcessedCount = 0;
                let newCategoriesCount = 0;

                for (const row of data) {
                    let categoryName = row.category?.toString().trim();
                    let productName = row.name?.toString().trim();
                    if (!productName || !categoryName) {
                        console.warn("Linha ignorada por falta de nome ou categoria:", row);
                        continue;
                    }

                    let category = localCategories.get(categoryName.toLowerCase());
                    if (!category) {
                        const newCatRef = doc(collection(this.db, this.state.firestoreRefs.categories.path));
                        batch.set(newCatRef, { name: categoryName });
                        category = { id: newCatRef.id, name: categoryName };
                        localCategories.set(categoryName.toLowerCase(), category);
                        newCategoriesCount++;
                    }
                    
                    const quantities = {}; let totalQuantity = 0;
                    localLocations.forEach(loc => {
                        const qty = parseInt(row[loc.id], 10) || 0;
                        if (qty > 0) {
                           quantities[loc.id] = qty;
                           totalQuantity += qty;
                        }
                    });

                    const newProdRef = doc(collection(this.db, this.state.firestoreRefs.products.path));
                    const productData = {
                        name: productName, category: category.id, quantities, totalQuantity,
                        unit: row.unit?.toString().trim() || 'UND', 
                        minStock: parseInt(row.minStock, 10) || 1, 
                        createdAt: serverTimestamp()
                    };
                    batch.set(newProdRef, productData);
                    productsProcessedCount++;

                    if (totalQuantity > 0) {
                        const movRef = doc(collection(this.db, this.state.firestoreRefs.movements.path));
                        batch.set(movRef, { 
                            productId: newProdRef.id, type: 'entrada', 
                            quantity: totalQuantity, motive: 'Importação Excel', 
                            date: serverTimestamp()
                        });
                    }
                }

                if (productsProcessedCount > 0) {
                    await batch.commit();
                    this.logAudit('BULK_PRODUCT_INSERT', { count: productsProcessedCount, newCategories: newCategoriesCount });
                    this.showAlert(`${productsProcessedCount} produtos processados e adicionados do arquivo Excel.`);
                } else {
                    this.showAlert('Nenhum produto válido encontrado no arquivo Excel para processar.');
                }
            }
            injectPanelContent() {
                if (!this.state.dom || !this.state.dom.panels) {
                    console.error("DOM ou painéis não foram cacheados corretamente.");
                    return;
                }
                
                // --- PAINEL HOME ---
                if (this.state.dom.panels.home) {
                    this.state.dom.panels.home.innerHTML = `<div class="space-y-8"><div><h2 class="text-3xl font-bold text-gray-900 mb-2">Página Inicial</h2><p class="text-gray-500">Uma visão geral e rápida do seu estoque.</p></div><div class="grid grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6"><div class="bg-white p-4 rounded-2xl shadow-xl border border-gray-200 flex items-center space-x-4"><div class="text-2xl bg-primary-light text-primary p-3 rounded-xl"><i class="fas fa-box"></i></div><div><p class="text-sm text-gray-500">Produtos</p><p id="stat-total-products" class="text-2xl font-bold">0</p></div></div><div class="bg-white p-4 rounded-2xl shadow-xl border border-gray-200 flex items-center space-x-4"><div class="text-2xl bg-primary-light text-primary p-3 rounded-xl"><i class="fas fa-boxes-stacked"></i></div><div><p class="text-sm text-gray-500">Itens Totais</p><p id="stat-total-items" class="text-2xl font-bold">0</p></div></div><div class="bg-white p-4 rounded-2xl shadow-xl border border-gray-200 flex items-center space-x-4"><div class="text-2xl bg-primary-light text-primary p-3 rounded-xl"><i class="fas fa-tags"></i></div><div><p class="text-sm text-gray-500">Categorias</p><p id="stat-total-categories" class="text-2xl font-bold">0</p></div></div><div class="bg-white p-4 rounded-2xl shadow-xl border border-gray-200 flex items-center space-x-4"><div class="text-2xl bg-amber-100 text-warning p-3 rounded-xl"><i class="fas fa-exclamation-triangle"></i></div><div><p class="text-sm text-gray-500">Estoque Baixo</p><p id="stat-low-stock" class="text-2xl font-bold">0</p></div></div></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-1 space-y-4"><h3 class="text-xl font-semibold text-gray-900">Ações Rápidas</h3><div class="grid grid-cols-2 gap-4"><a href="#" class="action-card flex flex-col items-center justify-center text-center p-4 bg-white rounded-2xl shadow-xl border border-gray-200 hover:border-primary hover:bg-primary-light transition-all duration-300" data-tab="stock"><i class="fas fa-warehouse text-2xl text-primary mb-2"></i><span class="font-semibold text-sm">Ver Estoque</span></a><a href="#" class="action-card flex flex-col items-center justify-center text-center p-4 bg-white rounded-2xl shadow-xl border border-gray-200 hover:border-primary hover:bg-primary-light transition-all duration-300" data-tab="register"><i class="fas fa-plus-circle text-2xl text-success mb-2"></i><span class="font-semibold text-sm">Adicionar</span></a><a href="#" class="action-card flex flex-col items-center justify-center text-center p-4 bg-white rounded-2xl shadow-xl border border-gray-200 hover:border-primary hover:bg-primary-light transition-all duration-300" data-tab="movements"><i class="fas fa-exchange-alt text-2xl text-danger mb-2"></i><span class="font-semibold text-sm">Movimentar</span></a><a href="#" class="action-card flex flex-col items-center justify-center text-center p-4 bg-white rounded-2xl shadow-xl border border-gray-200 hover:border-primary hover:bg-primary-light transition-all duration-300" data-tab="reports"><i class="fas fa-chart-pie text-2xl text-indigo-500 mb-2"></i><span class="font-semibold text-sm">Relatórios</span></a><a href="#" class="action-card flex flex-col items-center justify-center text-center p-4 bg-white rounded-2xl shadow-xl border border-gray-200 hover:border-primary hover:bg-primary-light transition-all duration-300 col-span-2" data-tab="counting"><i class="fas fa-clipboard-check text-2xl text-purple mb-2"></i><span class="font-semibold text-sm">Realizar Contagem</span></a></div></div><div class="lg:col-span-2"><h3 class="text-xl font-semibold text-gray-900 mb-4">Atividade Recente</h3><div class="bg-white p-4 rounded-2xl shadow-xl border border-gray-200"><ul id="recent-activity-feed" class="space-y-2"></ul></div></div></div></div>`;
                }
                
                // --- PAINEL ESTOQUE ---
                if (this.state.dom.panels.stock) {
                     this.state.dom.panels.stock.innerHTML = `<div class="space-y-6"><div class="bg-white p-4 md:p-6 rounded-2xl shadow-xl border border-gray-200 relative"><div class="flex flex-wrap justify-between items-center mb-4 gap-4"><h2 class="text-2xl font-semibold flex-shrink-0 text-gray-900">Estoque Atual</h2><div class="flex flex-wrap items-center gap-2"><div class="relative grow sm:grow-0"><i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i><input type="text" id="search-product-input" placeholder="Buscar..." class="w-full p-2 pl-10 bg-white rounded-lg text-gray-900 border border-gray-300"></div><select id="stock-category-filter" class="p-2 bg-white border border-gray-300 rounded-lg text-gray-900 grow sm:grow-0"><option value="all">Todas as Categorias</option></select><button id="toggle-advanced-filters" class="bg-white border border-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-50 transition flex-shrink-0 flex items-center gap-2">Filtros <i class="fas fa-chevron-down"></i></button><button id="export-pdf-btn" data-role-required="admin" class="bg-danger text-white font-semibold py-2 px-4 rounded-lg hover:bg-danger-hover transition flex items-center gap-2"><i class="fas fa-file-pdf"></i> Exportar</button></div></div><div id="advanced-filters-wrapper"><div id="advanced-filters-content"><div class="p-4 mb-4 bg-slate-50 rounded-lg border border-gray-200"><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-end"><div><label for="stock-status-filter" class="block text-sm font-medium text-gray-700">Status</label><select id="stock-status-filter" class="mt-1 block w-full p-2 bg-white rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"><option value="all">Todos</option><option value="low">Estoque Baixo</option><option value="ok">Estoque OK</option></select></div><div><label for="date-filter-start" class="block text-sm font-medium text-gray-700">De</label><input type="date" id="date-filter-start" class="mt-1 block w-full p-2 bg-white rounded-md border-gray-300 shadow-sm"></div><div><label for="date-filter-end" class="block text-sm font-medium text-gray-700">Até</label><input type="date" id="date-filter-end" class="mt-1 block w-full p-2 bg-white rounded-md border-gray-300 shadow-sm"></div><div class="flex justify-end"><button id="clear-filters-btn" class="bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 transition">Limpar</button></div></div></div></div><div id="bulk-action-bar" class="bulk-action-bar mb-4 p-2 bg-primary-light border border-blue-200 rounded-lg flex items-center justify-between"><span id="selected-count" class="text-sm font-medium text-blue-800"></span><button id="bulk-delete-btn" class="bg-danger text-white text-sm font-bold py-1 px-3 rounded-md hover:bg-danger-hover transition hidden"><i class="fas fa-trash-alt mr-2"></i>Excluir Selecionados</button></div>
                            <div id="product-list-container">
                                <div class="overflow-x-auto hidden md:block">
                                    <table class="w-full text-left" id="product-list">
                                        <thead class="border-b-2 border-gray-200 bg-white">
                                            <tr id="product-table-header-row"></tr>
                                        </thead>
                                        <tbody id="product-table-body"></tbody>
                                    </table>
                                </div>
                                <div id="product-card-list" class="block md:hidden"></div>
                            </div>
                            <div id="pagination-controls" class="flex justify-between items-center mt-4"></div>
                            <div id="empty-state" class="hidden"></div>
                        </div></div>`;
                }
                
                // --- PAINEL CADASTROS ---
                if (this.state.dom.panels.register) {
                    this.state.dom.panels.register.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200 h-fit"><h2 class="text-2xl font-semibold mb-4 text-gray-900">Gerenciar Categorias</h2><form id="add-category-form" class="flex gap-2 mb-4"><input type="text" id="category-name" placeholder="Nova categoria" class="w-full p-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:ring-primary focus:border-primary" required><button type="submit" class="bg-success text-white p-2 rounded-lg hover:bg-success-hover transition flex items-center justify-center w-12 flex-shrink-0"><i class="fas fa-plus"></i></button></form><div id="category-list" class="space-y-2 max-h-60 overflow-y-auto pr-2"></div></div><div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-xl border border-gray-200"><h2 class="text-2xl font-semibold mb-4 text-gray-900">Adicionar Produto</h2><form id="add-product-form" class="space-y-4"><label class="block"><span class="text-gray-700">Nome</span><input type="text" id="product-name" class="mt-1 block w-full rounded-md bg-white border border-gray-300 focus:border-primary focus:bg-white focus:ring-primary" required></label><label class="block"><span class="text-gray-700">Categoria</span><select id="product-category-select" class="mt-1 block w-full rounded-md bg-white border border-gray-300 focus:border-primary focus:bg-white focus:ring-primary" required><option value="">Selecione...</option></select></label><div id="add-product-form-locations-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div><div class="grid grid-cols-2 gap-4"><label class="block"><span class="text-gray-700">Est. Mínimo</span><input type="number" id="product-min-stock" min="1" value="1" class="mt-1 block w-full rounded-md bg-white border border-gray-300 focus:border-primary focus:bg-white focus:ring-primary" required></label><label class="block"><span class="text-gray-700">Unid.</span><select id="product-unit-select" class="mt-1 block w-full rounded-md bg-white border border-gray-300 focus:border-primary focus:bg-white focus:ring-primary" required><option>UND</option><option>CX</option><option>KG</option><option>G</option><option>L</option><option>ML</option></select></label></div><button type="submit" class="w-full mt-4 bg-primary text-white font-bold py-2 rounded-lg hover:bg-primary-hover transition"><i class="fas fa-plus mr-2"></i>Adicionar Produto</button></form></div></div><div class="mt-8 bg-white p-6 rounded-2xl shadow-xl border border-gray-200"><h2 class="text-2xl font-semibold mb-4 text-gray-900"><i class="fas fa-file-excel mr-2 text-green-500"></i>Operações em Lote (Excel)</h2><div class="flex flex-col md:flex-row gap-6"><div class="flex-1 bg-gray-50 p-4 rounded-lg flex flex-col items-center text-center border"><i class="fas fa-plus-circle fa-2x text-primary mb-2"></i><h3 class="font-semibold mb-1 text-gray-900">Inserir Novos Produtos</h3><p class="text-sm text-gray-600 mb-3">Baixe o modelo, preencha e importe o arquivo Excel para adicionar vários produtos de uma vez.</p><div class="flex gap-2 w-full"><button id="download-template-btn" class="w-full bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary-hover transition"><i class="fas fa-download mr-2"></i>Baixar Modelo</button><input type="file" id="excel-insert-input" accept=".xlsx, .xls" class="hidden"><button id="upload-insert-trigger-btn" class="w-full bg-success text-white py-2 px-4 rounded-lg hover:bg-success-hover transition"><i class="fas fa-upload mr-2"></i>Importar</button></div><p id="excel-insert-filename" class="text-xs mt-2 text-gray-500"></p></div></div></div>`;
                }

                // --- PAINEL MOVIMENTAÇÕES ---
                if (this.state.dom.panels.movements) {
                    this.state.dom.panels.movements.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200"><h2 class="text-2xl font-semibold mb-4 text-gray-900"><i class="fas fa-arrow-circle-up mr-2 text-danger"></i>Registrar Saída</h2><form id="add-output-form" class="space-y-4"><div><label for="output-product-select" class="block text-sm mb-1 text-gray-700">Produto</label><select id="output-product-select" class="w-full p-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:ring-primary focus:border-primary" required><option value="">Selecione...</option></select></div><div id="output-location-selector" class="space-y-2"></div><div><label for="output-quantity" class="block text-sm mb-1 text-gray-700">Quantidade da Saída</label><input type="number" id="output-quantity" min="1" class="w-full p-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:ring-primary focus:border-primary" required disabled></div><div><label for="output-motive-select" class="block text-sm mb-1 text-gray-700">Motivo</label><select id="output-motive-select" class="w-full p-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:ring-primary focus:border-primary" required><option>Venda</option><option>Perda</option><option>Uso Interno</option><option>Outro</option></select></div><p id="output-stock-info" class="text-sm text-gray-500 font-medium h-5"></p><button type="submit" class="w-full mt-4 bg-danger text-white font-bold p-2 rounded-lg hover:bg-danger-hover transition">Registrar Saída</button></form></div><div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200"><h2 class="text-2xl font-semibold mb-4 text-gray-900"><i class="fas fa-exchange-alt mr-2 text-primary"></i>Transferir Estoque</h2><form id="transfer-stock-form" class="space-y-4"><div><label for="transfer-product-select" class="block text-sm mb-1 text-gray-700">Produto</label><select id="transfer-product-select" class="w-full p-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:ring-primary focus:border-primary" required><option value="">Selecione...</option></select></div><p id="transfer-stock-info" class="text-sm text-gray-500 font-medium h-5"></p><div><label for="transfer-from-location-select" class="block text-sm mb-1 text-gray-700">De</label><select id="transfer-from-location-select" class="w-full p-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:ring-primary focus:border-primary" required disabled><option value="">Selecione a origem</option></select></div><div><label for="transfer-to-location-select" class="block text-sm mb-1 text-gray-700">Para</label><select id="transfer-to-location-select" class="w-full p-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:ring-primary focus:border-primary" required disabled><option value="">Selecione o destino</option></select></div><div><label for="transfer-quantity" class="block text-sm mb-1 text-gray-700">Quantidade</label><input type="number" id="transfer-quantity" min="1" class="w-full p-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:ring-primary focus:border-primary" required disabled></div><button type="submit" class="w-full mt-4 bg-primary text-white font-bold p-2 rounded-lg hover:bg-primary-hover transition">Confirmar Transferência</button></form></div></div>`;
                }

                // --- PAINEL DASHBOARD/RELATÓRIOS ---
                if (this.state.dom.panels.reports) {
                    this.state.dom.panels.reports.innerHTML = `<div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200 mb-8"><h2 class="text-2xl font-semibold mb-4 text-gray-900">Dashboard de Movimentações</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg border"><div><label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Gráfico</label><div id="chart-type-selector" class="flex rounded-md shadow-sm"><button data-type="bar" class="chart-type-btn relative inline-flex items-center px-4 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:z-10 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">Barra</button><button data-type="line" class="chart-type-btn -ml-px relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:z-10 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">Linha</button><button data-type="pie" class="chart-type-btn -ml-px relative inline-flex items-center px-4 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:z-10 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">Pizza</button></div></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Período</label><select id="period-selector" class="dashboard-control block w-full p-2 bg-white rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"><option value="7days">Últimos 7 dias</option><option value="30days">Últimos 30 dias</option><option value="this_month">Este Mês</option><option value="last_month">Mês Passado</option><option value="custom">Personalizado</option></select></div><div id="custom-date-range-selector" class="hidden md:col-span-1 grid grid-cols-2 gap-4"><div><label for="dashboard-date-start" class="block text-sm font-medium text-gray-700">De</label><input type="date" id="dashboard-date-start" class="dashboard-control mt-1 block w-full p-2 bg-white rounded-md border-gray-300 shadow-sm"></div><div><label for="dashboard-date-end" class="block text-sm font-medium text-gray-700">Até</label><input type="date" id="dashboard-date-end" class="dashboard-control mt-1 block w-full p-2 bg-white rounded-md border-gray-300 shadow-sm"></div></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="md:col-span-2 bg-gray-50 p-4 rounded-lg h-96 border"><canvas id="movements-chart"></canvas></div><div class="space-y-4"><div class="bg-amber-100 p-4 rounded-lg"><h3 class="font-semibold mb-2 text-amber-800">Alerta de Estoque Baixo</h3><ul id="low-stock-list" class="space-y-2 max-h-40 overflow-y-auto"></ul><p id="low-stock-empty" class="text-sm text-gray-500 hidden">Tudo em ordem!</p></div><div class="bg-gray-50 p-4 rounded-lg border"><h3 class="font-semibold mb-2 text-green-800">Top 5 Entradas Recentes</h3><ul id="top-entradas-list" class="space-y-2"></ul></div><div class="bg-gray-50 p-4 rounded-lg border"><h3 class="font-semibold mb-2 text-red-800">Top 5 Saídas Recentes</h3><ul id="top-saidas-list" class="space-y-2"></ul></div></div></div></div><div class="mt-8 bg-white p-6 rounded-2xl shadow-xl border border-gray-200"><h2 class="text-2xl font-semibold mb-4 text-gray-900"><i class="fas fa-history mr-2 text-indigo-500"></i>Relatório Histórico de Estoque</h2><div class="grid grid-cols-1 md:grid-cols-4 gap-4 p-4 bg-gray-50 rounded-lg border mb-4"><div class="md:col-span-1"><label for="report-date" class="block text-sm font-medium text-gray-700">Posição em:</label><input type="date" id="report-date" class="mt-1 block w-full p-2 bg-white border border-gray-300 rounded-lg"></div><div><label for="report-category-filter" class="block text-sm font-medium text-gray-700">Categoria</label><select id="report-category-filter" class="mt-1 block w-full p-2 bg-white border border-gray-300 rounded-lg"><option value="all">Todas</option></select></div><div><label for="report-status-filter" class="block text-sm font-medium text-gray-700">Status do Estoque</label><select id="report-status-filter" class="mt-1 block w-full p-2 bg-white border border-gray-300 rounded-lg"><option value="all">Todos</option><option value="ok">OK</option><option value="low">Baixo/Crítico</option></select></div><div class="flex items-end"><button id="generate-report-btn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Gerar Relatório</button></div></div><div id="report-output" class="hidden mt-6"><div class="flex justify-between items-center mb-4"><div id="print-area"><h3 id="report-title" class="text-xl font-bold"></h3><p id="report-subtitle" class="text-gray-500"></p></div><div class="flex gap-2"><button id="export-report-pdf-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition"><i class="fas fa-file-pdf mr-2"></i>Exportar PDF</button><button id="print-report-btn" class="bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-800 transition"><i class="fas fa-print mr-2"></i>Imprimir</button></div></div><table class="w-full text-left"><thead class="border-b-2 border-gray-300"><tr><th class="p-3">Produto</th><th class="p-3 text-center">Categoria</th><th class="p-3 text-center">Unidade</th><th class="p-3 text-center">Qtd. em Estoque</th></tr></thead><tbody id="report-list"></tbody></table></div></div>`;
                }
                
                // --- PAINEL CONTAGEM ---
                if (this.state.dom.panels.counting) {
                    this.state.dom.panels.counting.innerHTML = `<div class="space-y-8"><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-xl border border-gray-200 h-fit"><h2 class="text-2xl font-semibold mb-4 text-gray-900">Nova Contagem</h2><form id="save-count-form" class="space-y-4"><div><label for="counting-product-select" class="block text-sm mb-1 text-gray-700">Selecionar Produto</label><select id="counting-product-select" class="w-full p-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:ring-primary focus:border-primary" required><option value="">Selecione...</option></select></div><div id="counting-fields-container" class="space-y-3 hidden"></div></form></div><div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-xl border border-gray-200"><h2 class="text-2xl font-semibold mb-4 text-gray-900">Histórico de Contagens</h2><div id="counting-history-list" class="space-y-4 max-h-[600px] overflow-y-auto"></div></div></div><div class="mt-8 bg-white p-6 rounded-2xl shadow-xl border border-gray-200"><h2 class="text-2xl font-semibold mb-4 text-gray-900"><i class="fas fa-calendar-week mr-2 text-purple"></i>Comparativo Semanal</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 bg-gray-50 rounded-lg border mb-4"><div class="md:col-span-1"><label for="start-week-picker" class="block text-sm font-medium text-gray-700">Semana Inicial:</label><input type="date" id="start-week-picker" class="mt-1 block w-full p-2 bg-white border border-gray-300 rounded-lg"></div><div class="md:col-span-1"><label for="end-week-picker" class="block text-sm font-medium text-gray-700">Semana Final:</label><input type="date" id="end-week-picker" class="mt-1 block w-full p-2 bg-white border border-gray-300 rounded-lg"></div><div class="flex items-end"><button id="compare-weeks-btn" class="w-full bg-purple text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 transition hidden">Comparar</button></div></div><div id="comparison-output" class="hidden mt-6"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Resultado da Comparação</h3><button id="export-comparison-excel-btn" class="bg-success text-white font-semibold py-2 px-4 rounded-lg hover:bg-success-hover transition"><i class="fas fa-file-excel mr-2"></i>Exportar Excel</button></div><table class="w-full text-left"><thead class="border-b-2 border-gray-300"><tr><th class="p-3">Produto</th><th class="p-3 text-center">Estoque Inicial</th><th class="p-3 text-center">Estoque Final</th><th class="p-3 text-center">Variação</th></tr></thead><tbody id="comparison-list"></tbody></table></div></div></div>`;
                }

                // --- PAINEL CONFIGURAÇÕES ---
                if (this.state.dom.panels.settings) {
                    this.state.dom.panels.settings.innerHTML = `<div class="space-y-8"><div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200"><h2 class="text-2xl font-semibold mb-4 text-gray-900">Configurações Gerais</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><h3 class="text-lg font-medium text-gray-900 mb-2">Gerenciar Localidades</h3><form id="add-location-form" class="flex gap-2 mb-4"><input type="text" id="location-name" placeholder="Nova localidade" class="w-full p-2 bg-white border border-gray-300 rounded-lg text-gray-900 focus:ring-primary focus:border-primary" required><button type="submit" class="bg-success text-white p-2 rounded-lg hover:bg-success-hover transition flex items-center justify-center w-12 flex-shrink-0"><i class="fas fa-plus"></i></button></form><div id="location-list" class="space-y-2 max-h-60 overflow-y-auto pr-2"></div></div><div><h3 class="text-lg font-medium text-gray-900 mb-2">Configurações de Exibição</h3><div class="space-y-4"><div><label for="items-per-page-input" class="block text-sm font-medium text-gray-700">Itens por página na tabela</label><input type="number" id="items-per-page-input" min="1" class="mt-1 block w-full p-2 bg-white border border-gray-300 rounded-lg"></div><button id="save-settings-btn" class="w-full bg-primary text-white font-bold py-2 rounded-lg hover:bg-primary-hover transition">Salvar Configurações Gerais</button></div></div></div></div><div id="user-management-section" class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200"><h2 class="text-2xl font-semibold mb-6 text-gray-900"><i class="fas fa-users-cog mr-2"></i>Gerenciar Usuários</h2><div class="overflow-x-auto"><table class="w-full text-left"><thead class="border-b-2 border-gray-200 bg-gray-50"><tr><th class="p-3 text-sm font-semibold text-gray-700">Email</th><th class="p-3 text-sm font-semibold text-gray-700">Papel</th><th class="p-3 text-sm font-semibold text-gray-700 text-right">Ação</th></tr></thead><tbody id="user-list-tbody"></tbody></table></div><p class="mt-4 text-xs text-gray-500 italic">Administradores não podem alterar seu próprio papel através desta interface.</p></div></div>`;
                }

                // --- PAINEL AUDITORIA ---
                if(this.state.dom.panels.audit) {
                    this.state.dom.panels.audit.innerHTML = `<div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200"><h2 class="text-2xl font-semibold mb-4 text-gray-900">Log de Auditoria</h2><div class="overflow-x-auto"><table class="w-full text-left"><thead class="border-b-2 border-gray-200 bg-gray-50"><tr><th class="p-3 text-sm font-semibold text-gray-700">Data</th><th class="p-3 text-sm font-semibold text-gray-700">Usuário</th><th class="p-3 text-sm font-semibold text-gray-700">Ação</th><th class="p-3 text-sm font-semibold text-gray-700">Detalhes</th></tr></thead><tbody id="audit-log-body"></tbody></table></div></div>`;
                }

                this.applyRolePermissions();
            }
            // MÉTODOS DE RENDERIZAÇÃO DE LOCALIDADES, ETC (Não alterados)
            handleOutputProductSelection(productId) {
                const stockInfo = document.getElementById('output-stock-info');
                const locationSelector = document.getElementById('output-location-selector');
                const quantityInput = document.getElementById('output-quantity');
                
                if (!stockInfo || !locationSelector || !quantityInput) return;

                if (!productId) {
                    stockInfo.textContent = '';
                    locationSelector.innerHTML = '';
                    quantityInput.disabled = true;
                    quantityInput.value = '';
                    return;
                }
                
                const product = this.state.products.find(p => p.id === productId);
                if (!product) return;
                
                locationSelector.innerHTML = this.state.locations.map(loc => {
                    const qtyInLoc = product.quantities?.[loc.id] || 0;
                    return `<label class="flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-50 ${qtyInLoc === 0 ? 'opacity-50 cursor-not-allowed' : ''}">
                                <input type="radio" name="output-location" value="${loc.id}" class="h-4 w-4 text-primary focus:ring-primary" ${qtyInLoc === 0 ? 'disabled' : ''}>
                                <span>${loc.name} <span class="text-xs text-gray-500">(Disp: ${qtyInLoc})</span></span>
                            </label>`;
                }).join('');
                
                stockInfo.textContent = `Estoque total de ${product.name}: ${product.totalQuantity || 0}`;
                this.updateOutputQuantityLock();
            }

            updateOutputQuantityLock() {
                const quantityInput = document.getElementById('output-quantity');
                const selectedLocationRadio = document.querySelector('input[name="output-location"]:checked');
                if (quantityInput) {
                    quantityInput.disabled = !selectedLocationRadio;
                }
            }

            handleTransferProductSelection(productId) {
                const stockInfo = document.getElementById('transfer-stock-info');
                const fromSelect = document.getElementById('transfer-from-location-select');
                const toSelect = document.getElementById('transfer-to-location-select');
                const quantityInput = document.getElementById('transfer-quantity');

                if (!productId) {
                    stockInfo.innerHTML = '&nbsp;';
                    fromSelect.innerHTML = '<option value="">Selecione a origem</option>';
                    fromSelect.disabled = true;
                    toSelect.innerHTML = '<option value="">Selecione o destino</option>';
                    toSelect.disabled = true;
                    quantityInput.disabled = true;
                    return;
                }
                
                const product = this.state.products.find(p => p.id === productId);
                if (!product) return;

                stockInfo.innerHTML = this.state.locations
                    .map(loc => `<span>${loc.name}: <strong>${product.quantities?.[loc.id] || 0}</strong></span>`)
                    .join(' &bull; ');
                
                const locationsWithOptions = this.state.locations.map(loc => `<option value="${loc.id}">${loc.name} (Disp: ${product.quantities?.[loc.id] || 0})</option>`).join('');
                
                fromSelect.innerHTML = `<option value="">Selecione a origem</option>${locationsWithOptions}`;
                toSelect.innerHTML = `<option value="">Selecione o destino</option>${locationsWithOptions}`;
                
                fromSelect.disabled = false;
            }

            handleTransferFromLocationSelection(fromLocationId) {
                const toSelect = document.getElementById('transfer-to-location-select');
                const quantityInput = document.getElementById('transfer-quantity');
                
                if (!fromLocationId) {
                    toSelect.disabled = true;
                    quantityInput.disabled = true;
                    return;
                }
                
                toSelect.disabled = false;
                quantityInput.disabled = false;
                
                // Desabilitar a mesma opção no 'select' de destino
                Array.from(toSelect.options).forEach(opt => {
                    opt.disabled = opt.value === fromLocationId;
                    if (opt.selected && opt.disabled) {
                        toSelect.value = "";
                    }
                });
            }

            handleProductSelectForCount(productId) {
                const fieldsContainer = document.getElementById('counting-fields-container');
                if (!fieldsContainer) return;

                if (!productId) {
                    fieldsContainer.classList.add('hidden');
                    fieldsContainer.innerHTML = '';
                    return;
                }

                const product = this.state.products.find(p => p.id === productId);
                if (!product) return;

                const locationInputs = this.state.locations.map(loc => {
                    const currentQty = product.quantities?.[loc.id] || 0;
                    return `<div>
                                <label for="count-qty-${loc.id}" class="block text-sm font-medium text-gray-700">${loc.name}</label>
                                <input type="number" id="count-qty-${loc.id}" name="count-qty-${loc.id}" min="0" required 
                                       placeholder="Atual: ${currentQty}"
                                       class="mt-1 block w-full rounded-md bg-white border border-gray-300 focus:border-primary focus:bg-white focus:ring-primary">
                            </div>`;
                }).join('');

                fieldsContainer.innerHTML = `
                    <div class="grid grid-cols-2 gap-4">${locationInputs}</div>
                    <button type="submit" class="w-full mt-4 bg-primary text-white font-bold py-2 rounded-lg hover:bg-primary-hover transition">
                        <i class="fas fa-save mr-2"></i>Salvar Contagem
                    </button>
                `;
                fieldsContainer.classList.remove('hidden');
            }
            
            async handleSaveCount(form) {
                const productId = form.querySelector('#counting-product-select').value;
                if (!productId) throw new Error("Nenhum produto selecionado para contagem.");

                const product = this.state.products.find(p => p.id === productId);
                if (!product) throw new Error("Produto não encontrado.");

                const countedQuantities = {};
                let countedTotal = 0;
                let hasErrors = false;

                this.state.locations.forEach(loc => {
                    const input = form.querySelector(`#count-qty-${loc.id}`);
                    if (input) {
                        const qty = parseInt(input.value, 10);
                        if (isNaN(qty) || qty < 0) {
                           hasErrors = true;
                        }
                        countedQuantities[loc.id] = qty || 0;
                        countedTotal += qty || 0;
                    }
                });

                if (hasErrors) {
                    throw new Error("Todas as quantidades contadas devem ser números válidos e não negativos.");
                }

                const previousQuantities = { ...(product.quantities || {}) };
                const previousTotal = product.totalQuantity || 0;
                const adjustment = countedTotal - previousTotal;

                const batch = writeBatch(this.db);
                
                // 1. Update product stock
                const productRef = doc(this.state.firestoreRefs.products, productId);
                batch.update(productRef, {
                    quantities: countedQuantities,
                    totalQuantity: countedTotal
                });

                // 2. Create movement record for the adjustment
                if (adjustment !== 0) {
                    const movementRef = doc(this.state.firestoreRefs.movements);
                    batch.set(movementRef, {
                        productId,
                        type: 'ajuste',
                        quantity: adjustment, // can be positive or negative
                        motive: 'Ajuste de contagem',
                        date: serverTimestamp()
                    });
                }
                
                // 3. Create counting history record
                const historyRef = doc(this.state.firestoreRefs.countingHistory);
                batch.set(historyRef, {
                    productId,
                    productName: product.name,
                    date: serverTimestamp(),
                    userEmail: this.state.currentUser.email,
                    countedQuantities,
                    previousQuantities,
                    adjustment
                });
                
                await batch.commit();

                this.logAudit('STOCK_COUNT', {
                    productName: product.name,
                    adjustment,
                    newTotal: countedTotal,
                    oldTotal: previousTotal,
                });

                this.showAlert('Contagem salva e estoque ajustado com sucesso!');
                form.reset();
                this.handleProductSelectForCount(''); // Reset form fields
            }
            
            renderCountingTab() {
                this.populateProductSelects();
                this.renderCountingHistory();
                this.updateCompareButtonVisibility();
            }

            updateCompareButtonVisibility() {
                const startDateInput = document.getElementById('start-week-picker');
                const endDateInput = document.getElementById('end-week-picker');
                const compareBtn = document.getElementById('compare-weeks-btn');
                if (startDateInput && endDateInput && compareBtn) {
                    if (startDateInput.value && endDateInput.value) {
                        compareBtn.classList.remove('hidden');
                    } else {
                        compareBtn.classList.add('hidden');
                    }
                }
            }

            renderCountingHistory() {
                const historyListEl = document.getElementById('counting-history-list');
                if (!historyListEl) return;

                const sortedHistory = [...this.state.countingHistory].sort((a,b) => (b.date?.seconds || 0) - (a.date?.seconds || 0));

                if (sortedHistory.length === 0) {
                    historyListEl.innerHTML = `<p class="text-center text-gray-500 py-8">Nenhuma contagem registrada.</p>`;
                    return;
                }

                historyListEl.innerHTML = sortedHistory.map(entry => {
                    const date = entry.date?.toDate().toLocaleString('pt-BR') || 'Data indefinida';
                    const adjustment = entry.adjustment || 0;
                    let adjColor = 'text-gray-700';
                    let adjIcon = 'fa-arrows-left-right';
                    if (adjustment > 0) { adjColor = 'text-success'; adjIcon = 'fa-arrow-up'; }
                    if (adjustment < 0) { adjColor = 'text-danger'; adjIcon = 'fa-arrow-down'; }

                    const detailsHtml = this.state.locations.map(loc => {
                        const prevQty = entry.previousQuantities?.[loc.id] || 0;
                        const countedQty = entry.countedQuantities?.[loc.id] || 0;
                        if (prevQty === 0 && countedQty === 0) return ''; // Skip if no stock and no count
                        return `<div class="flex justify-between text-xs"><span class="text-gray-600">${loc.name}:</span><span>${prevQty} &rarr; <strong>${countedQty}</strong></span></div>`;
                    }).join('');

                    return `
                        <div class="p-4 bg-gray-50 rounded-lg border">
                            <div class="flex justify-between items-start gap-4">
                                <div>
                                    <p class="font-semibold text-gray-900">${entry.productName}</p>
                                    <p class="text-xs text-gray-500">${entry.userEmail} &bull; ${date}</p>
                                </div>
                                <div class="text-right flex-shrink-0">
                                    <p class="font-bold text-lg ${adjColor}">
                                        <i class="fas ${adjIcon} mr-1"></i>${adjustment > 0 ? '+' : ''}${adjustment}
                                    </p>
                                    <p class="text-xs text-gray-500">Ajuste</p>
                                </div>
                            </div>
                            <div class="mt-3 pt-3 border-t grid grid-cols-2 gap-x-4 gap-y-1">
                                ${detailsHtml}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            getWeekNumber(d) {
                d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
                var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
                var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
                return [d.getUTCFullYear(), weekNo];
            }

            handleWeeklyComparison() {
                const startDateInput = document.getElementById('start-week-picker');
                const endDateInput = document.getElementById('end-week-picker');
                const comparisonOutput = document.getElementById('comparison-output');
                const comparisonList = document.getElementById('comparison-list');

                if (!startDateInput.value || !endDateInput.value) {
                    this.showAlert("Por favor, selecione a semana inicial e final.", true);
                    return;
                }

                const startWeek = this.getWeekNumber(new Date(startDateInput.value));
                const endWeek = this.getWeekNumber(new Date(endDateInput.value));

                const countsByProductWeek = {};
                this.state.countingHistory.forEach(count => {
                    const [year, week] = this.getWeekNumber(count.date.toDate());
                    const weekKey = `${year}-W${week}`;
                    
                    if (!countsByProductWeek[count.productId]) {
                        countsByProductWeek[count.productId] = {};
                    }
                    if (!countsByProductWeek[count.productId][weekKey]) {
                        countsByProductWeek[count.productId][weekKey] = [];
                    }
                    countsByProductWeek[count.productId][weekKey].push(count);
                });

                const comparisonResults = [];
                for (const productId in countsByProductWeek) {
                    const productCounts = countsByProductWeek[productId];
                    const startWeekKey = `${startWeek[0]}-W${startWeek[1]}`;
                    const endWeekKey = `${endWeek[0]}-W${endWeek[1]}`;

                    const startCounts = productCounts[startWeekKey] || [];
                    const endCounts = productCounts[endWeekKey] || [];

                    if (startCounts.length > 0 || endCounts.length > 0) {
                        const lastStartCount = startCounts.sort((a,b) => b.date.seconds - a.date.seconds)[0];
                        const lastEndCount = endCounts.sort((a,b) => b.date.seconds - a.date.seconds)[0];

                        const startStock = lastStartCount ? Object.values(lastStartCount.countedQuantities).reduce((a, b) => a + b, 0) : 0;
                        const endStock = lastEndCount ? Object.values(lastEndCount.countedQuantities).reduce((a, b) => a + b, 0) : 0;
                        
                        comparisonResults.push({
                            productName: this.state.products.find(p => p.id === productId)?.name || 'Produto Desconhecido',
                            startStock,
                            endStock,
                            variation: endStock - startStock,
                        });
                    }
                }
                
                if (comparisonResults.length === 0) {
                    comparisonList.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-gray-500">Nenhuma contagem encontrada para as semanas selecionadas.</td></tr>`;
                } else {
                    comparisonList.innerHTML = comparisonResults.map(res => {
                        let variationClass = 'text-gray-700';
                        if (res.variation > 0) variationClass = 'text-success';
                        if (res.variation < 0) variationClass = 'text-danger';
                        
                        return `
                            <tr class="border-b">
                                <td class="p-3 font-medium">${res.productName}</td>
                                <td class="p-3 text-center">${res.startStock}</td>
                                <td class="p-3 text-center">${res.endStock}</td>
                                <td class="p-3 text-center font-bold ${variationClass}">${res.variation > 0 ? '+' : ''}${res.variation}</td>
                            </tr>
                        `;
                    }).join('');
                }
                comparisonOutput.classList.remove('hidden');
            }
            
            async handleSaveSettings() {
                if (!this.can('manageGeneralSettings')) {
                    return this.showAlert('Você não tem permissão para salvar configurações.', true);
                }
                const itemsPerPageInput = document.getElementById('items-per-page-input');
                const itemsPerPage = parseInt(itemsPerPageInput.value, 10);
                
                if (isNaN(itemsPerPage) || itemsPerPage < 1) {
                    return this.showAlert('Itens por página deve ser um número maior que zero.', true);
                }
                
                this.setLoading(true);
                try {
                    await setDoc(this.state.firestoreRefs.settings, { itemsPerPage }, { merge: true });
                    this.state.itemsPerPage = itemsPerPage;
                    this.logAudit('SETTINGS_UPDATE', { itemsPerPage });
                    this.showAlert('Configurações salvas com sucesso!');
                    this.debouncedRenderProducts();
                } catch(error) {
                    console.error("Erro ao salvar configurações:", error);
                    this.showAlert('Falha ao salvar as configurações.', true);
                } finally {
                    this.setLoading(false);
                }
            }
            
            renderAuditLog() {
                const auditLogBody = document.getElementById('audit-log-body');
                if (!auditLogBody) return;

                const sortedLog = [...this.state.auditLog].sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                auditLogBody.innerHTML = sortedLog.map(log => {
                    const timestamp = log.timestamp?.toDate().toLocaleString('pt-BR') || 'Data inválida';
                    return `
                        <tr class="border-b border-gray-200 hover:bg-gray-50">
                            <td class="p-3 text-sm text-gray-700 whitespace-nowrap">${timestamp}</td>
                            <td class="p-3 text-sm text-gray-700">${log.userEmail}</td>
                            <td class="p-3 text-sm text-gray-900 font-medium">${log.action}</td>
                            <td class="p-3 text-sm text-gray-700">${this.formatAuditDetails(log.action, log.details)}</td>
                        </tr>
                    `;
                }).join('');
            }

            formatAuditDetails(action, details) {
                if (!details) return 'N/A';
                switch(action) {
                    case 'PRODUCT_CREATE': return `Produto '${details.productName}' criado com estoque inicial de ${details.initialStock}.`;
                    case 'PRODUCT_EDIT': return `Produto '${details.productName}': ${details.details}.`;
                    case 'PRODUCT_DELETE': return `Produto '${details.productName}' excluído.`;
                    case 'BULK_PRODUCT_DELETE': return `${details.count} produtos excluídos: ${details.productNames.join(', ')}.`;
                    case 'BULK_PRODUCT_INSERT': return `${details.count} produtos inseridos via Excel. ${details.newCategories} novas categorias.`;
                    case 'STOCK_OUTPUT': return `Saída de ${details.quantity}x '${details.productName}' de '${details.locationName}' (Motivo: ${details.motive}).`;
                    case 'STOCK_TRANSFER': return `Transferência de ${details.quantity}x '${details.productName}' de '${details.from}' para '${details.to}'.`;
                    case 'USER_ROLE_CHANGE': return `Papel de '${details.targetUserEmail}' alterado de '${details.oldRole}' para '${details.newRole}'.`;
                    case 'USER_PERMISSIONS_CHANGE': return `Permissões de '${details.targetUserEmail}' atualizadas: ${details.newPermissions.join(', ')}.`;
                    case 'STOCK_COUNT': return `Contagem de '${details.productName}'. Ajuste: ${details.adjustment}. Estoque: ${details.oldTotal} -> ${details.newTotal}.`;
                    default: return JSON.stringify(details);
                }
            }
            
            handleContentInput(e) {
                if (e.target.id === 'search-product-input') {
                    this.state.currentPage = 1;
                    this.debouncedRenderProducts();
                }
            }
        }
        
        new StockApp();
    </script>
</body>
</html>
